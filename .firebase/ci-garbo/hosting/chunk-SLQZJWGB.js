import{q as ms}from"./chunk-NFOMS6WR.js";import{A as Xh,B as Xr,Da as De,J as Zh,Ka as jn,L as td,O as hs,P as ds,R as va,T as fs,U as on,V as Ta,Y as ed,aa as Bn,ba as Zr,c as qn,da as Ft,ec as rd,f as Jh,fa as J,fc as id,ha as nd,i as ls,j as Yh,l as sn,la as ti,m as Un,n as Ce,o as xe,s as Nt,sc as Ia}from"./chunk-VTPCH2WO.js";import{a as sd,b as Ea,c as od,d as ei,e as Aa,f as gs,g as ad,h as ud,i as Sa,j as ut,k as an,l as ee,m as ps,n as ni,o as cd,p as ld,q as Ve,r as qt}from"./chunk-MDXMAHBI.js";import{a as cs,b as ya,e as wa,f as C}from"./chunk-KT3CPUTC.js";var zp="firebase",Gp="10.14.1";Ve(zp,Gp,"app");var zn=new rd("ANGULARFIRE2_VERSION");var Kp=(r,t)=>{let e=t?[t]:ld(),n=[];return e.forEach(i=>{i.container.getProvider(r).instances.forEach(a=>{n.includes(a)||n.push(a)})}),n},un=class{constructor(){return Kp($p)}},$p="app-check";function ba(){}var _s=class{zone;delegate;constructor(t,e=Yh){this.zone=t,this.delegate=e}now(){return this.delegate.now()}schedule(t,e,n){let i=this.zone,s=function(a){i.runGuarded(()=>{t.apply(this,[a])})};return this.delegate.schedule(s,e,n)}},Ra=class{zone;task=null;constructor(t){this.zone=t}call(t,e){let n=this.unscheduleTask.bind(this);return this.task=this.zone.run(()=>Zone.current.scheduleMacroTask("firebaseZoneBlock",ba,{},ba,ba)),e.pipe(ed({next:n,complete:n,error:n})).subscribe(t).add(n)}unscheduleTask(){setTimeout(()=>{this.task!=null&&this.task.state==="scheduled"&&(this.task.invoke(),this.task=null)},10)}},ys=(()=>{class r{ngZone;outsideAngular;insideAngular;constructor(e){this.ngZone=e,this.outsideAngular=e.runOutsideAngular(()=>new _s(Zone.current)),this.insideAngular=e.run(()=>new _s(Zone.current,ls)),globalThis.\u0275AngularFireScheduler||=this}static \u0275fac=function(n){return new(n||r)(J(De))};static \u0275prov=Bn({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();function Qp(){let r=globalThis.\u0275AngularFireScheduler;if(!r)throw new Error(`Either AngularFireModule has not been provided in your AppModule (this can be done manually or implictly using
provideFirebaseApp) or you're calling an AngularFire method outside of an NgModule (which is not supported).`);return r}function Ut(r){return Wp(Qp())(r)}function Wp(r){return function(e){return e=e.lift(new Ra(r.ngZone)),e.pipe(Un(r.outsideAngular),sn(r.insideAngular))}}var Hp="firebase",Jp="10.14.1";qt.registerVersion(Hp,Jp,"app-compat");var Yp=["ngOnDestroy"],fd=(r,t,e,n={})=>new Proxy(r,{get:(i,s)=>e.runOutsideAngular(()=>{if(r[s])return n?.spy?.get&&n.spy.get(s,r[s]),r[s];if(Yp.indexOf(s)>-1)return()=>{};let a=t.toPromise().then(u=>{let c=u?.[s];return typeof c=="function"?c.bind(u):c?.then?c.then(d=>e.run(()=>d)):e.run(()=>c)});return new Proxy(()=>{},{get:(u,c)=>a[c],apply:(u,c,d)=>a.then(f=>{let g=f?.(...d);return n?.spy?.apply&&n.spy.apply(s,d,g),g})})})});var ws=class{constructor(t){return t}},Gn=new Ft("angularfire2.app.options"),Kn=new Ft("angularfire2.app.name");function ri(r,t,e){let n=typeof e=="string"&&e||"[DEFAULT]",i=typeof e=="object"&&e||{};i.name=i.name||n;let a=qt.apps.filter(u=>u&&u.name===i.name)[0]||t.runOutsideAngular(()=>qt.initializeApp(r,i));try{if(JSON.stringify(r)!==JSON.stringify(a.options)){let u=!!module.hot;Xp("error",`${a.name} Firebase App already initialized with different options${u?", you may need to reload as Firebase is not HMR aware.":"."}`)}}catch{}return new ws(a)}var Xp=(r,...t)=>{Ia()&&typeof console<"u"&&console[r](...t)},Zp={provide:ws,useFactory:ri,deps:[Gn,De,[new nd,Kn]]},rv=(()=>{class r{static initializeApp(e,n){return{ngModule:r,providers:[{provide:Gn,useValue:e},{provide:Kn,useValue:n}]}}constructor(e){qt.registerVersion("angularfire",zn.full,"core"),qt.registerVersion("angularfire",zn.full,"app-compat"),qt.registerVersion("angular",id.full,e.toString())}static \u0275fac=function(n){return new(n||r)(J(jn))};static \u0275mod=ti({type:r});static \u0275inj=Zr({providers:[Zp]})}return r})();function vs(r,t,e,n,i){let[,s,a]=globalThis.\u0275AngularfireInstanceCache.find(u=>u[0]===r)||[];if(s)return t_(i,a)||(dd("error",`${t} was already initialized on the ${e} Firebase App with different settings.${e_?" You may need to reload as Firebase is not HMR aware.":""}`),dd("warn",{is:i,was:a})),s;{let u=n();return globalThis.\u0275AngularfireInstanceCache.push([r,u,i]),u}}function t_(r,t){try{return r.toString()===t.toString()}catch{return r===t}}var e_=typeof module<"u"&&!!module.hot,dd=(r,...t)=>{Ia()&&typeof console<"u"&&console[r](...t)};globalThis.\u0275AngularfireInstanceCache||=[];var i_=new Map,s_={activated:!1,tokenObservers:[]},o_={initialized:!1,enabled:!1};function Ht(r){return i_.get(r)||Object.assign({},s_)}function yd(){return o_}var a_="https://content-firebaseappcheck.googleapis.com/v1";var u_="exchangeDebugToken",md={OFFSET_DURATION:5*60*1e3,RETRIAL_MIN_WAIT:30*1e3,RETRIAL_MAX_WAIT:16*60*1e3},fv=24*60*60*1e3;var xa=class{constructor(t,e,n,i,s){if(this.operation=t,this.retryPolicy=e,this.getWaitDuration=n,this.lowerBound=i,this.upperBound=s,this.pending=null,this.nextErrorWaitInterval=i,i>s)throw new Error("Proactive refresh lower bound greater than upper bound!")}start(){this.nextErrorWaitInterval=this.lowerBound,this.process(!0).catch(()=>{})}stop(){this.pending&&(this.pending.reject("cancelled"),this.pending=null)}isRunning(){return!!this.pending}process(t){return C(this,null,function*(){this.stop();try{this.pending=new Ea,this.pending.promise.catch(e=>{}),yield c_(this.getNextRun(t)),this.pending.resolve(),yield this.pending.promise,this.pending=new Ea,this.pending.promise.catch(e=>{}),yield this.operation(),this.pending.resolve(),yield this.pending.promise,this.process(!0).catch(()=>{})}catch(e){this.retryPolicy(e)?this.process(!1).catch(()=>{}):this.stop()}})}getNextRun(t){if(t)return this.nextErrorWaitInterval=this.lowerBound,this.getWaitDuration();{let e=this.nextErrorWaitInterval;return this.nextErrorWaitInterval*=2,this.nextErrorWaitInterval>this.upperBound&&(this.nextErrorWaitInterval=this.upperBound),e}}};function c_(r){return new Promise(t=>{setTimeout(t,r)})}var l_={"already-initialized":"You have already called initializeAppCheck() for FirebaseApp {$appName} with different options. To avoid this error, call initializeAppCheck() with the same options as when it was originally called. This will return the already initialized instance.","use-before-activation":"App Check is being used before initializeAppCheck() is called for FirebaseApp {$appName}. Call initializeAppCheck() before instantiating other Firebase services.","fetch-network-error":"Fetch failed to connect to a network. Check Internet connection. Original error: {$originalErrorMessage}.","fetch-parse-error":"Fetch client could not parse response. Original error: {$originalErrorMessage}.","fetch-status-error":"Fetch server returned an HTTP error status. HTTP status: {$httpStatus}.","storage-open":"Error thrown when opening storage. Original error: {$originalErrorMessage}.","storage-get":"Error thrown when reading from storage. Original error: {$originalErrorMessage}.","storage-set":"Error thrown when writing to storage. Original error: {$originalErrorMessage}.","recaptcha-error":"ReCAPTCHA error.",throttled:"Requests throttled due to {$httpStatus} error. Attempts allowed again after {$time}"},ke=new ud("appCheck","AppCheck",l_);function wd(r){if(!Ht(r).activated)throw ke.create("use-before-activation",{appName:r.name})}function vd(n,i){return C(this,arguments,function*({url:r,body:t},e){let s={"Content-Type":"application/json"},a=e.getImmediate({optional:!0});if(a){let A=yield a.getHeartbeatsHeader();A&&(s["X-Firebase-Client"]=A)}let u={method:"POST",body:JSON.stringify(t),headers:s},c;try{c=yield fetch(r,u)}catch(A){throw ke.create("fetch-network-error",{originalErrorMessage:A?.message})}if(c.status!==200)throw ke.create("fetch-status-error",{httpStatus:c.status});let d;try{d=yield c.json()}catch(A){throw ke.create("fetch-parse-error",{originalErrorMessage:A?.message})}let f=d.ttl.match(/^([\d.]+)(s)$/);if(!f||!f[2]||isNaN(Number(f[1])))throw ke.create("fetch-parse-error",{originalErrorMessage:`ttl field (timeToLive) is not in standard Protobuf Duration format: ${d.ttl}`});let g=Number(f[1])*1e3,_=Date.now();return{token:d.token,expireTimeMillis:_+g,issuedAtTimeMillis:_}})}function Td(r,t){let{projectId:e,appId:n,apiKey:i}=r.options;return{url:`${a_}/projects/${e}/apps/${n}:${u_}?key=${i}`,body:{debug_token:t}}}var h_="firebase-app-check-database",d_=1,Da="firebase-app-check-store";var Ts=null;function f_(){return Ts||(Ts=new Promise((r,t)=>{try{let e=indexedDB.open(h_,d_);e.onsuccess=n=>{r(n.target.result)},e.onerror=n=>{var i;t(ke.create("storage-open",{originalErrorMessage:(i=n.target.error)===null||i===void 0?void 0:i.message}))},e.onupgradeneeded=n=>{let i=n.target.result;switch(n.oldVersion){case 0:i.createObjectStore(Da,{keyPath:"compositeKey"})}}}catch(e){t(ke.create("storage-open",{originalErrorMessage:e?.message}))}}),Ts)}function m_(r,t){return g_(p_(r),t)}function g_(r,t){return C(this,null,function*(){let n=(yield f_()).transaction(Da,"readwrite"),s=n.objectStore(Da).put({compositeKey:r,value:t});return new Promise((a,u)=>{s.onsuccess=c=>{a()},n.onerror=c=>{var d;u(ke.create("storage-set",{originalErrorMessage:(d=c.target.error)===null||d===void 0?void 0:d.message}))}})})}function p_(r){return`${r.options.appId}-${r.name}`}var Va=new ps("@firebase/app-check");function Ca(r,t){return gs()?m_(r,t).catch(e=>{Va.warn(`Failed to write token to IndexedDB. Error: ${e}`)}):Promise.resolve()}function Id(){return yd().enabled}function Ed(){return C(this,null,function*(){let r=yd();if(r.enabled&&r.token)return r.token.promise;throw Error(`
            Can't get debug token in production mode.
        `)})}var __={error:"UNKNOWN_ERROR"};function y_(r){return sd.encodeString(JSON.stringify(r),!1)}function ka(r,t=!1){return C(this,null,function*(){let e=r.app;wd(e);let n=Ht(e),i=n.token,s;if(i&&!ii(i)&&(n.token=void 0,i=void 0),!i){let c=yield n.cachedTokenPromise;c&&(ii(c)?i=c:yield Ca(e,void 0))}if(!t&&i&&ii(i))return{token:i.token};let a=!1;if(Id()){n.exchangeTokenPromise||(n.exchangeTokenPromise=vd(Td(e,yield Ed()),r.heartbeatServiceProvider).finally(()=>{n.exchangeTokenPromise=void 0}),a=!0);let c=yield n.exchangeTokenPromise;return yield Ca(e,c),n.token=c,{token:c.token}}try{n.exchangeTokenPromise||(n.exchangeTokenPromise=n.provider.getToken().finally(()=>{n.exchangeTokenPromise=void 0}),a=!0),i=yield Ht(e).exchangeTokenPromise}catch(c){c.code==="appCheck/throttled"?Va.warn(c.message):Va.error(c),s=c}let u;return i?s?ii(i)?u={token:i.token,internalError:s}:u=pd(s):(u={token:i.token},n.token=i,yield Ca(e,i)):u=pd(s),a&&I_(e,u),u})}function w_(r){return C(this,null,function*(){let t=r.app;wd(t);let{provider:e}=Ht(t);if(Id()){let n=yield Ed(),{token:i}=yield vd(Td(t,n),r.heartbeatServiceProvider);return{token:i}}else{let{token:n}=yield e.getToken();return{token:n}}})}function v_(r,t,e,n){let{app:i}=r,s=Ht(i),a={next:e,error:n,type:t};if(s.tokenObservers=[...s.tokenObservers,a],s.token&&ii(s.token)){let u=s.token;Promise.resolve().then(()=>{e({token:u.token}),gd(r)}).catch(()=>{})}s.cachedTokenPromise.then(()=>gd(r))}function Ad(r,t){let e=Ht(r),n=e.tokenObservers.filter(i=>i.next!==t);n.length===0&&e.tokenRefresher&&e.tokenRefresher.isRunning()&&e.tokenRefresher.stop(),e.tokenObservers=n}function gd(r){let{app:t}=r,e=Ht(t),n=e.tokenRefresher;n||(n=T_(r),e.tokenRefresher=n),!n.isRunning()&&e.isTokenAutoRefreshEnabled&&n.start()}function T_(r){let{app:t}=r;return new xa(()=>C(this,null,function*(){let e=Ht(t),n;if(e.token?n=yield ka(r,!0):n=yield ka(r),n.error)throw n.error;if(n.internalError)throw n.internalError}),()=>!0,()=>{let e=Ht(t);if(e.token){let n=e.token.issuedAtTimeMillis+(e.token.expireTimeMillis-e.token.issuedAtTimeMillis)*.5+3e5,i=e.token.expireTimeMillis-5*60*1e3;return n=Math.min(n,i),Math.max(0,n-Date.now())}else return 0},md.RETRIAL_MIN_WAIT,md.RETRIAL_MAX_WAIT)}function I_(r,t){let e=Ht(r).tokenObservers;for(let n of e)try{n.type==="EXTERNAL"&&t.error!=null?n.error(t.error):n.next(t)}catch{}}function ii(r){return r.expireTimeMillis-Date.now()>0}function pd(r){return{token:y_(__),error:r}}var Na=class{constructor(t,e){this.app=t,this.heartbeatServiceProvider=e}_delete(){let{tokenObservers:t}=Ht(this.app);for(let e of t)Ad(this.app,e.next);return Promise.resolve()}};function E_(r,t){return new Na(r,t)}function A_(r){return{getToken:t=>ka(r,t),getLimitedUseToken:()=>w_(r),addTokenListener:t=>v_(r,"INTERNAL",t),removeTokenListener:t=>Ad(r.app,t)}}var S_="@firebase/app-check",b_="0.8.8";var R_="app-check",_d="app-check-internal";function P_(){ni(new an(R_,r=>{let t=r.getProvider("app").getImmediate(),e=r.getProvider("heartbeat");return E_(t,e)},"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback((r,t,e)=>{r.getProvider(_d).initialize()})),ni(new an(_d,r=>{let t=r.getProvider("app-check").getImmediate();return A_(t)},"PUBLIC").setInstantiationMode("EXPLICIT")),Ve(S_,b_)}P_();var C_=["localhost","0.0.0.0","127.0.0.1"],Sv=typeof window<"u"&&C_.includes(window.location.hostname);var Fa=new Ft("angularfire2.auth.use-emulator"),Oa=new Ft("angularfire2.auth.settings"),Ma=new Ft("angularfire2.auth.tenant-id"),La=new Ft("angularfire2.auth.langugage-code"),qa=new Ft("angularfire2.auth.use-device-language"),Ua=new Ft("angularfire.auth.persistence"),Ba=(r,t,e,n,i,s,a,u)=>vs(`${r.name}.auth`,"AngularFireAuth",r.name,()=>{let c=t.runOutsideAngular(()=>r.auth());if(e&&c.useEmulator(...e),n&&(c.tenantId=n),c.languageCode=i,s&&c.useDeviceLanguage(),a)for(let[d,f]of Object.entries(a))c.settings[d]=f;return u&&c.setPersistence(u),c},[e,n,i,s,a,u]),bd=(()=>{class r{authState;idToken;user;idTokenResult;credential;constructor(e,n,i,s,a,u,c,d,f,g,_,A){let V=new Jh,N=xe(void 0).pipe(sn(a.outsideAngular),on(()=>s.runOutsideAngular(()=>import("./chunk-MVPI6QRS.js"))),Nt(()=>ri(e,s,n)),Nt(x=>Ba(x,s,u,d,f,g,c,_)),va({bufferSize:1,refCount:!1}));if(ms(i))this.authState=this.user=this.idToken=this.idTokenResult=this.credential=xe(null);else{N.pipe(td()).subscribe();let x=N.pipe(on(O=>O.getRedirectResult().then(G=>G,()=>null)),Ut,va({bufferSize:1,refCount:!1})),j=N.pipe(on(O=>new qn(G=>({unsubscribe:s.runOutsideAngular(()=>O.onAuthStateChanged($=>G.next($),$=>G.error($),()=>G.complete()))})))),z=N.pipe(on(O=>new qn(G=>({unsubscribe:s.runOutsideAngular(()=>O.onIdTokenChanged($=>G.next($),$=>G.error($),()=>G.complete()))}))));this.authState=x.pipe(Ta(j),Un(a.outsideAngular),sn(a.insideAngular)),this.user=x.pipe(Ta(z),Un(a.outsideAngular),sn(a.insideAngular)),this.idToken=this.user.pipe(on(O=>O?Ce(O.getIdToken()):xe(null))),this.idTokenResult=this.user.pipe(on(O=>O?Ce(O.getIdTokenResult()):xe(null))),this.credential=Xh(x,V,this.authState.pipe(Xr(O=>!O))).pipe(Nt(O=>O?.user?O:null),Un(a.outsideAngular),sn(a.insideAngular))}return fd(this,N,s,{spy:{apply:(x,j,z)=>{(x.startsWith("signIn")||x.startsWith("createUser"))&&z.then(O=>V.next(O))}}})}static \u0275fac=function(n){return new(n||r)(J(Gn),J(Kn,8),J(jn),J(De),J(ys),J(Fa,8),J(Oa,8),J(Ma,8),J(La,8),J(qa,8),J(Ua,8),J(un,8))};static \u0275prov=Bn({token:r,factory:r.\u0275fac,providedIn:"any"})}return r})();var Rd=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Pd={};var Ne,ja;(function(){var r;function t(v,p){function w(){}w.prototype=p.prototype,v.D=p.prototype,v.prototype=new w,v.prototype.constructor=v,v.C=function(T,I,S){for(var y=Array(arguments.length-2),de=2;de<arguments.length;de++)y[de-2]=arguments[de];return p.prototype[I].apply(T,y)}}function e(){this.blockSize=-1}function n(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}t(n,e),n.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function i(v,p,w){w||(w=0);var T=Array(16);if(typeof p=="string")for(var I=0;16>I;++I)T[I]=p.charCodeAt(w++)|p.charCodeAt(w++)<<8|p.charCodeAt(w++)<<16|p.charCodeAt(w++)<<24;else for(I=0;16>I;++I)T[I]=p[w++]|p[w++]<<8|p[w++]<<16|p[w++]<<24;p=v.g[0],w=v.g[1],I=v.g[2];var S=v.g[3],y=p+(S^w&(I^S))+T[0]+3614090360&4294967295;p=w+(y<<7&4294967295|y>>>25),y=S+(I^p&(w^I))+T[1]+3905402710&4294967295,S=p+(y<<12&4294967295|y>>>20),y=I+(w^S&(p^w))+T[2]+606105819&4294967295,I=S+(y<<17&4294967295|y>>>15),y=w+(p^I&(S^p))+T[3]+3250441966&4294967295,w=I+(y<<22&4294967295|y>>>10),y=p+(S^w&(I^S))+T[4]+4118548399&4294967295,p=w+(y<<7&4294967295|y>>>25),y=S+(I^p&(w^I))+T[5]+1200080426&4294967295,S=p+(y<<12&4294967295|y>>>20),y=I+(w^S&(p^w))+T[6]+2821735955&4294967295,I=S+(y<<17&4294967295|y>>>15),y=w+(p^I&(S^p))+T[7]+4249261313&4294967295,w=I+(y<<22&4294967295|y>>>10),y=p+(S^w&(I^S))+T[8]+1770035416&4294967295,p=w+(y<<7&4294967295|y>>>25),y=S+(I^p&(w^I))+T[9]+2336552879&4294967295,S=p+(y<<12&4294967295|y>>>20),y=I+(w^S&(p^w))+T[10]+4294925233&4294967295,I=S+(y<<17&4294967295|y>>>15),y=w+(p^I&(S^p))+T[11]+2304563134&4294967295,w=I+(y<<22&4294967295|y>>>10),y=p+(S^w&(I^S))+T[12]+1804603682&4294967295,p=w+(y<<7&4294967295|y>>>25),y=S+(I^p&(w^I))+T[13]+4254626195&4294967295,S=p+(y<<12&4294967295|y>>>20),y=I+(w^S&(p^w))+T[14]+2792965006&4294967295,I=S+(y<<17&4294967295|y>>>15),y=w+(p^I&(S^p))+T[15]+1236535329&4294967295,w=I+(y<<22&4294967295|y>>>10),y=p+(I^S&(w^I))+T[1]+4129170786&4294967295,p=w+(y<<5&4294967295|y>>>27),y=S+(w^I&(p^w))+T[6]+3225465664&4294967295,S=p+(y<<9&4294967295|y>>>23),y=I+(p^w&(S^p))+T[11]+643717713&4294967295,I=S+(y<<14&4294967295|y>>>18),y=w+(S^p&(I^S))+T[0]+3921069994&4294967295,w=I+(y<<20&4294967295|y>>>12),y=p+(I^S&(w^I))+T[5]+3593408605&4294967295,p=w+(y<<5&4294967295|y>>>27),y=S+(w^I&(p^w))+T[10]+38016083&4294967295,S=p+(y<<9&4294967295|y>>>23),y=I+(p^w&(S^p))+T[15]+3634488961&4294967295,I=S+(y<<14&4294967295|y>>>18),y=w+(S^p&(I^S))+T[4]+3889429448&4294967295,w=I+(y<<20&4294967295|y>>>12),y=p+(I^S&(w^I))+T[9]+568446438&4294967295,p=w+(y<<5&4294967295|y>>>27),y=S+(w^I&(p^w))+T[14]+3275163606&4294967295,S=p+(y<<9&4294967295|y>>>23),y=I+(p^w&(S^p))+T[3]+4107603335&4294967295,I=S+(y<<14&4294967295|y>>>18),y=w+(S^p&(I^S))+T[8]+1163531501&4294967295,w=I+(y<<20&4294967295|y>>>12),y=p+(I^S&(w^I))+T[13]+2850285829&4294967295,p=w+(y<<5&4294967295|y>>>27),y=S+(w^I&(p^w))+T[2]+4243563512&4294967295,S=p+(y<<9&4294967295|y>>>23),y=I+(p^w&(S^p))+T[7]+1735328473&4294967295,I=S+(y<<14&4294967295|y>>>18),y=w+(S^p&(I^S))+T[12]+2368359562&4294967295,w=I+(y<<20&4294967295|y>>>12),y=p+(w^I^S)+T[5]+4294588738&4294967295,p=w+(y<<4&4294967295|y>>>28),y=S+(p^w^I)+T[8]+2272392833&4294967295,S=p+(y<<11&4294967295|y>>>21),y=I+(S^p^w)+T[11]+1839030562&4294967295,I=S+(y<<16&4294967295|y>>>16),y=w+(I^S^p)+T[14]+4259657740&4294967295,w=I+(y<<23&4294967295|y>>>9),y=p+(w^I^S)+T[1]+2763975236&4294967295,p=w+(y<<4&4294967295|y>>>28),y=S+(p^w^I)+T[4]+1272893353&4294967295,S=p+(y<<11&4294967295|y>>>21),y=I+(S^p^w)+T[7]+4139469664&4294967295,I=S+(y<<16&4294967295|y>>>16),y=w+(I^S^p)+T[10]+3200236656&4294967295,w=I+(y<<23&4294967295|y>>>9),y=p+(w^I^S)+T[13]+681279174&4294967295,p=w+(y<<4&4294967295|y>>>28),y=S+(p^w^I)+T[0]+3936430074&4294967295,S=p+(y<<11&4294967295|y>>>21),y=I+(S^p^w)+T[3]+3572445317&4294967295,I=S+(y<<16&4294967295|y>>>16),y=w+(I^S^p)+T[6]+76029189&4294967295,w=I+(y<<23&4294967295|y>>>9),y=p+(w^I^S)+T[9]+3654602809&4294967295,p=w+(y<<4&4294967295|y>>>28),y=S+(p^w^I)+T[12]+3873151461&4294967295,S=p+(y<<11&4294967295|y>>>21),y=I+(S^p^w)+T[15]+530742520&4294967295,I=S+(y<<16&4294967295|y>>>16),y=w+(I^S^p)+T[2]+3299628645&4294967295,w=I+(y<<23&4294967295|y>>>9),y=p+(I^(w|~S))+T[0]+4096336452&4294967295,p=w+(y<<6&4294967295|y>>>26),y=S+(w^(p|~I))+T[7]+1126891415&4294967295,S=p+(y<<10&4294967295|y>>>22),y=I+(p^(S|~w))+T[14]+2878612391&4294967295,I=S+(y<<15&4294967295|y>>>17),y=w+(S^(I|~p))+T[5]+4237533241&4294967295,w=I+(y<<21&4294967295|y>>>11),y=p+(I^(w|~S))+T[12]+1700485571&4294967295,p=w+(y<<6&4294967295|y>>>26),y=S+(w^(p|~I))+T[3]+2399980690&4294967295,S=p+(y<<10&4294967295|y>>>22),y=I+(p^(S|~w))+T[10]+4293915773&4294967295,I=S+(y<<15&4294967295|y>>>17),y=w+(S^(I|~p))+T[1]+2240044497&4294967295,w=I+(y<<21&4294967295|y>>>11),y=p+(I^(w|~S))+T[8]+1873313359&4294967295,p=w+(y<<6&4294967295|y>>>26),y=S+(w^(p|~I))+T[15]+4264355552&4294967295,S=p+(y<<10&4294967295|y>>>22),y=I+(p^(S|~w))+T[6]+2734768916&4294967295,I=S+(y<<15&4294967295|y>>>17),y=w+(S^(I|~p))+T[13]+1309151649&4294967295,w=I+(y<<21&4294967295|y>>>11),y=p+(I^(w|~S))+T[4]+4149444226&4294967295,p=w+(y<<6&4294967295|y>>>26),y=S+(w^(p|~I))+T[11]+3174756917&4294967295,S=p+(y<<10&4294967295|y>>>22),y=I+(p^(S|~w))+T[2]+718787259&4294967295,I=S+(y<<15&4294967295|y>>>17),y=w+(S^(I|~p))+T[9]+3951481745&4294967295,v.g[0]=v.g[0]+p&4294967295,v.g[1]=v.g[1]+(I+(y<<21&4294967295|y>>>11))&4294967295,v.g[2]=v.g[2]+I&4294967295,v.g[3]=v.g[3]+S&4294967295}n.prototype.u=function(v,p){p===void 0&&(p=v.length);for(var w=p-this.blockSize,T=this.B,I=this.h,S=0;S<p;){if(I==0)for(;S<=w;)i(this,v,S),S+=this.blockSize;if(typeof v=="string"){for(;S<p;)if(T[I++]=v.charCodeAt(S++),I==this.blockSize){i(this,T),I=0;break}}else for(;S<p;)if(T[I++]=v[S++],I==this.blockSize){i(this,T),I=0;break}}this.h=I,this.o+=p},n.prototype.v=function(){var v=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);v[0]=128;for(var p=1;p<v.length-8;++p)v[p]=0;var w=8*this.o;for(p=v.length-8;p<v.length;++p)v[p]=w&255,w/=256;for(this.u(v),v=Array(16),p=w=0;4>p;++p)for(var T=0;32>T;T+=8)v[w++]=this.g[p]>>>T&255;return v};function s(v,p){var w=u;return Object.prototype.hasOwnProperty.call(w,v)?w[v]:w[v]=p(v)}function a(v,p){this.h=p;for(var w=[],T=!0,I=v.length-1;0<=I;I--){var S=v[I]|0;T&&S==p||(w[I]=S,T=!1)}this.g=w}var u={};function c(v){return-128<=v&&128>v?s(v,function(p){return new a([p|0],0>p?-1:0)}):new a([v|0],0>v?-1:0)}function d(v){if(isNaN(v)||!isFinite(v))return g;if(0>v)return x(d(-v));for(var p=[],w=1,T=0;v>=w;T++)p[T]=v/w|0,w*=4294967296;return new a(p,0)}function f(v,p){if(v.length==0)throw Error("number format error: empty string");if(p=p||10,2>p||36<p)throw Error("radix out of range: "+p);if(v.charAt(0)=="-")return x(f(v.substring(1),p));if(0<=v.indexOf("-"))throw Error('number format error: interior "-" character');for(var w=d(Math.pow(p,8)),T=g,I=0;I<v.length;I+=8){var S=Math.min(8,v.length-I),y=parseInt(v.substring(I,I+S),p);8>S?(S=d(Math.pow(p,S)),T=T.j(S).add(d(y))):(T=T.j(w),T=T.add(d(y)))}return T}var g=c(0),_=c(1),A=c(16777216);r=a.prototype,r.m=function(){if(N(this))return-x(this).m();for(var v=0,p=1,w=0;w<this.g.length;w++){var T=this.i(w);v+=(0<=T?T:4294967296+T)*p,p*=4294967296}return v},r.toString=function(v){if(v=v||10,2>v||36<v)throw Error("radix out of range: "+v);if(V(this))return"0";if(N(this))return"-"+x(this).toString(v);for(var p=d(Math.pow(v,6)),w=this,T="";;){var I=G(w,p).g;w=j(w,I.j(p));var S=((0<w.g.length?w.g[0]:w.h)>>>0).toString(v);if(w=I,V(w))return S+T;for(;6>S.length;)S="0"+S;T=S+T}},r.i=function(v){return 0>v?0:v<this.g.length?this.g[v]:this.h};function V(v){if(v.h!=0)return!1;for(var p=0;p<v.g.length;p++)if(v.g[p]!=0)return!1;return!0}function N(v){return v.h==-1}r.l=function(v){return v=j(this,v),N(v)?-1:V(v)?0:1};function x(v){for(var p=v.g.length,w=[],T=0;T<p;T++)w[T]=~v.g[T];return new a(w,~v.h).add(_)}r.abs=function(){return N(this)?x(this):this},r.add=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],T=0,I=0;I<=p;I++){var S=T+(this.i(I)&65535)+(v.i(I)&65535),y=(S>>>16)+(this.i(I)>>>16)+(v.i(I)>>>16);T=y>>>16,S&=65535,y&=65535,w[I]=y<<16|S}return new a(w,w[w.length-1]&-2147483648?-1:0)};function j(v,p){return v.add(x(p))}r.j=function(v){if(V(this)||V(v))return g;if(N(this))return N(v)?x(this).j(x(v)):x(x(this).j(v));if(N(v))return x(this.j(x(v)));if(0>this.l(A)&&0>v.l(A))return d(this.m()*v.m());for(var p=this.g.length+v.g.length,w=[],T=0;T<2*p;T++)w[T]=0;for(T=0;T<this.g.length;T++)for(var I=0;I<v.g.length;I++){var S=this.i(T)>>>16,y=this.i(T)&65535,de=v.i(I)>>>16,kr=v.i(I)&65535;w[2*T+2*I]+=y*kr,z(w,2*T+2*I),w[2*T+2*I+1]+=S*kr,z(w,2*T+2*I+1),w[2*T+2*I+1]+=y*de,z(w,2*T+2*I+1),w[2*T+2*I+2]+=S*de,z(w,2*T+2*I+2)}for(T=0;T<p;T++)w[T]=w[2*T+1]<<16|w[2*T];for(T=p;T<2*p;T++)w[T]=0;return new a(w,0)};function z(v,p){for(;(v[p]&65535)!=v[p];)v[p+1]+=v[p]>>>16,v[p]&=65535,p++}function O(v,p){this.g=v,this.h=p}function G(v,p){if(V(p))throw Error("division by zero");if(V(v))return new O(g,g);if(N(v))return p=G(x(v),p),new O(x(p.g),x(p.h));if(N(p))return p=G(v,x(p)),new O(x(p.g),p.h);if(30<v.g.length){if(N(v)||N(p))throw Error("slowDivide_ only works with positive integers.");for(var w=_,T=p;0>=T.l(v);)w=$(w),T=$(T);var I=Q(w,1),S=Q(T,1);for(T=Q(T,2),w=Q(w,2);!V(T);){var y=S.add(T);0>=y.l(v)&&(I=I.add(w),S=y),T=Q(T,1),w=Q(w,1)}return p=j(v,I.j(p)),new O(I,p)}for(I=g;0<=v.l(p);){for(w=Math.max(1,Math.floor(v.m()/p.m())),T=Math.ceil(Math.log(w)/Math.LN2),T=48>=T?1:Math.pow(2,T-48),S=d(w),y=S.j(p);N(y)||0<y.l(v);)w-=T,S=d(w),y=S.j(p);V(S)&&(S=_),I=I.add(S),v=j(v,y)}return new O(I,v)}r.A=function(v){return G(this,v).h},r.and=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],T=0;T<p;T++)w[T]=this.i(T)&v.i(T);return new a(w,this.h&v.h)},r.or=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],T=0;T<p;T++)w[T]=this.i(T)|v.i(T);return new a(w,this.h|v.h)},r.xor=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],T=0;T<p;T++)w[T]=this.i(T)^v.i(T);return new a(w,this.h^v.h)};function $(v){for(var p=v.g.length+1,w=[],T=0;T<p;T++)w[T]=v.i(T)<<1|v.i(T-1)>>>31;return new a(w,v.h)}function Q(v,p){var w=p>>5;p%=32;for(var T=v.g.length-w,I=[],S=0;S<T;S++)I[S]=0<p?v.i(S+w)>>>p|v.i(S+w+1)<<32-p:v.i(S+w);return new a(I,v.h)}n.prototype.digest=n.prototype.v,n.prototype.reset=n.prototype.s,n.prototype.update=n.prototype.u,ja=Pd.Md5=n,a.prototype.add=a.prototype.add,a.prototype.multiply=a.prototype.j,a.prototype.modulo=a.prototype.A,a.prototype.compare=a.prototype.l,a.prototype.toNumber=a.prototype.m,a.prototype.toString=a.prototype.toString,a.prototype.getBits=a.prototype.i,a.fromNumber=d,a.fromString=f,Ne=Pd.Integer=a}).apply(typeof Rd<"u"?Rd:typeof self<"u"?self:typeof window<"u"?window:{});var Is=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},ge={};var za,D_,$n,Ga,si,Es,Ka,$a,Qa;(function(){var r,t=typeof Object.defineProperties=="function"?Object.defineProperty:function(o,l,h){return o==Array.prototype||o==Object.prototype||(o[l]=h.value),o};function e(o){o=[typeof globalThis=="object"&&globalThis,o,typeof window=="object"&&window,typeof self=="object"&&self,typeof Is=="object"&&Is];for(var l=0;l<o.length;++l){var h=o[l];if(h&&h.Math==Math)return h}throw Error("Cannot find global object")}var n=e(this);function i(o,l){if(l)t:{var h=n;o=o.split(".");for(var m=0;m<o.length-1;m++){var E=o[m];if(!(E in h))break t;h=h[E]}o=o[o.length-1],m=h[o],l=l(m),l!=m&&l!=null&&t(h,o,{configurable:!0,writable:!0,value:l})}}function s(o,l){o instanceof String&&(o+="");var h=0,m=!1,E={next:function(){if(!m&&h<o.length){var R=h++;return{value:l(R,o[R]),done:!1}}return m=!0,{done:!0,value:void 0}}};return E[Symbol.iterator]=function(){return E},E}i("Array.prototype.values",function(o){return o||function(){return s(this,function(l,h){return h})}});var a=a||{},u=this||self;function c(o){var l=typeof o;return l=l!="object"?l:o?Array.isArray(o)?"array":l:"null",l=="array"||l=="object"&&typeof o.length=="number"}function d(o){var l=typeof o;return l=="object"&&o!=null||l=="function"}function f(o,l,h){return o.call.apply(o.bind,arguments)}function g(o,l,h){if(!o)throw Error();if(2<arguments.length){var m=Array.prototype.slice.call(arguments,2);return function(){var E=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(E,m),o.apply(l,E)}}return function(){return o.apply(l,arguments)}}function _(o,l,h){return _=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?f:g,_.apply(null,arguments)}function A(o,l){var h=Array.prototype.slice.call(arguments,1);return function(){var m=h.slice();return m.push.apply(m,arguments),o.apply(this,m)}}function V(o,l){function h(){}h.prototype=l.prototype,o.aa=l.prototype,o.prototype=new h,o.prototype.constructor=o,o.Qb=function(m,E,R){for(var F=Array(arguments.length-2),nt=2;nt<arguments.length;nt++)F[nt-2]=arguments[nt];return l.prototype[E].apply(m,F)}}function N(o){let l=o.length;if(0<l){let h=Array(l);for(let m=0;m<l;m++)h[m]=o[m];return h}return[]}function x(o,l){for(let h=1;h<arguments.length;h++){let m=arguments[h];if(c(m)){let E=o.length||0,R=m.length||0;o.length=E+R;for(let F=0;F<R;F++)o[E+F]=m[F]}else o.push(m)}}class j{constructor(l,h){this.i=l,this.j=h,this.h=0,this.g=null}get(){let l;return 0<this.h?(this.h--,l=this.g,this.g=l.next,l.next=null):l=this.i(),l}}function z(o){return/^[\s\xa0]*$/.test(o)}function O(){var o=u.navigator;return o&&(o=o.userAgent)?o:""}function G(o){return G[" "](o),o}G[" "]=function(){};var $=O().indexOf("Gecko")!=-1&&!(O().toLowerCase().indexOf("webkit")!=-1&&O().indexOf("Edge")==-1)&&!(O().indexOf("Trident")!=-1||O().indexOf("MSIE")!=-1)&&O().indexOf("Edge")==-1;function Q(o,l,h){for(let m in o)l.call(h,o[m],m,o)}function v(o,l){for(let h in o)l.call(void 0,o[h],h,o)}function p(o){let l={};for(let h in o)l[h]=o[h];return l}let w="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function T(o,l){let h,m;for(let E=1;E<arguments.length;E++){m=arguments[E];for(h in m)o[h]=m[h];for(let R=0;R<w.length;R++)h=w[R],Object.prototype.hasOwnProperty.call(m,h)&&(o[h]=m[h])}}function I(o){var l=1;o=o.split(":");let h=[];for(;0<l&&o.length;)h.push(o.shift()),l--;return o.length&&h.push(o.join(":")),h}function S(o){u.setTimeout(()=>{throw o},0)}function y(){var o=Qo;let l=null;return o.g&&(l=o.g,o.g=o.g.next,o.g||(o.h=null),l.next=null),l}class de{constructor(){this.h=this.g=null}add(l,h){let m=kr.get();m.set(l,h),this.h?this.h.next=m:this.g=m,this.h=m}}var kr=new j(()=>new cp,o=>o.reset());class cp{constructor(){this.next=this.g=this.h=null}set(l,h){this.h=l,this.g=h,this.next=null}reset(){this.next=this.g=this.h=null}}let Nr,Fr=!1,Qo=new de,Hl=()=>{let o=u.Promise.resolve(void 0);Nr=()=>{o.then(lp)}};var lp=()=>{for(var o;o=y();){try{o.h.call(o.g)}catch(h){S(h)}var l=kr;l.j(o),100>l.h&&(l.h++,o.next=l.g,l.g=o)}Fr=!1};function Se(){this.s=this.s,this.C=this.C}Se.prototype.s=!1,Se.prototype.ma=function(){this.s||(this.s=!0,this.N())},Se.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function bt(o,l){this.type=o,this.g=this.target=l,this.defaultPrevented=!1}bt.prototype.h=function(){this.defaultPrevented=!0};var hp=function(){if(!u.addEventListener||!Object.defineProperty)return!1;var o=!1,l=Object.defineProperty({},"passive",{get:function(){o=!0}});try{let h=()=>{};u.addEventListener("test",h,l),u.removeEventListener("test",h,l)}catch{}return o}();function Or(o,l){if(bt.call(this,o?o.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,o){var h=this.type=o.type,m=o.changedTouches&&o.changedTouches.length?o.changedTouches[0]:null;if(this.target=o.target||o.srcElement,this.g=l,l=o.relatedTarget){if($){t:{try{G(l.nodeName);var E=!0;break t}catch{}E=!1}E||(l=null)}}else h=="mouseover"?l=o.fromElement:h=="mouseout"&&(l=o.toElement);this.relatedTarget=l,m?(this.clientX=m.clientX!==void 0?m.clientX:m.pageX,this.clientY=m.clientY!==void 0?m.clientY:m.pageY,this.screenX=m.screenX||0,this.screenY=m.screenY||0):(this.clientX=o.clientX!==void 0?o.clientX:o.pageX,this.clientY=o.clientY!==void 0?o.clientY:o.pageY,this.screenX=o.screenX||0,this.screenY=o.screenY||0),this.button=o.button,this.key=o.key||"",this.ctrlKey=o.ctrlKey,this.altKey=o.altKey,this.shiftKey=o.shiftKey,this.metaKey=o.metaKey,this.pointerId=o.pointerId||0,this.pointerType=typeof o.pointerType=="string"?o.pointerType:dp[o.pointerType]||"",this.state=o.state,this.i=o,o.defaultPrevented&&Or.aa.h.call(this)}}V(Or,bt);var dp={2:"touch",3:"pen",4:"mouse"};Or.prototype.h=function(){Or.aa.h.call(this);var o=this.i;o.preventDefault?o.preventDefault():o.returnValue=!1};var Mr="closure_listenable_"+(1e6*Math.random()|0),fp=0;function mp(o,l,h,m,E){this.listener=o,this.proxy=null,this.src=l,this.type=h,this.capture=!!m,this.ha=E,this.key=++fp,this.da=this.fa=!1}function $i(o){o.da=!0,o.listener=null,o.proxy=null,o.src=null,o.ha=null}function Qi(o){this.src=o,this.g={},this.h=0}Qi.prototype.add=function(o,l,h,m,E){var R=o.toString();o=this.g[R],o||(o=this.g[R]=[],this.h++);var F=Ho(o,l,m,E);return-1<F?(l=o[F],h||(l.fa=!1)):(l=new mp(l,this.src,R,!!m,E),l.fa=h,o.push(l)),l};function Wo(o,l){var h=l.type;if(h in o.g){var m=o.g[h],E=Array.prototype.indexOf.call(m,l,void 0),R;(R=0<=E)&&Array.prototype.splice.call(m,E,1),R&&($i(l),o.g[h].length==0&&(delete o.g[h],o.h--))}}function Ho(o,l,h,m){for(var E=0;E<o.length;++E){var R=o[E];if(!R.da&&R.listener==l&&R.capture==!!h&&R.ha==m)return E}return-1}var Jo="closure_lm_"+(1e6*Math.random()|0),Yo={};function Jl(o,l,h,m,E){if(m&&m.once)return Xl(o,l,h,m,E);if(Array.isArray(l)){for(var R=0;R<l.length;R++)Jl(o,l[R],h,m,E);return null}return h=ea(h),o&&o[Mr]?o.K(l,h,d(m)?!!m.capture:!!m,E):Yl(o,l,h,!1,m,E)}function Yl(o,l,h,m,E,R){if(!l)throw Error("Invalid event type");var F=d(E)?!!E.capture:!!E,nt=Zo(o);if(nt||(o[Jo]=nt=new Qi(o)),h=nt.add(l,h,m,F,R),h.proxy)return h;if(m=gp(),h.proxy=m,m.src=o,m.listener=h,o.addEventListener)hp||(E=F),E===void 0&&(E=!1),o.addEventListener(l.toString(),m,E);else if(o.attachEvent)o.attachEvent(th(l.toString()),m);else if(o.addListener&&o.removeListener)o.addListener(m);else throw Error("addEventListener and attachEvent are unavailable.");return h}function gp(){function o(h){return l.call(o.src,o.listener,h)}let l=pp;return o}function Xl(o,l,h,m,E){if(Array.isArray(l)){for(var R=0;R<l.length;R++)Xl(o,l[R],h,m,E);return null}return h=ea(h),o&&o[Mr]?o.L(l,h,d(m)?!!m.capture:!!m,E):Yl(o,l,h,!0,m,E)}function Zl(o,l,h,m,E){if(Array.isArray(l))for(var R=0;R<l.length;R++)Zl(o,l[R],h,m,E);else m=d(m)?!!m.capture:!!m,h=ea(h),o&&o[Mr]?(o=o.i,l=String(l).toString(),l in o.g&&(R=o.g[l],h=Ho(R,h,m,E),-1<h&&($i(R[h]),Array.prototype.splice.call(R,h,1),R.length==0&&(delete o.g[l],o.h--)))):o&&(o=Zo(o))&&(l=o.g[l.toString()],o=-1,l&&(o=Ho(l,h,m,E)),(h=-1<o?l[o]:null)&&Xo(h))}function Xo(o){if(typeof o!="number"&&o&&!o.da){var l=o.src;if(l&&l[Mr])Wo(l.i,o);else{var h=o.type,m=o.proxy;l.removeEventListener?l.removeEventListener(h,m,o.capture):l.detachEvent?l.detachEvent(th(h),m):l.addListener&&l.removeListener&&l.removeListener(m),(h=Zo(l))?(Wo(h,o),h.h==0&&(h.src=null,l[Jo]=null)):$i(o)}}}function th(o){return o in Yo?Yo[o]:Yo[o]="on"+o}function pp(o,l){if(o.da)o=!0;else{l=new Or(l,this);var h=o.listener,m=o.ha||o.src;o.fa&&Xo(o),o=h.call(m,l)}return o}function Zo(o){return o=o[Jo],o instanceof Qi?o:null}var ta="__closure_events_fn_"+(1e9*Math.random()>>>0);function ea(o){return typeof o=="function"?o:(o[ta]||(o[ta]=function(l){return o.handleEvent(l)}),o[ta])}function Rt(){Se.call(this),this.i=new Qi(this),this.M=this,this.F=null}V(Rt,Se),Rt.prototype[Mr]=!0,Rt.prototype.removeEventListener=function(o,l,h,m){Zl(this,o,l,h,m)};function Vt(o,l){var h,m=o.F;if(m)for(h=[];m;m=m.F)h.push(m);if(o=o.M,m=l.type||l,typeof l=="string")l=new bt(l,o);else if(l instanceof bt)l.target=l.target||o;else{var E=l;l=new bt(m,o),T(l,E)}if(E=!0,h)for(var R=h.length-1;0<=R;R--){var F=l.g=h[R];E=Wi(F,m,!0,l)&&E}if(F=l.g=o,E=Wi(F,m,!0,l)&&E,E=Wi(F,m,!1,l)&&E,h)for(R=0;R<h.length;R++)F=l.g=h[R],E=Wi(F,m,!1,l)&&E}Rt.prototype.N=function(){if(Rt.aa.N.call(this),this.i){var o=this.i,l;for(l in o.g){for(var h=o.g[l],m=0;m<h.length;m++)$i(h[m]);delete o.g[l],o.h--}}this.F=null},Rt.prototype.K=function(o,l,h,m){return this.i.add(String(o),l,!1,h,m)},Rt.prototype.L=function(o,l,h,m){return this.i.add(String(o),l,!0,h,m)};function Wi(o,l,h,m){if(l=o.i.g[String(l)],!l)return!0;l=l.concat();for(var E=!0,R=0;R<l.length;++R){var F=l[R];if(F&&!F.da&&F.capture==h){var nt=F.listener,Et=F.ha||F.src;F.fa&&Wo(o.i,F),E=nt.call(Et,m)!==!1&&E}}return E&&!m.defaultPrevented}function eh(o,l,h){if(typeof o=="function")h&&(o=_(o,h));else if(o&&typeof o.handleEvent=="function")o=_(o.handleEvent,o);else throw Error("Invalid listener argument");return 2147483647<Number(l)?-1:u.setTimeout(o,l||0)}function nh(o){o.g=eh(()=>{o.g=null,o.i&&(o.i=!1,nh(o))},o.l);let l=o.h;o.h=null,o.m.apply(null,l)}class _p extends Se{constructor(l,h){super(),this.m=l,this.l=h,this.h=null,this.i=!1,this.g=null}j(l){this.h=arguments,this.g?this.i=!0:nh(this)}N(){super.N(),this.g&&(u.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Lr(o){Se.call(this),this.h=o,this.g={}}V(Lr,Se);var rh=[];function ih(o){Q(o.g,function(l,h){this.g.hasOwnProperty(h)&&Xo(l)},o),o.g={}}Lr.prototype.N=function(){Lr.aa.N.call(this),ih(this)},Lr.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var na=u.JSON.stringify,yp=u.JSON.parse,wp=class{stringify(o){return u.JSON.stringify(o,void 0)}parse(o){return u.JSON.parse(o,void 0)}};function ra(){}ra.prototype.h=null;function sh(o){return o.h||(o.h=o.i())}function oh(){}var qr={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function ia(){bt.call(this,"d")}V(ia,bt);function sa(){bt.call(this,"c")}V(sa,bt);var tn={},ah=null;function Hi(){return ah=ah||new Rt}tn.La="serverreachability";function uh(o){bt.call(this,tn.La,o)}V(uh,bt);function Ur(o){let l=Hi();Vt(l,new uh(l))}tn.STAT_EVENT="statevent";function ch(o,l){bt.call(this,tn.STAT_EVENT,o),this.stat=l}V(ch,bt);function kt(o){let l=Hi();Vt(l,new ch(l,o))}tn.Ma="timingevent";function lh(o,l){bt.call(this,tn.Ma,o),this.size=l}V(lh,bt);function Br(o,l){if(typeof o!="function")throw Error("Fn must not be null and must be a function");return u.setTimeout(function(){o()},l)}function jr(){this.g=!0}jr.prototype.xa=function(){this.g=!1};function vp(o,l,h,m,E,R){o.info(function(){if(o.g)if(R)for(var F="",nt=R.split("&"),Et=0;Et<nt.length;Et++){var tt=nt[Et].split("=");if(1<tt.length){var Pt=tt[0];tt=tt[1];var Ct=Pt.split("_");F=2<=Ct.length&&Ct[1]=="type"?F+(Pt+"="+tt+"&"):F+(Pt+"=redacted&")}}else F=null;else F=R;return"XMLHTTP REQ ("+m+") [attempt "+E+"]: "+l+`
`+h+`
`+F})}function Tp(o,l,h,m,E,R,F){o.info(function(){return"XMLHTTP RESP ("+m+") [ attempt "+E+"]: "+l+`
`+h+`
`+R+" "+F})}function Fn(o,l,h,m){o.info(function(){return"XMLHTTP TEXT ("+l+"): "+Ep(o,h)+(m?" "+m:"")})}function Ip(o,l){o.info(function(){return"TIMEOUT: "+l})}jr.prototype.info=function(){};function Ep(o,l){if(!o.g)return l;if(!l)return null;try{var h=JSON.parse(l);if(h){for(o=0;o<h.length;o++)if(Array.isArray(h[o])){var m=h[o];if(!(2>m.length)){var E=m[1];if(Array.isArray(E)&&!(1>E.length)){var R=E[0];if(R!="noop"&&R!="stop"&&R!="close")for(var F=1;F<E.length;F++)E[F]=""}}}}return na(h)}catch{return l}}var Ji={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},hh={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},oa;function Yi(){}V(Yi,ra),Yi.prototype.g=function(){return new XMLHttpRequest},Yi.prototype.i=function(){return{}},oa=new Yi;function be(o,l,h,m){this.j=o,this.i=l,this.l=h,this.R=m||1,this.U=new Lr(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new dh}function dh(){this.i=null,this.g="",this.h=!1}var fh={},aa={};function ua(o,l,h){o.L=1,o.v=es(fe(l)),o.m=h,o.P=!0,mh(o,null)}function mh(o,l){o.F=Date.now(),Xi(o),o.A=fe(o.v);var h=o.A,m=o.R;Array.isArray(m)||(m=[String(m)]),Ph(h.i,"t",m),o.C=0,h=o.j.J,o.h=new dh,o.g=$h(o.j,h?l:null,!o.m),0<o.O&&(o.M=new _p(_(o.Y,o,o.g),o.O)),l=o.U,h=o.g,m=o.ca;var E="readystatechange";Array.isArray(E)||(E&&(rh[0]=E.toString()),E=rh);for(var R=0;R<E.length;R++){var F=Jl(h,E[R],m||l.handleEvent,!1,l.h||l);if(!F)break;l.g[F.key]=F}l=o.H?p(o.H):{},o.m?(o.u||(o.u="POST"),l["Content-Type"]="application/x-www-form-urlencoded",o.g.ea(o.A,o.u,o.m,l)):(o.u="GET",o.g.ea(o.A,o.u,null,l)),Ur(),vp(o.i,o.u,o.A,o.l,o.R,o.m)}be.prototype.ca=function(o){o=o.target;let l=this.M;l&&me(o)==3?l.j():this.Y(o)},be.prototype.Y=function(o){try{if(o==this.g)t:{let Ct=me(this.g);var l=this.g.Ba();let Ln=this.g.Z();if(!(3>Ct)&&(Ct!=3||this.g&&(this.h.h||this.g.oa()||Fh(this.g)))){this.J||Ct!=4||l==7||(l==8||0>=Ln?Ur(3):Ur(2)),ca(this);var h=this.g.Z();this.X=h;e:if(gh(this)){var m=Fh(this.g);o="";var E=m.length,R=me(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){en(this),zr(this);var F="";break e}this.h.i=new u.TextDecoder}for(l=0;l<E;l++)this.h.h=!0,o+=this.h.i.decode(m[l],{stream:!(R&&l==E-1)});m.length=0,this.h.g+=o,this.C=0,F=this.h.g}else F=this.g.oa();if(this.o=h==200,Tp(this.i,this.u,this.A,this.l,this.R,Ct,h),this.o){if(this.T&&!this.K){e:{if(this.g){var nt,Et=this.g;if((nt=Et.g?Et.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!z(nt)){var tt=nt;break e}}tt=null}if(h=tt)Fn(this.i,this.l,h,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,la(this,h);else{this.o=!1,this.s=3,kt(12),en(this),zr(this);break t}}if(this.P){h=!0;let Wt;for(;!this.J&&this.C<F.length;)if(Wt=Ap(this,F),Wt==aa){Ct==4&&(this.s=4,kt(14),h=!1),Fn(this.i,this.l,null,"[Incomplete Response]");break}else if(Wt==fh){this.s=4,kt(15),Fn(this.i,this.l,F,"[Invalid Chunk]"),h=!1;break}else Fn(this.i,this.l,Wt,null),la(this,Wt);if(gh(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Ct!=4||F.length!=0||this.h.h||(this.s=1,kt(16),h=!1),this.o=this.o&&h,!h)Fn(this.i,this.l,F,"[Invalid Chunked Response]"),en(this),zr(this);else if(0<F.length&&!this.W){this.W=!0;var Pt=this.j;Pt.g==this&&Pt.ba&&!Pt.M&&(Pt.j.info("Great, no buffering proxy detected. Bytes received: "+F.length),pa(Pt),Pt.M=!0,kt(11))}}else Fn(this.i,this.l,F,null),la(this,F);Ct==4&&en(this),this.o&&!this.J&&(Ct==4?jh(this.j,this):(this.o=!1,Xi(this)))}else Bp(this.g),h==400&&0<F.indexOf("Unknown SID")?(this.s=3,kt(12)):(this.s=0,kt(13)),en(this),zr(this)}}}catch{}finally{}};function gh(o){return o.g?o.u=="GET"&&o.L!=2&&o.j.Ca:!1}function Ap(o,l){var h=o.C,m=l.indexOf(`
`,h);return m==-1?aa:(h=Number(l.substring(h,m)),isNaN(h)?fh:(m+=1,m+h>l.length?aa:(l=l.slice(m,m+h),o.C=m+h,l)))}be.prototype.cancel=function(){this.J=!0,en(this)};function Xi(o){o.S=Date.now()+o.I,ph(o,o.I)}function ph(o,l){if(o.B!=null)throw Error("WatchDog timer not null");o.B=Br(_(o.ba,o),l)}function ca(o){o.B&&(u.clearTimeout(o.B),o.B=null)}be.prototype.ba=function(){this.B=null;let o=Date.now();0<=o-this.S?(Ip(this.i,this.A),this.L!=2&&(Ur(),kt(17)),en(this),this.s=2,zr(this)):ph(this,this.S-o)};function zr(o){o.j.G==0||o.J||jh(o.j,o)}function en(o){ca(o);var l=o.M;l&&typeof l.ma=="function"&&l.ma(),o.M=null,ih(o.U),o.g&&(l=o.g,o.g=null,l.abort(),l.ma())}function la(o,l){try{var h=o.j;if(h.G!=0&&(h.g==o||ha(h.h,o))){if(!o.K&&ha(h.h,o)&&h.G==3){try{var m=h.Da.g.parse(l)}catch{m=null}if(Array.isArray(m)&&m.length==3){var E=m;if(E[0]==0){t:if(!h.u){if(h.g)if(h.g.F+3e3<o.F)os(h),is(h);else break t;ga(h),kt(18)}}else h.za=E[1],0<h.za-h.T&&37500>E[2]&&h.F&&h.v==0&&!h.C&&(h.C=Br(_(h.Za,h),6e3));if(1>=wh(h.h)&&h.ca){try{h.ca()}catch{}h.ca=void 0}}else rn(h,11)}else if((o.K||h.g==o)&&os(h),!z(l))for(E=h.Da.g.parse(l),l=0;l<E.length;l++){let tt=E[l];if(h.T=tt[0],tt=tt[1],h.G==2)if(tt[0]=="c"){h.K=tt[1],h.ia=tt[2];let Pt=tt[3];Pt!=null&&(h.la=Pt,h.j.info("VER="+h.la));let Ct=tt[4];Ct!=null&&(h.Aa=Ct,h.j.info("SVER="+h.Aa));let Ln=tt[5];Ln!=null&&typeof Ln=="number"&&0<Ln&&(m=1.5*Ln,h.L=m,h.j.info("backChannelRequestTimeoutMs_="+m)),m=h;let Wt=o.g;if(Wt){let us=Wt.g?Wt.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(us){var R=m.h;R.g||us.indexOf("spdy")==-1&&us.indexOf("quic")==-1&&us.indexOf("h2")==-1||(R.j=R.l,R.g=new Set,R.h&&(da(R,R.h),R.h=null))}if(m.D){let _a=Wt.g?Wt.g.getResponseHeader("X-HTTP-Session-Id"):null;_a&&(m.ya=_a,st(m.I,m.D,_a))}}h.G=3,h.l&&h.l.ua(),h.ba&&(h.R=Date.now()-o.F,h.j.info("Handshake RTT: "+h.R+"ms")),m=h;var F=o;if(m.qa=Kh(m,m.J?m.ia:null,m.W),F.K){vh(m.h,F);var nt=F,Et=m.L;Et&&(nt.I=Et),nt.B&&(ca(nt),Xi(nt)),m.g=F}else Uh(m);0<h.i.length&&ss(h)}else tt[0]!="stop"&&tt[0]!="close"||rn(h,7);else h.G==3&&(tt[0]=="stop"||tt[0]=="close"?tt[0]=="stop"?rn(h,7):ma(h):tt[0]!="noop"&&h.l&&h.l.ta(tt),h.v=0)}}Ur(4)}catch{}}var Sp=class{constructor(o,l){this.g=o,this.map=l}};function _h(o){this.l=o||10,u.PerformanceNavigationTiming?(o=u.performance.getEntriesByType("navigation"),o=0<o.length&&(o[0].nextHopProtocol=="hq"||o[0].nextHopProtocol=="h2")):o=!!(u.chrome&&u.chrome.loadTimes&&u.chrome.loadTimes()&&u.chrome.loadTimes().wasFetchedViaSpdy),this.j=o?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function yh(o){return o.h?!0:o.g?o.g.size>=o.j:!1}function wh(o){return o.h?1:o.g?o.g.size:0}function ha(o,l){return o.h?o.h==l:o.g?o.g.has(l):!1}function da(o,l){o.g?o.g.add(l):o.h=l}function vh(o,l){o.h&&o.h==l?o.h=null:o.g&&o.g.has(l)&&o.g.delete(l)}_h.prototype.cancel=function(){if(this.i=Th(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(let o of this.g.values())o.cancel();this.g.clear()}};function Th(o){if(o.h!=null)return o.i.concat(o.h.D);if(o.g!=null&&o.g.size!==0){let l=o.i;for(let h of o.g.values())l=l.concat(h.D);return l}return N(o.i)}function bp(o){if(o.V&&typeof o.V=="function")return o.V();if(typeof Map<"u"&&o instanceof Map||typeof Set<"u"&&o instanceof Set)return Array.from(o.values());if(typeof o=="string")return o.split("");if(c(o)){for(var l=[],h=o.length,m=0;m<h;m++)l.push(o[m]);return l}l=[],h=0;for(m in o)l[h++]=o[m];return l}function Rp(o){if(o.na&&typeof o.na=="function")return o.na();if(!o.V||typeof o.V!="function"){if(typeof Map<"u"&&o instanceof Map)return Array.from(o.keys());if(!(typeof Set<"u"&&o instanceof Set)){if(c(o)||typeof o=="string"){var l=[];o=o.length;for(var h=0;h<o;h++)l.push(h);return l}l=[],h=0;for(let m in o)l[h++]=m;return l}}}function Ih(o,l){if(o.forEach&&typeof o.forEach=="function")o.forEach(l,void 0);else if(c(o)||typeof o=="string")Array.prototype.forEach.call(o,l,void 0);else for(var h=Rp(o),m=bp(o),E=m.length,R=0;R<E;R++)l.call(void 0,m[R],h&&h[R],o)}var Eh=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Pp(o,l){if(o){o=o.split("&");for(var h=0;h<o.length;h++){var m=o[h].indexOf("="),E=null;if(0<=m){var R=o[h].substring(0,m);E=o[h].substring(m+1)}else R=o[h];l(R,E?decodeURIComponent(E.replace(/\+/g," ")):"")}}}function nn(o){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,o instanceof nn){this.h=o.h,Zi(this,o.j),this.o=o.o,this.g=o.g,ts(this,o.s),this.l=o.l;var l=o.i,h=new $r;h.i=l.i,l.g&&(h.g=new Map(l.g),h.h=l.h),Ah(this,h),this.m=o.m}else o&&(l=String(o).match(Eh))?(this.h=!1,Zi(this,l[1]||"",!0),this.o=Gr(l[2]||""),this.g=Gr(l[3]||"",!0),ts(this,l[4]),this.l=Gr(l[5]||"",!0),Ah(this,l[6]||"",!0),this.m=Gr(l[7]||"")):(this.h=!1,this.i=new $r(null,this.h))}nn.prototype.toString=function(){var o=[],l=this.j;l&&o.push(Kr(l,Sh,!0),":");var h=this.g;return(h||l=="file")&&(o.push("//"),(l=this.o)&&o.push(Kr(l,Sh,!0),"@"),o.push(encodeURIComponent(String(h)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),h=this.s,h!=null&&o.push(":",String(h))),(h=this.l)&&(this.g&&h.charAt(0)!="/"&&o.push("/"),o.push(Kr(h,h.charAt(0)=="/"?Dp:xp,!0))),(h=this.i.toString())&&o.push("?",h),(h=this.m)&&o.push("#",Kr(h,kp)),o.join("")};function fe(o){return new nn(o)}function Zi(o,l,h){o.j=h?Gr(l,!0):l,o.j&&(o.j=o.j.replace(/:$/,""))}function ts(o,l){if(l){if(l=Number(l),isNaN(l)||0>l)throw Error("Bad port number "+l);o.s=l}else o.s=null}function Ah(o,l,h){l instanceof $r?(o.i=l,Np(o.i,o.h)):(h||(l=Kr(l,Vp)),o.i=new $r(l,o.h))}function st(o,l,h){o.i.set(l,h)}function es(o){return st(o,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),o}function Gr(o,l){return o?l?decodeURI(o.replace(/%25/g,"%2525")):decodeURIComponent(o):""}function Kr(o,l,h){return typeof o=="string"?(o=encodeURI(o).replace(l,Cp),h&&(o=o.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),o):null}function Cp(o){return o=o.charCodeAt(0),"%"+(o>>4&15).toString(16)+(o&15).toString(16)}var Sh=/[#\/\?@]/g,xp=/[#\?:]/g,Dp=/[#\?]/g,Vp=/[#\?@]/g,kp=/#/g;function $r(o,l){this.h=this.g=null,this.i=o||null,this.j=!!l}function Re(o){o.g||(o.g=new Map,o.h=0,o.i&&Pp(o.i,function(l,h){o.add(decodeURIComponent(l.replace(/\+/g," ")),h)}))}r=$r.prototype,r.add=function(o,l){Re(this),this.i=null,o=On(this,o);var h=this.g.get(o);return h||this.g.set(o,h=[]),h.push(l),this.h+=1,this};function bh(o,l){Re(o),l=On(o,l),o.g.has(l)&&(o.i=null,o.h-=o.g.get(l).length,o.g.delete(l))}function Rh(o,l){return Re(o),l=On(o,l),o.g.has(l)}r.forEach=function(o,l){Re(this),this.g.forEach(function(h,m){h.forEach(function(E){o.call(l,E,m,this)},this)},this)},r.na=function(){Re(this);let o=Array.from(this.g.values()),l=Array.from(this.g.keys()),h=[];for(let m=0;m<l.length;m++){let E=o[m];for(let R=0;R<E.length;R++)h.push(l[m])}return h},r.V=function(o){Re(this);let l=[];if(typeof o=="string")Rh(this,o)&&(l=l.concat(this.g.get(On(this,o))));else{o=Array.from(this.g.values());for(let h=0;h<o.length;h++)l=l.concat(o[h])}return l},r.set=function(o,l){return Re(this),this.i=null,o=On(this,o),Rh(this,o)&&(this.h-=this.g.get(o).length),this.g.set(o,[l]),this.h+=1,this},r.get=function(o,l){return o?(o=this.V(o),0<o.length?String(o[0]):l):l};function Ph(o,l,h){bh(o,l),0<h.length&&(o.i=null,o.g.set(On(o,l),N(h)),o.h+=h.length)}r.toString=function(){if(this.i)return this.i;if(!this.g)return"";let o=[],l=Array.from(this.g.keys());for(var h=0;h<l.length;h++){var m=l[h];let R=encodeURIComponent(String(m)),F=this.V(m);for(m=0;m<F.length;m++){var E=R;F[m]!==""&&(E+="="+encodeURIComponent(String(F[m]))),o.push(E)}}return this.i=o.join("&")};function On(o,l){return l=String(l),o.j&&(l=l.toLowerCase()),l}function Np(o,l){l&&!o.j&&(Re(o),o.i=null,o.g.forEach(function(h,m){var E=m.toLowerCase();m!=E&&(bh(this,m),Ph(this,E,h))},o)),o.j=l}function Fp(o,l){let h=new jr;if(u.Image){let m=new Image;m.onload=A(Pe,h,"TestLoadImage: loaded",!0,l,m),m.onerror=A(Pe,h,"TestLoadImage: error",!1,l,m),m.onabort=A(Pe,h,"TestLoadImage: abort",!1,l,m),m.ontimeout=A(Pe,h,"TestLoadImage: timeout",!1,l,m),u.setTimeout(function(){m.ontimeout&&m.ontimeout()},1e4),m.src=o}else l(!1)}function Op(o,l){let h=new jr,m=new AbortController,E=setTimeout(()=>{m.abort(),Pe(h,"TestPingServer: timeout",!1,l)},1e4);fetch(o,{signal:m.signal}).then(R=>{clearTimeout(E),R.ok?Pe(h,"TestPingServer: ok",!0,l):Pe(h,"TestPingServer: server error",!1,l)}).catch(()=>{clearTimeout(E),Pe(h,"TestPingServer: error",!1,l)})}function Pe(o,l,h,m,E){try{E&&(E.onload=null,E.onerror=null,E.onabort=null,E.ontimeout=null),m(h)}catch{}}function Mp(){this.g=new wp}function Lp(o,l,h){let m=h||"";try{Ih(o,function(E,R){let F=E;d(E)&&(F=na(E)),l.push(m+R+"="+encodeURIComponent(F))})}catch(E){throw l.push(m+"type="+encodeURIComponent("_badmap")),E}}function Qr(o){this.l=o.Ub||null,this.j=o.eb||!1}V(Qr,ra),Qr.prototype.g=function(){return new ns(this.l,this.j)},Qr.prototype.i=function(o){return function(){return o}}({});function ns(o,l){Rt.call(this),this.D=o,this.o=l,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}V(ns,Rt),r=ns.prototype,r.open=function(o,l){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=o,this.A=l,this.readyState=1,Hr(this)},r.send=function(o){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;let l={headers:this.u,method:this.B,credentials:this.m,cache:void 0};o&&(l.body=o),(this.D||u).fetch(new Request(this.A,l)).then(this.Sa.bind(this),this.ga.bind(this))},r.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,Wr(this)),this.readyState=0},r.Sa=function(o){if(this.g&&(this.l=o,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=o.headers,this.readyState=2,Hr(this)),this.g&&(this.readyState=3,Hr(this),this.g)))if(this.responseType==="arraybuffer")o.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof u.ReadableStream<"u"&&"body"in o){if(this.j=o.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Ch(this)}else o.text().then(this.Ra.bind(this),this.ga.bind(this))};function Ch(o){o.j.read().then(o.Pa.bind(o)).catch(o.ga.bind(o))}r.Pa=function(o){if(this.g){if(this.o&&o.value)this.response.push(o.value);else if(!this.o){var l=o.value?o.value:new Uint8Array(0);(l=this.v.decode(l,{stream:!o.done}))&&(this.response=this.responseText+=l)}o.done?Wr(this):Hr(this),this.readyState==3&&Ch(this)}},r.Ra=function(o){this.g&&(this.response=this.responseText=o,Wr(this))},r.Qa=function(o){this.g&&(this.response=o,Wr(this))},r.ga=function(){this.g&&Wr(this)};function Wr(o){o.readyState=4,o.l=null,o.j=null,o.v=null,Hr(o)}r.setRequestHeader=function(o,l){this.u.append(o,l)},r.getResponseHeader=function(o){return this.h&&this.h.get(o.toLowerCase())||""},r.getAllResponseHeaders=function(){if(!this.h)return"";let o=[],l=this.h.entries();for(var h=l.next();!h.done;)h=h.value,o.push(h[0]+": "+h[1]),h=l.next();return o.join(`\r
`)};function Hr(o){o.onreadystatechange&&o.onreadystatechange.call(o)}Object.defineProperty(ns.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(o){this.m=o?"include":"same-origin"}});function xh(o){let l="";return Q(o,function(h,m){l+=m,l+=":",l+=h,l+=`\r
`}),l}function fa(o,l,h){t:{for(m in h){var m=!1;break t}m=!0}m||(h=xh(h),typeof o=="string"?h!=null&&encodeURIComponent(String(h)):st(o,l,h))}function ht(o){Rt.call(this),this.headers=new Map,this.o=o||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}V(ht,Rt);var qp=/^https?$/i,Up=["POST","PUT"];r=ht.prototype,r.Ha=function(o){this.J=o},r.ea=function(o,l,h,m){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+o);l=l?l.toUpperCase():"GET",this.D=o,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():oa.g(),this.v=this.o?sh(this.o):sh(oa),this.g.onreadystatechange=_(this.Ea,this);try{this.B=!0,this.g.open(l,String(o),!0),this.B=!1}catch(R){Dh(this,R);return}if(o=h||"",h=new Map(this.headers),m)if(Object.getPrototypeOf(m)===Object.prototype)for(var E in m)h.set(E,m[E]);else if(typeof m.keys=="function"&&typeof m.get=="function")for(let R of m.keys())h.set(R,m.get(R));else throw Error("Unknown input type for opt_headers: "+String(m));m=Array.from(h.keys()).find(R=>R.toLowerCase()=="content-type"),E=u.FormData&&o instanceof u.FormData,!(0<=Array.prototype.indexOf.call(Up,l,void 0))||m||E||h.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(let[R,F]of h)this.g.setRequestHeader(R,F);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Nh(this),this.u=!0,this.g.send(o),this.u=!1}catch(R){Dh(this,R)}};function Dh(o,l){o.h=!1,o.g&&(o.j=!0,o.g.abort(),o.j=!1),o.l=l,o.m=5,Vh(o),rs(o)}function Vh(o){o.A||(o.A=!0,Vt(o,"complete"),Vt(o,"error"))}r.abort=function(o){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=o||7,Vt(this,"complete"),Vt(this,"abort"),rs(this))},r.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),rs(this,!0)),ht.aa.N.call(this)},r.Ea=function(){this.s||(this.B||this.u||this.j?kh(this):this.bb())},r.bb=function(){kh(this)};function kh(o){if(o.h&&typeof a<"u"&&(!o.v[1]||me(o)!=4||o.Z()!=2)){if(o.u&&me(o)==4)eh(o.Ea,0,o);else if(Vt(o,"readystatechange"),me(o)==4){o.h=!1;try{let F=o.Z();t:switch(F){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var l=!0;break t;default:l=!1}var h;if(!(h=l)){var m;if(m=F===0){var E=String(o.D).match(Eh)[1]||null;!E&&u.self&&u.self.location&&(E=u.self.location.protocol.slice(0,-1)),m=!qp.test(E?E.toLowerCase():"")}h=m}if(h)Vt(o,"complete"),Vt(o,"success");else{o.m=6;try{var R=2<me(o)?o.g.statusText:""}catch{R=""}o.l=R+" ["+o.Z()+"]",Vh(o)}}finally{rs(o)}}}}function rs(o,l){if(o.g){Nh(o);let h=o.g,m=o.v[0]?()=>{}:null;o.g=null,o.v=null,l||Vt(o,"ready");try{h.onreadystatechange=m}catch{}}}function Nh(o){o.I&&(u.clearTimeout(o.I),o.I=null)}r.isActive=function(){return!!this.g};function me(o){return o.g?o.g.readyState:0}r.Z=function(){try{return 2<me(this)?this.g.status:-1}catch{return-1}},r.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},r.Oa=function(o){if(this.g){var l=this.g.responseText;return o&&l.indexOf(o)==0&&(l=l.substring(o.length)),yp(l)}};function Fh(o){try{if(!o.g)return null;if("response"in o.g)return o.g.response;switch(o.H){case"":case"text":return o.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in o.g)return o.g.mozResponseArrayBuffer}return null}catch{return null}}function Bp(o){let l={};o=(o.g&&2<=me(o)&&o.g.getAllResponseHeaders()||"").split(`\r
`);for(let m=0;m<o.length;m++){if(z(o[m]))continue;var h=I(o[m]);let E=h[0];if(h=h[1],typeof h!="string")continue;h=h.trim();let R=l[E]||[];l[E]=R,R.push(h)}v(l,function(m){return m.join(", ")})}r.Ba=function(){return this.m},r.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function Jr(o,l,h){return h&&h.internalChannelParams&&h.internalChannelParams[o]||l}function Oh(o){this.Aa=0,this.i=[],this.j=new jr,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=Jr("failFast",!1,o),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=Jr("baseRetryDelayMs",5e3,o),this.cb=Jr("retryDelaySeedMs",1e4,o),this.Wa=Jr("forwardChannelMaxRetries",2,o),this.wa=Jr("forwardChannelRequestTimeoutMs",2e4,o),this.pa=o&&o.xmlHttpFactory||void 0,this.Xa=o&&o.Tb||void 0,this.Ca=o&&o.useFetchStreams||!1,this.L=void 0,this.J=o&&o.supportsCrossDomainXhr||!1,this.K="",this.h=new _h(o&&o.concurrentRequestLimit),this.Da=new Mp,this.P=o&&o.fastHandshake||!1,this.O=o&&o.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=o&&o.Rb||!1,o&&o.xa&&this.j.xa(),o&&o.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&o&&o.detectBufferingProxy||!1,this.ja=void 0,o&&o.longPollingTimeout&&0<o.longPollingTimeout&&(this.ja=o.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}r=Oh.prototype,r.la=8,r.G=1,r.connect=function(o,l,h,m){kt(0),this.W=o,this.H=l||{},h&&m!==void 0&&(this.H.OSID=h,this.H.OAID=m),this.F=this.X,this.I=Kh(this,null,this.W),ss(this)};function ma(o){if(Mh(o),o.G==3){var l=o.U++,h=fe(o.I);if(st(h,"SID",o.K),st(h,"RID",l),st(h,"TYPE","terminate"),Yr(o,h),l=new be(o,o.j,l),l.L=2,l.v=es(fe(h)),h=!1,u.navigator&&u.navigator.sendBeacon)try{h=u.navigator.sendBeacon(l.v.toString(),"")}catch{}!h&&u.Image&&(new Image().src=l.v,h=!0),h||(l.g=$h(l.j,null),l.g.ea(l.v)),l.F=Date.now(),Xi(l)}Gh(o)}function is(o){o.g&&(pa(o),o.g.cancel(),o.g=null)}function Mh(o){is(o),o.u&&(u.clearTimeout(o.u),o.u=null),os(o),o.h.cancel(),o.s&&(typeof o.s=="number"&&u.clearTimeout(o.s),o.s=null)}function ss(o){if(!yh(o.h)&&!o.s){o.s=!0;var l=o.Ga;Nr||Hl(),Fr||(Nr(),Fr=!0),Qo.add(l,o),o.B=0}}function jp(o,l){return wh(o.h)>=o.h.j-(o.s?1:0)?!1:o.s?(o.i=l.D.concat(o.i),!0):o.G==1||o.G==2||o.B>=(o.Va?0:o.Wa)?!1:(o.s=Br(_(o.Ga,o,l),zh(o,o.B)),o.B++,!0)}r.Ga=function(o){if(this.s)if(this.s=null,this.G==1){if(!o){this.U=Math.floor(1e5*Math.random()),o=this.U++;let E=new be(this,this.j,o),R=this.o;if(this.S&&(R?(R=p(R),T(R,this.S)):R=this.S),this.m!==null||this.O||(E.H=R,R=null),this.P)t:{for(var l=0,h=0;h<this.i.length;h++){e:{var m=this.i[h];if("__data__"in m.map&&(m=m.map.__data__,typeof m=="string")){m=m.length;break e}m=void 0}if(m===void 0)break;if(l+=m,4096<l){l=h;break t}if(l===4096||h===this.i.length-1){l=h+1;break t}}l=1e3}else l=1e3;l=qh(this,E,l),h=fe(this.I),st(h,"RID",o),st(h,"CVER",22),this.D&&st(h,"X-HTTP-Session-Id",this.D),Yr(this,h),R&&(this.O?l="headers="+encodeURIComponent(String(xh(R)))+"&"+l:this.m&&fa(h,this.m,R)),da(this.h,E),this.Ua&&st(h,"TYPE","init"),this.P?(st(h,"$req",l),st(h,"SID","null"),E.T=!0,ua(E,h,null)):ua(E,h,l),this.G=2}}else this.G==3&&(o?Lh(this,o):this.i.length==0||yh(this.h)||Lh(this))};function Lh(o,l){var h;l?h=l.l:h=o.U++;let m=fe(o.I);st(m,"SID",o.K),st(m,"RID",h),st(m,"AID",o.T),Yr(o,m),o.m&&o.o&&fa(m,o.m,o.o),h=new be(o,o.j,h,o.B+1),o.m===null&&(h.H=o.o),l&&(o.i=l.D.concat(o.i)),l=qh(o,h,1e3),h.I=Math.round(.5*o.wa)+Math.round(.5*o.wa*Math.random()),da(o.h,h),ua(h,m,l)}function Yr(o,l){o.H&&Q(o.H,function(h,m){st(l,m,h)}),o.l&&Ih({},function(h,m){st(l,m,h)})}function qh(o,l,h){h=Math.min(o.i.length,h);var m=o.l?_(o.l.Na,o.l,o):null;t:{var E=o.i;let R=-1;for(;;){let F=["count="+h];R==-1?0<h?(R=E[0].g,F.push("ofs="+R)):R=0:F.push("ofs="+R);let nt=!0;for(let Et=0;Et<h;Et++){let tt=E[Et].g,Pt=E[Et].map;if(tt-=R,0>tt)R=Math.max(0,E[Et].g-100),nt=!1;else try{Lp(Pt,F,"req"+tt+"_")}catch{m&&m(Pt)}}if(nt){m=F.join("&");break t}}}return o=o.i.splice(0,h),l.D=o,m}function Uh(o){if(!o.g&&!o.u){o.Y=1;var l=o.Fa;Nr||Hl(),Fr||(Nr(),Fr=!0),Qo.add(l,o),o.v=0}}function ga(o){return o.g||o.u||3<=o.v?!1:(o.Y++,o.u=Br(_(o.Fa,o),zh(o,o.v)),o.v++,!0)}r.Fa=function(){if(this.u=null,Bh(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var o=2*this.R;this.j.info("BP detection timer enabled: "+o),this.A=Br(_(this.ab,this),o)}},r.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,kt(10),is(this),Bh(this))};function pa(o){o.A!=null&&(u.clearTimeout(o.A),o.A=null)}function Bh(o){o.g=new be(o,o.j,"rpc",o.Y),o.m===null&&(o.g.H=o.o),o.g.O=0;var l=fe(o.qa);st(l,"RID","rpc"),st(l,"SID",o.K),st(l,"AID",o.T),st(l,"CI",o.F?"0":"1"),!o.F&&o.ja&&st(l,"TO",o.ja),st(l,"TYPE","xmlhttp"),Yr(o,l),o.m&&o.o&&fa(l,o.m,o.o),o.L&&(o.g.I=o.L);var h=o.g;o=o.ia,h.L=1,h.v=es(fe(l)),h.m=null,h.P=!0,mh(h,o)}r.Za=function(){this.C!=null&&(this.C=null,is(this),ga(this),kt(19))};function os(o){o.C!=null&&(u.clearTimeout(o.C),o.C=null)}function jh(o,l){var h=null;if(o.g==l){os(o),pa(o),o.g=null;var m=2}else if(ha(o.h,l))h=l.D,vh(o.h,l),m=1;else return;if(o.G!=0){if(l.o)if(m==1){h=l.m?l.m.length:0,l=Date.now()-l.F;var E=o.B;m=Hi(),Vt(m,new lh(m,h)),ss(o)}else Uh(o);else if(E=l.s,E==3||E==0&&0<l.X||!(m==1&&jp(o,l)||m==2&&ga(o)))switch(h&&0<h.length&&(l=o.h,l.i=l.i.concat(h)),E){case 1:rn(o,5);break;case 4:rn(o,10);break;case 3:rn(o,6);break;default:rn(o,2)}}}function zh(o,l){let h=o.Ta+Math.floor(Math.random()*o.cb);return o.isActive()||(h*=2),h*l}function rn(o,l){if(o.j.info("Error code "+l),l==2){var h=_(o.fb,o),m=o.Xa;let E=!m;m=new nn(m||"//www.google.com/images/cleardot.gif"),u.location&&u.location.protocol=="http"||Zi(m,"https"),es(m),E?Fp(m.toString(),h):Op(m.toString(),h)}else kt(2);o.G=0,o.l&&o.l.sa(l),Gh(o),Mh(o)}r.fb=function(o){o?(this.j.info("Successfully pinged google.com"),kt(2)):(this.j.info("Failed to ping google.com"),kt(1))};function Gh(o){if(o.G=0,o.ka=[],o.l){let l=Th(o.h);(l.length!=0||o.i.length!=0)&&(x(o.ka,l),x(o.ka,o.i),o.h.i.length=0,N(o.i),o.i.length=0),o.l.ra()}}function Kh(o,l,h){var m=h instanceof nn?fe(h):new nn(h);if(m.g!="")l&&(m.g=l+"."+m.g),ts(m,m.s);else{var E=u.location;m=E.protocol,l=l?l+"."+E.hostname:E.hostname,E=+E.port;var R=new nn(null);m&&Zi(R,m),l&&(R.g=l),E&&ts(R,E),h&&(R.l=h),m=R}return h=o.D,l=o.ya,h&&l&&st(m,h,l),st(m,"VER",o.la),Yr(o,m),m}function $h(o,l,h){if(l&&!o.J)throw Error("Can't create secondary domain capable XhrIo object.");return l=o.Ca&&!o.pa?new ht(new Qr({eb:h})):new ht(o.pa),l.Ha(o.J),l}r.isActive=function(){return!!this.l&&this.l.isActive(this)};function Qh(){}r=Qh.prototype,r.ua=function(){},r.ta=function(){},r.sa=function(){},r.ra=function(){},r.isActive=function(){return!0},r.Na=function(){};function as(){}as.prototype.g=function(o,l){return new jt(o,l)};function jt(o,l){Rt.call(this),this.g=new Oh(l),this.l=o,this.h=l&&l.messageUrlParams||null,o=l&&l.messageHeaders||null,l&&l.clientProtocolHeaderRequired&&(o?o["X-Client-Protocol"]="webchannel":o={"X-Client-Protocol":"webchannel"}),this.g.o=o,o=l&&l.initMessageHeaders||null,l&&l.messageContentType&&(o?o["X-WebChannel-Content-Type"]=l.messageContentType:o={"X-WebChannel-Content-Type":l.messageContentType}),l&&l.va&&(o?o["X-WebChannel-Client-Profile"]=l.va:o={"X-WebChannel-Client-Profile":l.va}),this.g.S=o,(o=l&&l.Sb)&&!z(o)&&(this.g.m=o),this.v=l&&l.supportsCrossDomainXhr||!1,this.u=l&&l.sendRawJson||!1,(l=l&&l.httpSessionIdParam)&&!z(l)&&(this.g.D=l,o=this.h,o!==null&&l in o&&(o=this.h,l in o&&delete o[l])),this.j=new Mn(this)}V(jt,Rt),jt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},jt.prototype.close=function(){ma(this.g)},jt.prototype.o=function(o){var l=this.g;if(typeof o=="string"){var h={};h.__data__=o,o=h}else this.u&&(h={},h.__data__=na(o),o=h);l.i.push(new Sp(l.Ya++,o)),l.G==3&&ss(l)},jt.prototype.N=function(){this.g.l=null,delete this.j,ma(this.g),delete this.g,jt.aa.N.call(this)};function Wh(o){ia.call(this),o.__headers__&&(this.headers=o.__headers__,this.statusCode=o.__status__,delete o.__headers__,delete o.__status__);var l=o.__sm__;if(l){t:{for(let h in l){o=h;break t}o=void 0}(this.i=o)&&(o=this.i,l=l!==null&&o in l?l[o]:void 0),this.data=l}else this.data=o}V(Wh,ia);function Hh(){sa.call(this),this.status=1}V(Hh,sa);function Mn(o){this.g=o}V(Mn,Qh),Mn.prototype.ua=function(){Vt(this.g,"a")},Mn.prototype.ta=function(o){Vt(this.g,new Wh(o))},Mn.prototype.sa=function(o){Vt(this.g,new Hh)},Mn.prototype.ra=function(){Vt(this.g,"b")},as.prototype.createWebChannel=as.prototype.g,jt.prototype.send=jt.prototype.o,jt.prototype.open=jt.prototype.m,jt.prototype.close=jt.prototype.close,Qa=ge.createWebChannelTransport=function(){return new as},$a=ge.getStatEventTarget=function(){return Hi()},Ka=ge.Event=tn,Es=ge.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Ji.NO_ERROR=0,Ji.TIMEOUT=8,Ji.HTTP_ERROR=6,si=ge.ErrorCode=Ji,hh.COMPLETE="complete",Ga=ge.EventType=hh,oh.EventType=qr,qr.OPEN="a",qr.CLOSE="b",qr.ERROR="c",qr.MESSAGE="d",Rt.prototype.listen=Rt.prototype.K,$n=ge.WebChannel=oh,D_=ge.FetchXmlHttpFactory=Qr,ht.prototype.listenOnce=ht.prototype.L,ht.prototype.getLastError=ht.prototype.Ka,ht.prototype.getLastErrorCode=ht.prototype.Ba,ht.prototype.getStatus=ht.prototype.Z,ht.prototype.getResponseJson=ht.prototype.Oa,ht.prototype.getResponseText=ht.prototype.oa,ht.prototype.send=ht.prototype.ea,ht.prototype.setWithCredentials=ht.prototype.Ha,za=ge.XhrIo=ht}).apply(typeof Is<"u"?Is:typeof self<"u"?self:typeof window<"u"?window:{});var Cd="@firebase/firestore";var wt=class{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}};wt.UNAUTHENTICATED=new wt(null),wt.GOOGLE_CREDENTIALS=new wt("google-credentials-uid"),wt.FIRST_PARTY=new wt("first-party-uid"),wt.MOCK_USER=new wt("mock-user");var Er="10.14.0";var Be=new ps("@firebase/firestore");function Yn(){return Be.logLevel}function kf(r){Be.setLogLevel(r)}function k(r,...t){if(Be.logLevel<=ee.DEBUG){let e=t.map(Xc);Be.debug(`Firestore (${Er}): ${r}`,...e)}}function ft(r,...t){if(Be.logLevel<=ee.ERROR){let e=t.map(Xc);Be.error(`Firestore (${Er}): ${r}`,...e)}}function Jt(r,...t){if(Be.logLevel<=ee.WARN){let e=t.map(Xc);Be.warn(`Firestore (${Er}): ${r}`,...e)}}function Xc(r){if(typeof r=="string")return r;try{return function(e){return JSON.stringify(e)}(r)}catch{return r}}function q(r="Unexpected state"){let t=`FIRESTORE (${Er}) INTERNAL ASSERTION FAILED: `+r;throw ft(t),new Error(t)}function U(r,t){r||q()}function Nf(r,t){r||q()}function M(r,t){return r}var P={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},D=class extends ad{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};var Tt=class{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}};var ks=class{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}},Za=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(wt.UNAUTHENTICATED))}shutdown(){}},tu=class{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}},eu=class{constructor(t){this.t=t,this.currentUser=wt.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){U(this.o===void 0);let n=this.i,i=c=>this.i!==n?(n=this.i,e(c)):Promise.resolve(),s=new Tt;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Tt,t.enqueueRetryable(()=>i(this.currentUser))};let a=()=>{let c=s;t.enqueueRetryable(()=>C(this,null,function*(){yield c.promise,yield i(this.currentUser)}))},u=c=>{k("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=c,this.o&&(this.auth.addAuthTokenListener(this.o),a())};this.t.onInit(c=>u(c)),setTimeout(()=>{if(!this.auth){let c=this.t.getImmediate({optional:!0});c?u(c):(k("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Tt)}},0),a()}getToken(){let t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(n=>this.i!==t?(k("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):n?(U(typeof n.accessToken=="string"),new ks(n.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let t=this.auth&&this.auth.getUid();return U(t===null||typeof t=="string"),new wt(t)}},nu=class{constructor(t,e,n){this.l=t,this.h=e,this.P=n,this.type="FirstParty",this.user=wt.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let t=this.T();return t&&this.I.set("Authorization",t),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}},ru=class{constructor(t,e,n){this.l=t,this.h=e,this.P=n}getToken(){return Promise.resolve(new nu(this.l,this.h,this.P))}start(t,e){t.enqueueRetryable(()=>e(wt.FIRST_PARTY))}shutdown(){}invalidateToken(){}},iu=class{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},su=class{constructor(t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,e){U(this.o===void 0);let n=s=>{s.error!=null&&k("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);let a=s.token!==this.R;return this.R=s.token,k("FirebaseAppCheckTokenProvider",`Received ${a?"new":"existing"} token.`),a?e(s.token):Promise.resolve()};this.o=s=>{t.enqueueRetryable(()=>n(s))};let i=s=>{k("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){let s=this.A.getImmediate({optional:!0});s?i(s):k("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(U(typeof e.token=="string"),this.R=e.token,new iu(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}};function V_(r){let t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(r);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let n=0;n<r;n++)e[n]=Math.floor(256*Math.random());return e}var Ns=class{static newId(){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length,n="";for(;n.length<20;){let i=V_(40);for(let s=0;s<i.length;++s)n.length<20&&i[s]<e&&(n+=t.charAt(i[s]%t.length))}return n}};function K(r,t){return r<t?-1:r>t?1:0}function or(r,t,e){return r.length===t.length&&r.every((n,i)=>e(n,t[i]))}function Ff(r){return r+"\0"}var ct=class r{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new D(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new D(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new D(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new D(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return r.fromMillis(Date.now())}static fromDate(t){return r.fromMillis(t.getTime())}static fromMillis(t){let e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new r(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?K(this.nanoseconds,t.nanoseconds):K(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};var B=class r{constructor(t){this.timestamp=t}static fromTimestamp(t){return new r(t)}static min(){return new r(new ct(0,0))}static max(){return new r(new ct(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};var Fs=class r{constructor(t,e,n){e===void 0?e=0:e>t.length&&q(),n===void 0?n=t.length-e:n>t.length-e&&q(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return r.comparator(this,t)===0}child(t){let e=this.segments.slice(this.offset,this.limit());return t instanceof r?t.forEach(n=>{e.push(n)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){let n=Math.min(t.length,e.length);for(let i=0;i<n;i++){let s=t.get(i),a=e.get(i);if(s<a)return-1;if(s>a)return 1}return t.length<e.length?-1:t.length>e.length?1:0}},X=class r extends Fs{construct(t,e,n){return new r(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){let e=[];for(let n of t){if(n.indexOf("//")>=0)throw new D(P.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter(i=>i.length>0))}return new r(e)}static emptyPath(){return new r([])}},k_=/^[_a-zA-Z][_a-zA-Z0-9]*$/,mt=class r extends Fs{construct(t,e,n){return new r(t,e,n)}static isValidIdentifier(t){return k_.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),r.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new r(["__name__"])}static fromServerFormat(t){let e=[],n="",i=0,s=()=>{if(n.length===0)throw new D(P.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""},a=!1;for(;i<t.length;){let u=t[i];if(u==="\\"){if(i+1===t.length)throw new D(P.INVALID_ARGUMENT,"Path has trailing escape character: "+t);let c=t[i+1];if(c!=="\\"&&c!=="."&&c!=="`")throw new D(P.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=c,i+=2}else u==="`"?(a=!a,i++):u!=="."||a?(n+=u,i++):(s(),i++)}if(s(),a)throw new D(P.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new r(e)}static emptyPath(){return new r([])}};var L=class r{constructor(t){this.path=t}static fromPath(t){return new r(X.fromString(t))}static fromName(t){return new r(X.fromString(t).popFirst(5))}static empty(){return new r(X.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&X.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return X.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new r(new X(t.slice()))}};var ar=class{constructor(t,e,n,i){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=i}};function ou(r){return r.fields.find(t=>t.kind===2)}function ln(r){return r.fields.filter(t=>t.kind!==2)}ar.UNKNOWN_ID=-1;var rr=class{constructor(t,e){this.fieldPath=t,this.kind=e}};var _i=class r{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new r(0,$t.min())}};function Of(r,t){let e=r.toTimestamp().seconds,n=r.toTimestamp().nanoseconds+1,i=B.fromTimestamp(n===1e9?new ct(e+1,0):new ct(e,n));return new $t(i,L.empty(),t)}function Mf(r){return new $t(r.readTime,r.key,-1)}var $t=class r{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new r(B.min(),L.empty(),-1)}static max(){return new r(B.max(),L.empty(),-1)}};function Zc(r,t){let e=r.readTime.compareTo(t.readTime);return e!==0?e:(e=L.comparator(r.documentKey,t.documentKey),e!==0?e:K(r.largestBatchId,t.largestBatchId))}var Lf="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",Os=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}};function Ye(r){return C(this,null,function*(){if(r.code!==P.FAILED_PRECONDITION||r.message!==Lf)throw r;k("LocalStore","Unexpectedly lost primary lease")})}var b=class r{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&q(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new r((n,i)=>{this.nextCallback=s=>{this.wrapSuccess(t,s).next(n,i)},this.catchCallback=s=>{this.wrapFailure(e,s).next(n,i)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{let e=t();return e instanceof r?e:r.resolve(e)}catch(e){return r.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):r.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):r.reject(e)}static resolve(t){return new r((e,n)=>{e(t)})}static reject(t){return new r((e,n)=>{n(t)})}static waitFor(t){return new r((e,n)=>{let i=0,s=0,a=!1;t.forEach(u=>{++i,u.next(()=>{++s,a&&s===i&&e()},c=>n(c))}),a=!0,s===i&&e()})}static or(t){let e=r.resolve(!1);for(let n of t)e=e.next(i=>i?r.resolve(i):n());return e}static forEach(t,e){let n=[];return t.forEach((i,s)=>{n.push(e.call(this,i,s))}),this.waitFor(n)}static mapArray(t,e){return new r((n,i)=>{let s=t.length,a=new Array(s),u=0;for(let c=0;c<s;c++){let d=c;e(t[d]).next(f=>{a[d]=f,++u,u===s&&n(a)},f=>i(f))}})}static doWhile(t,e){return new r((n,i)=>{let s=()=>{t()===!0?e().next(()=>{s()},i):n()};s()})}};var Ms=class r{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.V=new Tt,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new pn(t,e.error)):this.V.resolve()},this.transaction.onerror=n=>{let i=tl(n.target.error);this.V.reject(new pn(t,i))}}static open(t,e,n,i){try{return new r(e,t.transaction(i,n))}catch(s){throw new pn(e,s)}}get m(){return this.V.promise}abort(t){t&&this.V.reject(t),this.aborted||(k("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let t=this.transaction;this.aborted||typeof t.commit!="function"||t.commit()}store(t){let e=this.transaction.objectStore(t);return new uu(e)}},je=class r{constructor(t,e,n){this.name=t,this.version=e,this.p=n,r.S(ei())===12.2&&ft("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return k("SimpleDb","Removing database:",t),hn(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!gs())return!1;if(r.v())return!0;let t=ei(),e=r.S(t),n=0<e&&e<10,i=qf(t),s=0<i&&i<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static v(){var t;return typeof process<"u"&&((t=process.__PRIVATE_env)===null||t===void 0?void 0:t.C)==="YES"}static F(t,e){return t.store(e)}static S(t){let e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}M(t){return C(this,null,function*(){return this.db||(k("SimpleDb","Opening database:",this.name),this.db=yield new Promise((e,n)=>{let i=indexedDB.open(this.name,this.version);i.onsuccess=s=>{let a=s.target.result;e(a)},i.onblocked=()=>{n(new pn(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=s=>{let a=s.target.error;a.name==="VersionError"?n(new D(P.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):a.name==="InvalidStateError"?n(new D(P.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+a)):n(new pn(t,a))},i.onupgradeneeded=s=>{k("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',s.oldVersion);let a=s.target.result;this.p.O(a,i.transaction,s.oldVersion,this.version).next(()=>{k("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=e=>this.N(e)),this.db})}L(t){this.N=t,this.db&&(this.db.onversionchange=e=>t(e))}runTransaction(t,e,n,i){return C(this,null,function*(){let s=e==="readonly",a=0;for(;;){++a;try{this.db=yield this.M(t);let u=Ms.open(this.db,t,s?"readonly":"readwrite",n),c=i(u).next(d=>(u.g(),d)).catch(d=>(u.abort(d),b.reject(d))).toPromise();return c.catch(()=>{}),yield u.m,c}catch(u){let c=u,d=c.name!=="FirebaseError"&&a<3;if(k("SimpleDb","Transaction failed with error:",c.message,"Retrying:",d),this.close(),!d)return Promise.reject(c)}}})}close(){this.db&&this.db.close(),this.db=void 0}};function qf(r){let t=r.match(/Android ([\d.]+)/i),e=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(e)}var au=class{constructor(t){this.B=t,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(t){this.B=t}done(){this.k=!0}$(t){this.q=t}delete(){return hn(this.B.delete())}},pn=class extends D{constructor(t,e){super(P.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}};function Xe(r){return r.name==="IndexedDbTransactionError"}var uu=class{constructor(t){this.store=t}put(t,e){let n;return e!==void 0?(k("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(k("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),hn(n)}add(t){return k("SimpleDb","ADD",this.store.name,t,t),hn(this.store.add(t))}get(t){return hn(this.store.get(t)).next(e=>(e===void 0&&(e=null),k("SimpleDb","GET",this.store.name,t,e),e))}delete(t){return k("SimpleDb","DELETE",this.store.name,t),hn(this.store.delete(t))}count(){return k("SimpleDb","COUNT",this.store.name),hn(this.store.count())}U(t,e){let n=this.options(t,e),i=n.index?this.store.index(n.index):this.store;if(typeof i.getAll=="function"){let s=i.getAll(n.range);return new b((a,u)=>{s.onerror=c=>{u(c.target.error)},s.onsuccess=c=>{a(c.target.result)}})}{let s=this.cursor(n),a=[];return this.W(s,(u,c)=>{a.push(c)}).next(()=>a)}}G(t,e){let n=this.store.getAll(t,e===null?void 0:e);return new b((i,s)=>{n.onerror=a=>{s(a.target.error)},n.onsuccess=a=>{i(a.target.result)}})}j(t,e){k("SimpleDb","DELETE ALL",this.store.name);let n=this.options(t,e);n.H=!1;let i=this.cursor(n);return this.W(i,(s,a,u)=>u.delete())}J(t,e){let n;e?n=t:(n={},e=t);let i=this.cursor(n);return this.W(i,e)}Y(t){let e=this.cursor({});return new b((n,i)=>{e.onerror=s=>{let a=tl(s.target.error);i(a)},e.onsuccess=s=>{let a=s.target.result;a?t(a.primaryKey,a.value).next(u=>{u?a.continue():n()}):n()}})}W(t,e){let n=[];return new b((i,s)=>{t.onerror=a=>{s(a.target.error)},t.onsuccess=a=>{let u=a.target.result;if(!u)return void i();let c=new au(u),d=e(u.primaryKey,u.value,c);if(d instanceof b){let f=d.catch(g=>(c.done(),b.reject(g)));n.push(f)}c.isDone?i():c.K===null?u.continue():u.continue(c.K)}}).next(()=>b.waitFor(n))}options(t,e){let n;return t!==void 0&&(typeof t=="string"?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){let n=this.store.index(t.index);return t.H?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}};function hn(r){return new b((t,e)=>{r.onsuccess=n=>{let i=n.target.result;t(i)},r.onerror=n=>{let i=tl(n.target.error);e(i)}})}var xd=!1;function tl(r){let t=je.S(ei());if(t>=12.2&&t<13){let e="An internal error was encountered in the Indexed Database server";if(r.message.indexOf(e)>=0){let n=new D("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return xd||(xd=!0,setTimeout(()=>{throw n},0)),n}}return r}var cu=class{constructor(t,e){this.asyncQueue=t,this.Z=e,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return this.task!==null}X(t){k("IndexBackfiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,()=>C(this,null,function*(){this.task=null;try{k("IndexBackfiller",`Documents written: ${yield this.Z.ee()}`)}catch(e){Xe(e)?k("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):yield Ye(e)}yield this.X(6e4)}))}},lu=class{constructor(t,e){this.localStore=t,this.persistence=e}ee(t=50){return C(this,null,function*(){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.te(e,t))})}te(t,e){let n=new Set,i=e,s=!0;return b.doWhile(()=>s===!0&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next(a=>{if(a!==null&&!n.has(a))return k("IndexBackfiller",`Processing collection: ${a}`),this.ne(t,a,i).next(u=>{i-=u,n.add(a)});s=!1})).next(()=>e-i)}ne(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next(i=>this.localStore.localDocuments.getNextDocuments(t,e,i,n).next(s=>{let a=s.changes;return this.localStore.indexManager.updateIndexEntries(t,a).next(()=>this.re(i,s)).next(u=>(k("IndexBackfiller",`Updating offset: ${u}`),this.localStore.indexManager.updateCollectionGroup(t,e,u))).next(()=>a.size)}))}re(t,e){let n=t;return e.changes.forEach((i,s)=>{let a=Mf(s);Zc(a,n)>0&&(n=a)}),new $t(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}};var zt=(()=>{class r{constructor(e,n){this.previousValue=e,n&&(n.sequenceNumberHandler=i=>this.ie(i),this.se=i=>n.writeSequenceNumber(i))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.se&&this.se(e),e}}return r.oe=-1,r})();function Li(r){return r==null}function yi(r){return r===0&&1/r==-1/0}function Uf(r){return typeof r=="number"&&Number.isInteger(r)&&!yi(r)&&r<=Number.MAX_SAFE_INTEGER&&r>=Number.MIN_SAFE_INTEGER}function Ot(r){let t="";for(let e=0;e<r.length;e++)t.length>0&&(t=Dd(t)),t=N_(r.get(e),t);return Dd(t)}function N_(r,t){let e=t,n=r.length;for(let i=0;i<n;i++){let s=r.charAt(i);switch(s){case"\0":e+="";break;case"":e+="";break;default:e+=s}}return e}function Dd(r){return r+""}function ne(r){let t=r.length;if(U(t>=2),t===2)return U(r.charAt(0)===""&&r.charAt(1)===""),X.emptyPath();let e=t-2,n=[],i="";for(let s=0;s<t;){let a=r.indexOf("",s);switch((a<0||a>e)&&q(),r.charAt(a+1)){case"":let u=r.substring(s,a),c;i.length===0?c=u:(i+=u,c=i,i=""),n.push(c);break;case"":i+=r.substring(s,a),i+="\0";break;case"":i+=r.substring(s,a+1);break;default:q()}s=a+2}return new X(n)}var Vd=["userId","batchId"];function Ps(r,t){return[r,Ot(t)]}function Bf(r,t,e){return[r,Ot(t),e]}var F_={},O_=["prefixPath","collectionGroup","readTime","documentId"],M_=["prefixPath","collectionGroup","documentId"],L_=["collectionGroup","readTime","prefixPath","documentId"],q_=["canonicalId","targetId"],U_=["targetId","path"],B_=["path","targetId"],j_=["collectionId","parent"],z_=["indexId","uid"],G_=["uid","sequenceNumber"],K_=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],$_=["indexId","uid","orderedDocumentKey"],Q_=["userId","collectionPath","documentId"],W_=["userId","collectionPath","largestBatchId"],H_=["userId","collectionGroup","largestBatchId"],jf=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],J_=[...jf,"documentOverlays"],zf=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Gf=zf,el=[...Gf,"indexConfiguration","indexState","indexEntries"],Y_=el,X_=[...el,"globals"];var wi=class extends Os{constructor(t,e){super(),this._e=t,this.currentSequenceNumber=e}};function It(r,t){let e=M(r);return je.F(e._e,t)}function kd(r){let t=0;for(let e in r)Object.prototype.hasOwnProperty.call(r,e)&&t++;return t}function Pn(r,t){for(let e in r)Object.prototype.hasOwnProperty.call(r,e)&&t(e,r[e])}function Kf(r){for(let t in r)if(Object.prototype.hasOwnProperty.call(r,t))return!1;return!0}var ot=class r{constructor(t,e){this.comparator=t,this.root=e||ie.EMPTY}insert(t,e){return new r(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,ie.BLACK,null,null))}remove(t){return new r(this.comparator,this.root.remove(t,this.comparator).copy(null,null,ie.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){let n=this.comparator(t,e.key);if(n===0)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){let i=this.comparator(t,n.key);if(i===0)return e+n.left.size;i<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,n)=>(t(e,n),!1))}toString(){let t=[];return this.inorderTraversal((e,n)=>(t.push(`${e}:${n}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new nr(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new nr(this.root,t,this.comparator,!1)}getReverseIterator(){return new nr(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new nr(this.root,t,this.comparator,!0)}},nr=class{constructor(t,e,n,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,e&&i&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(s===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}},ie=class r{constructor(t,e,n,i,s){this.key=t,this.value=e,this.color=n??r.RED,this.left=i??r.EMPTY,this.right=s??r.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,i,s){return new r(t??this.key,e??this.value,n??this.color,i??this.left,s??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let i=this,s=n(t,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(t,e,n),null):s===0?i.copy(null,e,null,null,null):i.copy(null,null,null,null,i.right.insert(t,e,n)),i.fixUp()}removeMin(){if(this.left.isEmpty())return r.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,i=this;if(e(t,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(t,e),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),e(t,i.key)===0){if(i.right.isEmpty())return r.EMPTY;n=i.right.min(),i=i.copy(n.key,n.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(t,e))}return i.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){let t=this.copy(null,null,r.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){let t=this.copy(null,null,r.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){let t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){let t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw q();let t=this.left.check();if(t!==this.right.check())throw q();return t+(this.isRed()?0:1)}};ie.EMPTY=null,ie.RED=!0,ie.BLACK=!1;ie.EMPTY=new class{constructor(){this.size=0}get key(){throw q()}get value(){throw q()}get color(){throw q()}get left(){throw q()}get right(){throw q()}copy(t,e,n,i,s){return this}insert(t,e,n){return new ie(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};var rt=class r{constructor(t){this.comparator=t,this.data=new ot(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,n)=>(t(e),!1))}forEachInRange(t,e){let n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){let i=n.getNext();if(this.comparator(i.key,t[1])>=0)return;e(i.key)}}forEachWhile(t,e){let n;for(n=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){let e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Ls(this.data.getIterator())}getIteratorFrom(t){return new Ls(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(n=>{e=e.add(n)}),e}isEqual(t){if(!(t instanceof r)||this.size!==t.size)return!1;let e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){let i=e.getNext().key,s=n.getNext().key;if(this.comparator(i,s)!==0)return!1}return!0}toArray(){let t=[];return this.forEach(e=>{t.push(e)}),t}toString(){let t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){let e=new r(this.comparator);return e.data=t,e}},Ls=class{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};function Qn(r){return r.hasNext()?r.getNext():void 0}var Gt=class r{constructor(t){this.fields=t,t.sort(mt.comparator)}static empty(){return new r([])}unionWith(t){let e=new rt(mt.comparator);for(let n of this.fields)e=e.add(n);for(let n of t)e=e.add(n);return new r(e.toArray())}covers(t){for(let e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return or(this.fields,t.fields,(e,n)=>e.isEqual(n))}};var qs=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};function $f(){return typeof atob<"u"}var pt=class r{constructor(t){this.binaryString=t}static fromBase64String(t){let e=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new qs("Invalid base64 string: "+s):s}}(t);return new r(e)}static fromUint8Array(t){let e=function(i){let s="";for(let a=0;a<i.length;++a)s+=String.fromCharCode(i[a]);return s}(t);return new r(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){let n=new Uint8Array(e.length);for(let i=0;i<e.length;i++)n[i]=e.charCodeAt(i);return n}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return K(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}};pt.EMPTY_BYTE_STRING=new pt("");var Z_=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ye(r){if(U(!!r),typeof r=="string"){let t=0,e=Z_.exec(r);if(U(!!e),e[1]){let i=e[1];i=(i+"000000000").substr(0,9),t=Number(i)}let n=new Date(r);return{seconds:Math.floor(n.getTime()/1e3),nanos:t}}return{seconds:at(r.seconds),nanos:at(r.nanos)}}function at(r){return typeof r=="number"?r:typeof r=="string"?Number(r):0}function ze(r){return typeof r=="string"?pt.fromBase64String(r):pt.fromUint8Array(r)}function Do(r){var t,e;return((e=(((t=r?.mapValue)===null||t===void 0?void 0:t.fields)||{}).__type__)===null||e===void 0?void 0:e.stringValue)==="server_timestamp"}function nl(r){let t=r.mapValue.fields.__previous_value__;return Do(t)?nl(t):t}function vi(r){let t=ye(r.mapValue.fields.__local_write_time__.timestampValue);return new ct(t.seconds,t.nanos)}var hu=class{constructor(t,e,n,i,s,a,u,c,d){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=i,this.ssl=s,this.forceLongPolling=a,this.autoDetectLongPolling=u,this.longPollingOptions=c,this.useFetchStreams=d}},Ge=class r{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new r("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(t){return t instanceof r&&t.projectId===this.projectId&&t.database===this.database}};var qe={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Cs={nullValue:"NULL_VALUE"};function _n(r){return"nullValue"in r?0:"booleanValue"in r?1:"integerValue"in r||"doubleValue"in r?2:"timestampValue"in r?3:"stringValue"in r?5:"bytesValue"in r?6:"referenceValue"in r?7:"geoPointValue"in r?8:"arrayValue"in r?9:"mapValue"in r?Do(r)?4:Qf(r)?9007199254740991:Vo(r)?10:11:q()}function ae(r,t){if(r===t)return!0;let e=_n(r);if(e!==_n(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return r.booleanValue===t.booleanValue;case 4:return vi(r).isEqual(vi(t));case 3:return function(i,s){if(typeof i.timestampValue=="string"&&typeof s.timestampValue=="string"&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;let a=ye(i.timestampValue),u=ye(s.timestampValue);return a.seconds===u.seconds&&a.nanos===u.nanos}(r,t);case 5:return r.stringValue===t.stringValue;case 6:return function(i,s){return ze(i.bytesValue).isEqual(ze(s.bytesValue))}(r,t);case 7:return r.referenceValue===t.referenceValue;case 8:return function(i,s){return at(i.geoPointValue.latitude)===at(s.geoPointValue.latitude)&&at(i.geoPointValue.longitude)===at(s.geoPointValue.longitude)}(r,t);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return at(i.integerValue)===at(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){let a=at(i.doubleValue),u=at(s.doubleValue);return a===u?yi(a)===yi(u):isNaN(a)&&isNaN(u)}return!1}(r,t);case 9:return or(r.arrayValue.values||[],t.arrayValue.values||[],ae);case 10:case 11:return function(i,s){let a=i.mapValue.fields||{},u=s.mapValue.fields||{};if(kd(a)!==kd(u))return!1;for(let c in a)if(a.hasOwnProperty(c)&&(u[c]===void 0||!ae(a[c],u[c])))return!1;return!0}(r,t);default:return q()}}function Ti(r,t){return(r.values||[]).find(e=>ae(e,t))!==void 0}function Ke(r,t){if(r===t)return 0;let e=_n(r),n=_n(t);if(e!==n)return K(e,n);switch(e){case 0:case 9007199254740991:return 0;case 1:return K(r.booleanValue,t.booleanValue);case 2:return function(s,a){let u=at(s.integerValue||s.doubleValue),c=at(a.integerValue||a.doubleValue);return u<c?-1:u>c?1:u===c?0:isNaN(u)?isNaN(c)?0:-1:1}(r,t);case 3:return Nd(r.timestampValue,t.timestampValue);case 4:return Nd(vi(r),vi(t));case 5:return K(r.stringValue,t.stringValue);case 6:return function(s,a){let u=ze(s),c=ze(a);return u.compareTo(c)}(r.bytesValue,t.bytesValue);case 7:return function(s,a){let u=s.split("/"),c=a.split("/");for(let d=0;d<u.length&&d<c.length;d++){let f=K(u[d],c[d]);if(f!==0)return f}return K(u.length,c.length)}(r.referenceValue,t.referenceValue);case 8:return function(s,a){let u=K(at(s.latitude),at(a.latitude));return u!==0?u:K(at(s.longitude),at(a.longitude))}(r.geoPointValue,t.geoPointValue);case 9:return Fd(r.arrayValue,t.arrayValue);case 10:return function(s,a){var u,c,d,f;let g=s.fields||{},_=a.fields||{},A=(u=g.value)===null||u===void 0?void 0:u.arrayValue,V=(c=_.value)===null||c===void 0?void 0:c.arrayValue,N=K(((d=A?.values)===null||d===void 0?void 0:d.length)||0,((f=V?.values)===null||f===void 0?void 0:f.length)||0);return N!==0?N:Fd(A,V)}(r.mapValue,t.mapValue);case 11:return function(s,a){if(s===qe.mapValue&&a===qe.mapValue)return 0;if(s===qe.mapValue)return 1;if(a===qe.mapValue)return-1;let u=s.fields||{},c=Object.keys(u),d=a.fields||{},f=Object.keys(d);c.sort(),f.sort();for(let g=0;g<c.length&&g<f.length;++g){let _=K(c[g],f[g]);if(_!==0)return _;let A=Ke(u[c[g]],d[f[g]]);if(A!==0)return A}return K(c.length,f.length)}(r.mapValue,t.mapValue);default:throw q()}}function Nd(r,t){if(typeof r=="string"&&typeof t=="string"&&r.length===t.length)return K(r,t);let e=ye(r),n=ye(t),i=K(e.seconds,n.seconds);return i!==0?i:K(e.nanos,n.nanos)}function Fd(r,t){let e=r.values||[],n=t.values||[];for(let i=0;i<e.length&&i<n.length;++i){let s=Ke(e[i],n[i]);if(s)return s}return K(e.length,n.length)}function ur(r){return du(r)}function du(r){return"nullValue"in r?"null":"booleanValue"in r?""+r.booleanValue:"integerValue"in r?""+r.integerValue:"doubleValue"in r?""+r.doubleValue:"timestampValue"in r?function(e){let n=ye(e);return`time(${n.seconds},${n.nanos})`}(r.timestampValue):"stringValue"in r?r.stringValue:"bytesValue"in r?function(e){return ze(e).toBase64()}(r.bytesValue):"referenceValue"in r?function(e){return L.fromName(e).toString()}(r.referenceValue):"geoPointValue"in r?function(e){return`geo(${e.latitude},${e.longitude})`}(r.geoPointValue):"arrayValue"in r?function(e){let n="[",i=!0;for(let s of e.values||[])i?i=!1:n+=",",n+=du(s);return n+"]"}(r.arrayValue):"mapValue"in r?function(e){let n=Object.keys(e.fields||{}).sort(),i="{",s=!0;for(let a of n)s?s=!1:i+=",",i+=`${a}:${du(e.fields[a])}`;return i+"}"}(r.mapValue):q()}function yn(r,t){return{referenceValue:`projects/${r.projectId}/databases/${r.database}/documents/${t.path.canonicalString()}`}}function fu(r){return!!r&&"integerValue"in r}function Ii(r){return!!r&&"arrayValue"in r}function Od(r){return!!r&&"nullValue"in r}function Md(r){return!!r&&"doubleValue"in r&&isNaN(Number(r.doubleValue))}function xs(r){return!!r&&"mapValue"in r}function Vo(r){var t,e;return((e=(((t=r?.mapValue)===null||t===void 0?void 0:t.fields)||{}).__type__)===null||e===void 0?void 0:e.stringValue)==="__vector__"}function di(r){if(r.geoPointValue)return{geoPointValue:Object.assign({},r.geoPointValue)};if(r.timestampValue&&typeof r.timestampValue=="object")return{timestampValue:Object.assign({},r.timestampValue)};if(r.mapValue){let t={mapValue:{fields:{}}};return Pn(r.mapValue.fields,(e,n)=>t.mapValue.fields[e]=di(n)),t}if(r.arrayValue){let t={arrayValue:{values:[]}};for(let e=0;e<(r.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=di(r.arrayValue.values[e]);return t}return Object.assign({},r)}function Qf(r){return(((r.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}var Wf={mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{}}}}};function ty(r){return"nullValue"in r?Cs:"booleanValue"in r?{booleanValue:!1}:"integerValue"in r||"doubleValue"in r?{doubleValue:NaN}:"timestampValue"in r?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in r?{stringValue:""}:"bytesValue"in r?{bytesValue:""}:"referenceValue"in r?yn(Ge.empty(),L.empty()):"geoPointValue"in r?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in r?{arrayValue:{}}:"mapValue"in r?Vo(r)?Wf:{mapValue:{}}:q()}function ey(r){return"nullValue"in r?{booleanValue:!1}:"booleanValue"in r?{doubleValue:NaN}:"integerValue"in r||"doubleValue"in r?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in r?{stringValue:""}:"stringValue"in r?{bytesValue:""}:"bytesValue"in r?yn(Ge.empty(),L.empty()):"referenceValue"in r?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in r?{arrayValue:{}}:"arrayValue"in r?Wf:"mapValue"in r?Vo(r)?{mapValue:{}}:qe:q()}function Ld(r,t){let e=Ke(r.value,t.value);return e!==0?e:r.inclusive&&!t.inclusive?-1:!r.inclusive&&t.inclusive?1:0}function qd(r,t){let e=Ke(r.value,t.value);return e!==0?e:r.inclusive&&!t.inclusive?1:!r.inclusive&&t.inclusive?-1:0}var Dt=class r{constructor(t){this.value=t}static empty(){return new r({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!xs(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=di(e)}setAll(t){let e=mt.emptyPath(),n={},i=[];t.forEach((a,u)=>{if(!e.isImmediateParentOf(u)){let c=this.getFieldsMap(e);this.applyChanges(c,n,i),n={},i=[],e=u.popLast()}a?n[u.lastSegment()]=di(a):i.push(u.lastSegment())});let s=this.getFieldsMap(e);this.applyChanges(s,n,i)}delete(t){let e=this.field(t.popLast());xs(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return ae(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let i=e.mapValue.fields[t.get(n)];xs(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=i),e=i}return e.mapValue.fields}applyChanges(t,e,n){Pn(e,(i,s)=>t[i]=s);for(let i of n)delete t[i]}clone(){return new r(di(this.value))}};function Hf(r){let t=[];return Pn(r.fields,(e,n)=>{let i=new mt([e]);if(xs(n)){let s=Hf(n.mapValue).fields;if(s.length===0)t.push(i);else for(let a of s)t.push(i.child(a))}else t.push(i)}),new Gt(t)}var vt=class r{constructor(t,e,n,i,s,a,u){this.key=t,this.documentType=e,this.version=n,this.readTime=i,this.createTime=s,this.data=a,this.documentState=u}static newInvalidDocument(t){return new r(t,0,B.min(),B.min(),B.min(),Dt.empty(),0)}static newFoundDocument(t,e,n,i){return new r(t,1,e,B.min(),n,i,0)}static newNoDocument(t,e){return new r(t,2,e,B.min(),B.min(),Dt.empty(),0)}static newUnknownDocument(t,e){return new r(t,3,e,B.min(),B.min(),Dt.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(B.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Dt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Dt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=B.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof r&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new r(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};var ue=class{constructor(t,e){this.position=t,this.inclusive=e}};function Ud(r,t,e){let n=0;for(let i=0;i<r.position.length;i++){let s=t[i],a=r.position[i];if(s.field.isKeyField()?n=L.comparator(L.fromName(a.referenceValue),e.key):n=Ke(a,e.data.field(s.field)),s.dir==="desc"&&(n*=-1),n!==0)break}return n}function Bd(r,t){if(r===null)return t===null;if(t===null||r.inclusive!==t.inclusive||r.position.length!==t.position.length)return!1;for(let e=0;e<r.position.length;e++)if(!ae(r.position[e],t.position[e]))return!1;return!0}var wn=class{constructor(t,e="asc"){this.field=t,this.dir=e}};function ny(r,t){return r.dir===t.dir&&r.field.isEqual(t.field)}var Us=class{},H=class r extends Us{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,n):new pu(t,e,n):e==="array-contains"?new wu(t,n):e==="in"?new Bs(t,n):e==="not-in"?new vu(t,n):e==="array-contains-any"?new Tu(t,n):new r(t,e,n)}static createKeyFieldInFilter(t,e,n){return e==="in"?new _u(t,n):new yu(t,n)}matches(t){let e=t.data.field(this.field);return this.op==="!="?e!==null&&this.matchesComparison(Ke(e,this.value)):e!==null&&_n(this.value)===_n(e)&&this.matchesComparison(Ke(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return q()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},et=class r extends Us{constructor(t,e){super(),this.filters=t,this.op=e,this.ae=null}static create(t,e){return new r(t,e)}matches(t){return cr(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}};function cr(r){return r.op==="and"}function mu(r){return r.op==="or"}function rl(r){return Jf(r)&&cr(r)}function Jf(r){for(let t of r.filters)if(t instanceof et)return!1;return!0}function gu(r){if(r instanceof H)return r.field.canonicalString()+r.op.toString()+ur(r.value);if(rl(r))return r.filters.map(t=>gu(t)).join(",");{let t=r.filters.map(e=>gu(e)).join(",");return`${r.op}(${t})`}}function Yf(r,t){return r instanceof H?function(n,i){return i instanceof H&&n.op===i.op&&n.field.isEqual(i.field)&&ae(n.value,i.value)}(r,t):r instanceof et?function(n,i){return i instanceof et&&n.op===i.op&&n.filters.length===i.filters.length?n.filters.reduce((s,a,u)=>s&&Yf(a,i.filters[u]),!0):!1}(r,t):void q()}function Xf(r,t){let e=r.filters.concat(t);return et.create(e,r.op)}function Zf(r){return r instanceof H?function(e){return`${e.field.canonicalString()} ${e.op} ${ur(e.value)}`}(r):r instanceof et?function(e){return e.op.toString()+" {"+e.getFilters().map(Zf).join(" ,")+"}"}(r):"Filter"}var pu=class extends H{constructor(t,e,n){super(t,e,n),this.key=L.fromName(n.referenceValue)}matches(t){let e=L.comparator(t.key,this.key);return this.matchesComparison(e)}},_u=class extends H{constructor(t,e){super(t,"in",e),this.keys=tm("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}},yu=class extends H{constructor(t,e){super(t,"not-in",e),this.keys=tm("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}};function tm(r,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(n=>L.fromName(n.referenceValue))}var wu=class extends H{constructor(t,e){super(t,"array-contains",e)}matches(t){let e=t.data.field(this.field);return Ii(e)&&Ti(e.arrayValue,this.value)}},Bs=class extends H{constructor(t,e){super(t,"in",e)}matches(t){let e=t.data.field(this.field);return e!==null&&Ti(this.value.arrayValue,e)}},vu=class extends H{constructor(t,e){super(t,"not-in",e)}matches(t){if(Ti(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let e=t.data.field(this.field);return e!==null&&!Ti(this.value.arrayValue,e)}},Tu=class extends H{constructor(t,e){super(t,"array-contains-any",e)}matches(t){let e=t.data.field(this.field);return!(!Ii(e)||!e.arrayValue.values)&&e.arrayValue.values.some(n=>Ti(this.value.arrayValue,n))}};var Iu=class{constructor(t,e=null,n=[],i=[],s=null,a=null,u=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=i,this.limit=s,this.startAt=a,this.endAt=u,this.ue=null}};function Eu(r,t=null,e=[],n=[],i=null,s=null,a=null){return new Iu(r,t,e,n,i,s,a)}function vn(r){let t=M(r);if(t.ue===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(n=>gu(n)).join(","),e+="|ob:",e+=t.orderBy.map(n=>function(s){return s.field.canonicalString()+s.dir}(n)).join(","),Li(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(n=>ur(n)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(n=>ur(n)).join(",")),t.ue=e}return t.ue}function qi(r,t){if(r.limit!==t.limit||r.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<r.orderBy.length;e++)if(!ny(r.orderBy[e],t.orderBy[e]))return!1;if(r.filters.length!==t.filters.length)return!1;for(let e=0;e<r.filters.length;e++)if(!Yf(r.filters[e],t.filters[e]))return!1;return r.collectionGroup===t.collectionGroup&&!!r.path.isEqual(t.path)&&!!Bd(r.startAt,t.startAt)&&Bd(r.endAt,t.endAt)}function js(r){return L.isDocumentKey(r.path)&&r.collectionGroup===null&&r.filters.length===0}function zs(r,t){return r.filters.filter(e=>e instanceof H&&e.field.isEqual(t))}function jd(r,t,e){let n=Cs,i=!0;for(let s of zs(r,t)){let a=Cs,u=!0;switch(s.op){case"<":case"<=":a=ty(s.value);break;case"==":case"in":case">=":a=s.value;break;case">":a=s.value,u=!1;break;case"!=":case"not-in":a=Cs}Ld({value:n,inclusive:i},{value:a,inclusive:u})<0&&(n=a,i=u)}if(e!==null){for(let s=0;s<r.orderBy.length;++s)if(r.orderBy[s].field.isEqual(t)){let a=e.position[s];Ld({value:n,inclusive:i},{value:a,inclusive:e.inclusive})<0&&(n=a,i=e.inclusive);break}}return{value:n,inclusive:i}}function zd(r,t,e){let n=qe,i=!0;for(let s of zs(r,t)){let a=qe,u=!0;switch(s.op){case">=":case">":a=ey(s.value),u=!1;break;case"==":case"in":case"<=":a=s.value;break;case"<":a=s.value,u=!1;break;case"!=":case"not-in":a=qe}qd({value:n,inclusive:i},{value:a,inclusive:u})>0&&(n=a,i=u)}if(e!==null){for(let s=0;s<r.orderBy.length;++s)if(r.orderBy[s].field.isEqual(t)){let a=e.position[s];qd({value:n,inclusive:i},{value:a,inclusive:e.inclusive})>0&&(n=a,i=e.inclusive);break}}return{value:n,inclusive:i}}var Yt=class{constructor(t,e=null,n=[],i=[],s=null,a="F",u=null,c=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=i,this.limit=s,this.limitType=a,this.startAt=u,this.endAt=c,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}};function em(r,t,e,n,i,s,a,u){return new Yt(r,t,e,n,i,s,a,u)}function Ar(r){return new Yt(r)}function Gd(r){return r.filters.length===0&&r.limit===null&&r.startAt==null&&r.endAt==null&&(r.explicitOrderBy.length===0||r.explicitOrderBy.length===1&&r.explicitOrderBy[0].field.isKeyField())}function il(r){return r.collectionGroup!==null}function ir(r){let t=M(r);if(t.ce===null){t.ce=[];let e=new Set;for(let s of t.explicitOrderBy)t.ce.push(s),e.add(s.field.canonicalString());let n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(a){let u=new rt(mt.comparator);return a.filters.forEach(c=>{c.getFlattenedFilters().forEach(d=>{d.isInequality()&&(u=u.add(d.field))})}),u})(t).forEach(s=>{e.has(s.canonicalString())||s.isKeyField()||t.ce.push(new wn(s,n))}),e.has(mt.keyField().canonicalString())||t.ce.push(new wn(mt.keyField(),n))}return t.ce}function Mt(r){let t=M(r);return t.le||(t.le=ry(t,ir(r))),t.le}function ry(r,t){if(r.limitType==="F")return Eu(r.path,r.collectionGroup,t,r.filters,r.limit,r.startAt,r.endAt);{t=t.map(i=>{let s=i.dir==="desc"?"asc":"desc";return new wn(i.field,s)});let e=r.endAt?new ue(r.endAt.position,r.endAt.inclusive):null,n=r.startAt?new ue(r.startAt.position,r.startAt.inclusive):null;return Eu(r.path,r.collectionGroup,t,r.filters,r.limit,e,n)}}function Au(r,t){let e=r.filters.concat([t]);return new Yt(r.path,r.collectionGroup,r.explicitOrderBy.slice(),e,r.limit,r.limitType,r.startAt,r.endAt)}function Gs(r,t,e){return new Yt(r.path,r.collectionGroup,r.explicitOrderBy.slice(),r.filters.slice(),t,e,r.startAt,r.endAt)}function Ui(r,t){return qi(Mt(r),Mt(t))&&r.limitType===t.limitType}function nm(r){return`${vn(Mt(r))}|lt:${r.limitType}`}function Xn(r){return`Query(target=${function(e){let n=e.path.canonicalString();return e.collectionGroup!==null&&(n+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(n+=`, filters: [${e.filters.map(i=>Zf(i)).join(", ")}]`),Li(e.limit)||(n+=", limit: "+e.limit),e.orderBy.length>0&&(n+=`, orderBy: [${e.orderBy.map(i=>function(a){return`${a.field.canonicalString()} (${a.dir})`}(i)).join(", ")}]`),e.startAt&&(n+=", startAt: ",n+=e.startAt.inclusive?"b:":"a:",n+=e.startAt.position.map(i=>ur(i)).join(",")),e.endAt&&(n+=", endAt: ",n+=e.endAt.inclusive?"a:":"b:",n+=e.endAt.position.map(i=>ur(i)).join(",")),`Target(${n})`}(Mt(r))}; limitType=${r.limitType})`}function Bi(r,t){return t.isFoundDocument()&&function(n,i){let s=i.key.path;return n.collectionGroup!==null?i.key.hasCollectionId(n.collectionGroup)&&n.path.isPrefixOf(s):L.isDocumentKey(n.path)?n.path.isEqual(s):n.path.isImmediateParentOf(s)}(r,t)&&function(n,i){for(let s of ir(n))if(!s.field.isKeyField()&&i.data.field(s.field)===null)return!1;return!0}(r,t)&&function(n,i){for(let s of n.filters)if(!s.matches(i))return!1;return!0}(r,t)&&function(n,i){return!(n.startAt&&!function(a,u,c){let d=Ud(a,u,c);return a.inclusive?d<=0:d<0}(n.startAt,ir(n),i)||n.endAt&&!function(a,u,c){let d=Ud(a,u,c);return a.inclusive?d>=0:d>0}(n.endAt,ir(n),i))}(r,t)}function rm(r){return r.collectionGroup||(r.path.length%2==1?r.path.lastSegment():r.path.get(r.path.length-2))}function im(r){return(t,e)=>{let n=!1;for(let i of ir(r)){let s=iy(i,t,e);if(s!==0)return s;n=n||i.field.isKeyField()}return 0}}function iy(r,t,e){let n=r.field.isKeyField()?L.comparator(t.key,e.key):function(s,a,u){let c=a.data.field(s),d=u.data.field(s);return c!==null&&d!==null?Ke(c,d):q()}(r.field,t,e);switch(r.dir){case"asc":return n;case"desc":return-1*n;default:return q()}}var ce=class{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){let e=this.mapKeyFn(t),n=this.inner[e];if(n!==void 0){for(let[i,s]of n)if(this.equalsFn(i,t))return s}}has(t){return this.get(t)!==void 0}set(t,e){let n=this.mapKeyFn(t),i=this.inner[n];if(i===void 0)return this.inner[n]=[[t,e]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],t))return void(i[s]=[t,e]);i.push([t,e]),this.innerSize++}delete(t){let e=this.mapKeyFn(t),n=this.inner[e];if(n===void 0)return!1;for(let i=0;i<n.length;i++)if(this.equalsFn(n[i][0],t))return n.length===1?delete this.inner[e]:n.splice(i,1),this.innerSize--,!0;return!1}forEach(t){Pn(this.inner,(e,n)=>{for(let[i,s]of n)t(i,s)})}isEmpty(){return Kf(this.inner)}size(){return this.innerSize}};var sy=new ot(L.comparator);function Bt(){return sy}var sm=new ot(L.comparator);function li(...r){let t=sm;for(let e of r)t=t.insert(e.key,e);return t}function om(r){let t=sm;return r.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function re(){return fi()}function am(){return fi()}function fi(){return new ce(r=>r.toString(),(r,t)=>r.isEqual(t))}var oy=new ot(L.comparator),ay=new rt(L.comparator);function W(...r){let t=ay;for(let e of r)t=t.add(e);return t}var uy=new rt(K);function sl(){return uy}function ol(r,t){if(r.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:yi(t)?"-0":t}}function um(r){return{integerValue:""+r}}function cm(r,t){return Uf(t)?um(t):ol(r,t)}var lr=class{constructor(){this._=void 0}};function cy(r,t,e){return r instanceof $e?function(i,s){let a={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&Do(s)&&(s=nl(s)),s&&(a.fields.__previous_value__=s),{mapValue:a}}(e,t):r instanceof we?hm(r,t):r instanceof ve?dm(r,t):function(i,s){let a=lm(i,s),u=Kd(a)+Kd(i.Pe);return fu(a)&&fu(i.Pe)?um(u):ol(i.serializer,u)}(r,t)}function ly(r,t,e){return r instanceof we?hm(r,t):r instanceof ve?dm(r,t):e}function lm(r,t){return r instanceof Qe?function(n){return fu(n)||function(s){return!!s&&"doubleValue"in s}(n)}(t)?t:{integerValue:0}:null}var $e=class extends lr{},we=class extends lr{constructor(t){super(),this.elements=t}};function hm(r,t){let e=fm(t);for(let n of r.elements)e.some(i=>ae(i,n))||e.push(n);return{arrayValue:{values:e}}}var ve=class extends lr{constructor(t){super(),this.elements=t}};function dm(r,t){let e=fm(t);for(let n of r.elements)e=e.filter(i=>!ae(i,n));return{arrayValue:{values:e}}}var Qe=class extends lr{constructor(t,e){super(),this.serializer=t,this.Pe=e}};function Kd(r){return at(r.integerValue||r.doubleValue)}function fm(r){return Ii(r)&&r.arrayValue.values?r.arrayValue.values.slice():[]}var Tn=class{constructor(t,e){this.field=t,this.transform=e}};function hy(r,t){return r.field.isEqual(t.field)&&function(n,i){return n instanceof we&&i instanceof we||n instanceof ve&&i instanceof ve?or(n.elements,i.elements,ae):n instanceof Qe&&i instanceof Qe?ae(n.Pe,i.Pe):n instanceof $e&&i instanceof $e}(r.transform,t.transform)}var Su=class{constructor(t,e){this.version=t,this.transformResults=e}},dt=class r{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new r}static exists(t){return new r(void 0,t)}static updateTime(t){return new r(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}};function Ds(r,t){return r.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(r.updateTime):r.exists===void 0||r.exists===t.isFoundDocument()}var hr=class{};function mm(r,t){if(!r.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return r.isNoDocument()?new He(r.key,dt.none()):new We(r.key,r.data,dt.none());{let e=r.data,n=Dt.empty(),i=new rt(mt.comparator);for(let s of t.fields)if(!i.has(s)){let a=e.field(s);a===null&&s.length>1&&(s=s.popLast(),a=e.field(s)),a===null?n.delete(s):n.set(s,a),i=i.add(s)}return new Xt(r.key,n,new Gt(i.toArray()),dt.none())}}function dy(r,t,e){r instanceof We?function(i,s,a){let u=i.value.clone(),c=Qd(i.fieldTransforms,s,a.transformResults);u.setAll(c),s.convertToFoundDocument(a.version,u).setHasCommittedMutations()}(r,t,e):r instanceof Xt?function(i,s,a){if(!Ds(i.precondition,s))return void s.convertToUnknownDocument(a.version);let u=Qd(i.fieldTransforms,s,a.transformResults),c=s.data;c.setAll(gm(i)),c.setAll(u),s.convertToFoundDocument(a.version,c).setHasCommittedMutations()}(r,t,e):function(i,s,a){s.convertToNoDocument(a.version).setHasCommittedMutations()}(0,t,e)}function mi(r,t,e,n){return r instanceof We?function(s,a,u,c){if(!Ds(s.precondition,a))return u;let d=s.value.clone(),f=Wd(s.fieldTransforms,c,a);return d.setAll(f),a.convertToFoundDocument(a.version,d).setHasLocalMutations(),null}(r,t,e,n):r instanceof Xt?function(s,a,u,c){if(!Ds(s.precondition,a))return u;let d=Wd(s.fieldTransforms,c,a),f=a.data;return f.setAll(gm(s)),f.setAll(d),a.convertToFoundDocument(a.version,f).setHasLocalMutations(),u===null?null:u.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(g=>g.field))}(r,t,e,n):function(s,a,u){return Ds(s.precondition,a)?(a.convertToNoDocument(a.version).setHasLocalMutations(),null):u}(r,t,e)}function fy(r,t){let e=null;for(let n of r.fieldTransforms){let i=t.data.field(n.field),s=lm(n.transform,i||null);s!=null&&(e===null&&(e=Dt.empty()),e.set(n.field,s))}return e||null}function $d(r,t){return r.type===t.type&&!!r.key.isEqual(t.key)&&!!r.precondition.isEqual(t.precondition)&&!!function(n,i){return n===void 0&&i===void 0||!(!n||!i)&&or(n,i,(s,a)=>hy(s,a))}(r.fieldTransforms,t.fieldTransforms)&&(r.type===0?r.value.isEqual(t.value):r.type!==1||r.data.isEqual(t.data)&&r.fieldMask.isEqual(t.fieldMask))}var We=class extends hr{constructor(t,e,n,i=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}},Xt=class extends hr{constructor(t,e,n,i,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}};function gm(r){let t=new Map;return r.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){let n=r.data.field(e);t.set(e,n)}}),t}function Qd(r,t,e){let n=new Map;U(r.length===e.length);for(let i=0;i<e.length;i++){let s=r[i],a=s.transform,u=t.data.field(s.field);n.set(s.field,ly(a,u,e[i]))}return n}function Wd(r,t,e){let n=new Map;for(let i of r){let s=i.transform,a=e.data.field(i.field);n.set(i.field,cy(s,a,t))}return n}var He=class extends hr{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},Ei=class extends hr{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};var Ai=class{constructor(t,e,n,i){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=i}applyToRemoteDocument(t,e){let n=e.mutationResults;for(let i=0;i<this.mutations.length;i++){let s=this.mutations[i];s.key.isEqual(t.key)&&dy(s,t,n[i])}}applyToLocalView(t,e){for(let n of this.baseMutations)n.key.isEqual(t.key)&&(e=mi(n,t,e,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(t.key)&&(e=mi(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){let n=am();return this.mutations.forEach(i=>{let s=t.get(i.key),a=s.overlayedDocument,u=this.applyToLocalView(a,s.mutatedFields);u=e.has(i.key)?null:u;let c=mm(a,u);c!==null&&n.set(i.key,c),a.isValidDocument()||a.convertToNoDocument(B.min())}),n}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),W())}isEqual(t){return this.batchId===t.batchId&&or(this.mutations,t.mutations,(e,n)=>$d(e,n))&&or(this.baseMutations,t.baseMutations,(e,n)=>$d(e,n))}},bu=class r{constructor(t,e,n,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=i}static from(t,e,n){U(t.mutations.length===n.length);let i=function(){return oy}(),s=t.mutations;for(let a=0;a<s.length;a++)i=i.insert(s[a].key,n[a].version);return new r(t,e,n,i)}};var Si=class{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};var Ru=class{constructor(t,e){this.count=t,this.unchangedNames=e}};var _t,Y;function pm(r){switch(r){default:return q();case P.CANCELLED:case P.UNKNOWN:case P.DEADLINE_EXCEEDED:case P.RESOURCE_EXHAUSTED:case P.INTERNAL:case P.UNAVAILABLE:case P.UNAUTHENTICATED:return!1;case P.INVALID_ARGUMENT:case P.NOT_FOUND:case P.ALREADY_EXISTS:case P.PERMISSION_DENIED:case P.FAILED_PRECONDITION:case P.ABORTED:case P.OUT_OF_RANGE:case P.UNIMPLEMENTED:case P.DATA_LOSS:return!0}}function _m(r){if(r===void 0)return ft("GRPC error has no .code"),P.UNKNOWN;switch(r){case _t.OK:return P.OK;case _t.CANCELLED:return P.CANCELLED;case _t.UNKNOWN:return P.UNKNOWN;case _t.DEADLINE_EXCEEDED:return P.DEADLINE_EXCEEDED;case _t.RESOURCE_EXHAUSTED:return P.RESOURCE_EXHAUSTED;case _t.INTERNAL:return P.INTERNAL;case _t.UNAVAILABLE:return P.UNAVAILABLE;case _t.UNAUTHENTICATED:return P.UNAUTHENTICATED;case _t.INVALID_ARGUMENT:return P.INVALID_ARGUMENT;case _t.NOT_FOUND:return P.NOT_FOUND;case _t.ALREADY_EXISTS:return P.ALREADY_EXISTS;case _t.PERMISSION_DENIED:return P.PERMISSION_DENIED;case _t.FAILED_PRECONDITION:return P.FAILED_PRECONDITION;case _t.ABORTED:return P.ABORTED;case _t.OUT_OF_RANGE:return P.OUT_OF_RANGE;case _t.UNIMPLEMENTED:return P.UNIMPLEMENTED;case _t.DATA_LOSS:return P.DATA_LOSS;default:return q()}}(Y=_t||(_t={}))[Y.OK=0]="OK",Y[Y.CANCELLED=1]="CANCELLED",Y[Y.UNKNOWN=2]="UNKNOWN",Y[Y.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Y[Y.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Y[Y.NOT_FOUND=5]="NOT_FOUND",Y[Y.ALREADY_EXISTS=6]="ALREADY_EXISTS",Y[Y.PERMISSION_DENIED=7]="PERMISSION_DENIED",Y[Y.UNAUTHENTICATED=16]="UNAUTHENTICATED",Y[Y.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Y[Y.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Y[Y.ABORTED=10]="ABORTED",Y[Y.OUT_OF_RANGE=11]="OUT_OF_RANGE",Y[Y.UNIMPLEMENTED=12]="UNIMPLEMENTED",Y[Y.INTERNAL=13]="INTERNAL",Y[Y.UNAVAILABLE=14]="UNAVAILABLE",Y[Y.DATA_LOSS=15]="DATA_LOSS";var Hd=null;function ym(){return new TextEncoder}var my=new Ne([4294967295,4294967295],0);function Jd(r){let t=ym().encode(r),e=new ja;return e.update(t),new Uint8Array(e.digest())}function Yd(r){let t=new DataView(r.buffer),e=t.getUint32(0,!0),n=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new Ne([e,n],0),new Ne([i,s],0)]}var Pu=class r{constructor(t,e,n){if(this.bitmap=t,this.padding=e,this.hashCount=n,e<0||e>=8)throw new gn(`Invalid padding: ${e}`);if(n<0)throw new gn(`Invalid hash count: ${n}`);if(t.length>0&&this.hashCount===0)throw new gn(`Invalid hash count: ${n}`);if(t.length===0&&e!==0)throw new gn(`Invalid padding when bitmap length is 0: ${e}`);this.Ie=8*t.length-e,this.Te=Ne.fromNumber(this.Ie)}Ee(t,e,n){let i=t.add(e.multiply(Ne.fromNumber(n)));return i.compare(my)===1&&(i=new Ne([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(t){return(this.bitmap[Math.floor(t/8)]&1<<t%8)!=0}mightContain(t){if(this.Ie===0)return!1;let e=Jd(t),[n,i]=Yd(e);for(let s=0;s<this.hashCount;s++){let a=this.Ee(n,i,s);if(!this.de(a))return!1}return!0}static create(t,e,n){let i=t%8==0?0:8-t%8,s=new Uint8Array(Math.ceil(t/8)),a=new r(s,i,e);return n.forEach(u=>a.insert(u)),a}insert(t){if(this.Ie===0)return;let e=Jd(t),[n,i]=Yd(e);for(let s=0;s<this.hashCount;s++){let a=this.Ee(n,i,s);this.Ae(a)}}Ae(t){let e=Math.floor(t/8),n=t%8;this.bitmap[e]|=1<<n}},gn=class extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};var bi=class r{constructor(t,e,n,i,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e,n){let i=new Map;return i.set(t,Ri.createSynthesizedTargetChangeForCurrentChange(t,e,n)),new r(B.min(),i,new ot(K),Bt(),W())}},Ri=class r{constructor(t,e,n,i,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e,n){return new r(n,e,W(),W(),W())}};var sr=class{constructor(t,e,n,i){this.Re=t,this.removedTargetIds=e,this.key=n,this.Ve=i}},Ks=class{constructor(t,e){this.targetId=t,this.me=e}},$s=class{constructor(t,e,n=pt.EMPTY_BYTE_STRING,i=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=i}},Qs=class{constructor(){this.fe=0,this.ge=Zd(),this.pe=pt.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(t){t.approximateByteSize()>0&&(this.we=!0,this.pe=t)}ve(){let t=W(),e=W(),n=W();return this.ge.forEach((i,s)=>{switch(s){case 0:t=t.add(i);break;case 2:e=e.add(i);break;case 1:n=n.add(i);break;default:q()}}),new Ri(this.pe,this.ye,t,e,n)}Ce(){this.we=!1,this.ge=Zd()}Fe(t,e){this.we=!0,this.ge=this.ge.insert(t,e)}Me(t){this.we=!0,this.ge=this.ge.remove(t)}xe(){this.fe+=1}Oe(){this.fe-=1,U(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}},Cu=class{constructor(t){this.Le=t,this.Be=new Map,this.ke=Bt(),this.qe=Xd(),this.Qe=new ot(K)}Ke(t){for(let e of t.Re)t.Ve&&t.Ve.isFoundDocument()?this.$e(e,t.Ve):this.Ue(e,t.key,t.Ve);for(let e of t.removedTargetIds)this.Ue(e,t.key,t.Ve)}We(t){this.forEachTarget(t,e=>{let n=this.Ge(e);switch(t.state){case 0:this.ze(e)&&n.De(t.resumeToken);break;case 1:n.Oe(),n.Se||n.Ce(),n.De(t.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(e);break;case 3:this.ze(e)&&(n.Ne(),n.De(t.resumeToken));break;case 4:this.ze(e)&&(this.je(e),n.De(t.resumeToken));break;default:q()}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Be.forEach((n,i)=>{this.ze(i)&&e(i)})}He(t){let e=t.targetId,n=t.me.count,i=this.Je(e);if(i){let s=i.target;if(js(s))if(n===0){let a=new L(s.path);this.Ue(e,a,vt.newNoDocument(a,B.min()))}else U(n===1);else{let a=this.Ye(e);if(a!==n){let u=this.Ze(t),c=u?this.Xe(u,t,a):1;if(c!==0){this.je(e);let d=c===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(e,d)}Hd?.et(function(f,g,_,A,V){var N,x,j,z,O,G;let $={localCacheCount:f,existenceFilterCount:g.count,databaseId:_.database,projectId:_.projectId},Q=g.unchangedNames;return Q&&($.bloomFilter={applied:V===0,hashCount:(N=Q?.hashCount)!==null&&N!==void 0?N:0,bitmapLength:(z=(j=(x=Q?.bits)===null||x===void 0?void 0:x.bitmap)===null||j===void 0?void 0:j.length)!==null&&z!==void 0?z:0,padding:(G=(O=Q?.bits)===null||O===void 0?void 0:O.padding)!==null&&G!==void 0?G:0,mightContain:v=>{var p;return(p=A?.mightContain(v))!==null&&p!==void 0&&p}}),$}(a,t.me,this.Le.tt(),u,c))}}}}Ze(t){let e=t.me.unchangedNames;if(!e||!e.bits)return null;let{bits:{bitmap:n="",padding:i=0},hashCount:s=0}=e,a,u;try{a=ze(n).toUint8Array()}catch(c){if(c instanceof qs)return Jt("Decoding the base64 bloom filter in existence filter failed ("+c.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw c}try{u=new Pu(a,i,s)}catch(c){return Jt(c instanceof gn?"BloomFilter error: ":"Applying bloom filter failed: ",c),null}return u.Ie===0?null:u}Xe(t,e,n){return e.me.count===n-this.nt(t,e.targetId)?0:2}nt(t,e){let n=this.Le.getRemoteKeysForTarget(e),i=0;return n.forEach(s=>{let a=this.Le.tt(),u=`projects/${a.projectId}/databases/${a.database}/documents/${s.path.canonicalString()}`;t.mightContain(u)||(this.Ue(e,s,null),i++)}),i}rt(t){let e=new Map;this.Be.forEach((s,a)=>{let u=this.Je(a);if(u){if(s.current&&js(u.target)){let c=new L(u.target.path);this.ke.get(c)!==null||this.it(a,c)||this.Ue(a,c,vt.newNoDocument(c,t))}s.be&&(e.set(a,s.ve()),s.Ce())}});let n=W();this.qe.forEach((s,a)=>{let u=!0;a.forEachWhile(c=>{let d=this.Je(c);return!d||d.purpose==="TargetPurposeLimboResolution"||(u=!1,!1)}),u&&(n=n.add(s))}),this.ke.forEach((s,a)=>a.setReadTime(t));let i=new bi(t,e,this.Qe,this.ke,n);return this.ke=Bt(),this.qe=Xd(),this.Qe=new ot(K),i}$e(t,e){if(!this.ze(t))return;let n=this.it(t,e.key)?2:0;this.Ge(t).Fe(e.key,n),this.ke=this.ke.insert(e.key,e),this.qe=this.qe.insert(e.key,this.st(e.key).add(t))}Ue(t,e,n){if(!this.ze(t))return;let i=this.Ge(t);this.it(t,e)?i.Fe(e,1):i.Me(e),this.qe=this.qe.insert(e,this.st(e).delete(t)),n&&(this.ke=this.ke.insert(e,n))}removeTarget(t){this.Be.delete(t)}Ye(t){let e=this.Ge(t).ve();return this.Le.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}xe(t){this.Ge(t).xe()}Ge(t){let e=this.Be.get(t);return e||(e=new Qs,this.Be.set(t,e)),e}st(t){let e=this.qe.get(t);return e||(e=new rt(K),this.qe=this.qe.insert(t,e)),e}ze(t){let e=this.Je(t)!==null;return e||k("WatchChangeAggregator","Detected inactive target",t),e}Je(t){let e=this.Be.get(t);return e&&e.Se?null:this.Le.ot(t)}je(t){this.Be.set(t,new Qs),this.Le.getRemoteKeysForTarget(t).forEach(e=>{this.Ue(t,e,null)})}it(t,e){return this.Le.getRemoteKeysForTarget(t).has(e)}};function Xd(){return new ot(L.comparator)}function Zd(){return new ot(L.comparator)}var gy={asc:"ASCENDING",desc:"DESCENDING"},py={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},_y={and:"AND",or:"OR"},xu=class{constructor(t,e){this.databaseId=t,this.useProto3Json=e}};function Du(r,t){return r.useProto3Json||Li(t)?t:{value:t}}function dr(r,t){return r.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function wm(r,t){return r.useProto3Json?t.toBase64():t.toUint8Array()}function yy(r,t){return dr(r,t.toTimestamp())}function gt(r){return U(!!r),B.fromTimestamp(function(e){let n=ye(e);return new ct(n.seconds,n.nanos)}(r))}function al(r,t){return Vu(r,t).canonicalString()}function Vu(r,t){let e=function(i){return new X(["projects",i.projectId,"databases",i.database])}(r).child("documents");return t===void 0?e:e.child(t)}function vm(r){let t=X.fromString(r);return U(xm(t)),t}function Pi(r,t){return al(r.databaseId,t.path)}function se(r,t){let e=vm(t);if(e.get(1)!==r.databaseId.projectId)throw new D(P.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+r.databaseId.projectId);if(e.get(3)!==r.databaseId.database)throw new D(P.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+r.databaseId.database);return new L(Em(e))}function Tm(r,t){return al(r.databaseId,t)}function Im(r){let t=vm(r);return t.length===4?X.emptyPath():Em(t)}function ku(r){return new X(["projects",r.databaseId.projectId,"databases",r.databaseId.database]).canonicalString()}function Em(r){return U(r.length>4&&r.get(4)==="documents"),r.popFirst(5)}function tf(r,t,e){return{name:Pi(r,t),fields:e.value.mapValue.fields}}function Am(r,t,e){let n=se(r,t.name),i=gt(t.updateTime),s=t.createTime?gt(t.createTime):B.min(),a=new Dt({mapValue:{fields:t.fields}}),u=vt.newFoundDocument(n,i,s,a);return e&&u.setHasCommittedMutations(),e?u.setHasCommittedMutations():u}function wy(r,t){return"found"in t?function(n,i){U(!!i.found),i.found.name,i.found.updateTime;let s=se(n,i.found.name),a=gt(i.found.updateTime),u=i.found.createTime?gt(i.found.createTime):B.min(),c=new Dt({mapValue:{fields:i.found.fields}});return vt.newFoundDocument(s,a,u,c)}(r,t):"missing"in t?function(n,i){U(!!i.missing),U(!!i.readTime);let s=se(n,i.missing),a=gt(i.readTime);return vt.newNoDocument(s,a)}(r,t):q()}function vy(r,t){let e;if("targetChange"in t){t.targetChange;let n=function(d){return d==="NO_CHANGE"?0:d==="ADD"?1:d==="REMOVE"?2:d==="CURRENT"?3:d==="RESET"?4:q()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],s=function(d,f){return d.useProto3Json?(U(f===void 0||typeof f=="string"),pt.fromBase64String(f||"")):(U(f===void 0||f instanceof Buffer||f instanceof Uint8Array),pt.fromUint8Array(f||new Uint8Array))}(r,t.targetChange.resumeToken),a=t.targetChange.cause,u=a&&function(d){let f=d.code===void 0?P.UNKNOWN:_m(d.code);return new D(f,d.message||"")}(a);e=new $s(n,i,s,u||null)}else if("documentChange"in t){t.documentChange;let n=t.documentChange;n.document,n.document.name,n.document.updateTime;let i=se(r,n.document.name),s=gt(n.document.updateTime),a=n.document.createTime?gt(n.document.createTime):B.min(),u=new Dt({mapValue:{fields:n.document.fields}}),c=vt.newFoundDocument(i,s,a,u),d=n.targetIds||[],f=n.removedTargetIds||[];e=new sr(d,f,c.key,c)}else if("documentDelete"in t){t.documentDelete;let n=t.documentDelete;n.document;let i=se(r,n.document),s=n.readTime?gt(n.readTime):B.min(),a=vt.newNoDocument(i,s),u=n.removedTargetIds||[];e=new sr([],u,a.key,a)}else if("documentRemove"in t){t.documentRemove;let n=t.documentRemove;n.document;let i=se(r,n.document),s=n.removedTargetIds||[];e=new sr([],s,i,null)}else{if(!("filter"in t))return q();{t.filter;let n=t.filter;n.targetId;let{count:i=0,unchangedNames:s}=n,a=new Ru(i,s),u=n.targetId;e=new Ks(u,a)}}return e}function Ci(r,t){let e;if(t instanceof We)e={update:tf(r,t.key,t.value)};else if(t instanceof He)e={delete:Pi(r,t.key)};else if(t instanceof Xt)e={update:tf(r,t.key,t.data),updateMask:by(t.fieldMask)};else{if(!(t instanceof Ei))return q();e={verify:Pi(r,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(n=>function(s,a){let u=a.transform;if(u instanceof $e)return{fieldPath:a.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(u instanceof we)return{fieldPath:a.field.canonicalString(),appendMissingElements:{values:u.elements}};if(u instanceof ve)return{fieldPath:a.field.canonicalString(),removeAllFromArray:{values:u.elements}};if(u instanceof Qe)return{fieldPath:a.field.canonicalString(),increment:u.Pe};throw q()}(0,n))),t.precondition.isNone||(e.currentDocument=function(i,s){return s.updateTime!==void 0?{updateTime:yy(i,s.updateTime)}:s.exists!==void 0?{exists:s.exists}:q()}(r,t.precondition)),e}function Nu(r,t){let e=t.currentDocument?function(s){return s.updateTime!==void 0?dt.updateTime(gt(s.updateTime)):s.exists!==void 0?dt.exists(s.exists):dt.none()}(t.currentDocument):dt.none(),n=t.updateTransforms?t.updateTransforms.map(i=>function(a,u){let c=null;if("setToServerValue"in u)U(u.setToServerValue==="REQUEST_TIME"),c=new $e;else if("appendMissingElements"in u){let f=u.appendMissingElements.values||[];c=new we(f)}else if("removeAllFromArray"in u){let f=u.removeAllFromArray.values||[];c=new ve(f)}else"increment"in u?c=new Qe(a,u.increment):q();let d=mt.fromServerFormat(u.fieldPath);return new Tn(d,c)}(r,i)):[];if(t.update){t.update.name;let i=se(r,t.update.name),s=new Dt({mapValue:{fields:t.update.fields}});if(t.updateMask){let a=function(c){let d=c.fieldPaths||[];return new Gt(d.map(f=>mt.fromServerFormat(f)))}(t.updateMask);return new Xt(i,s,a,e,n)}return new We(i,s,e,n)}if(t.delete){let i=se(r,t.delete);return new He(i,e)}if(t.verify){let i=se(r,t.verify);return new Ei(i,e)}return q()}function Ty(r,t){return r&&r.length>0?(U(t!==void 0),r.map(e=>function(i,s){let a=i.updateTime?gt(i.updateTime):gt(s);return a.isEqual(B.min())&&(a=gt(s)),new Su(a,i.transformResults||[])}(e,t))):[]}function Sm(r,t){return{documents:[Tm(r,t.path)]}}function bm(r,t){let e={structuredQuery:{}},n=t.path,i;t.collectionGroup!==null?(i=n,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=n.popLast(),e.structuredQuery.from=[{collectionId:n.lastSegment()}]),e.parent=Tm(r,i);let s=function(d){if(d.length!==0)return Cm(et.create(d,"and"))}(t.filters);s&&(e.structuredQuery.where=s);let a=function(d){if(d.length!==0)return d.map(f=>function(_){return{field:Zn(_.field),direction:Ey(_.dir)}}(f))}(t.orderBy);a&&(e.structuredQuery.orderBy=a);let u=Du(r,t.limit);return u!==null&&(e.structuredQuery.limit=u),t.startAt&&(e.structuredQuery.startAt=function(d){return{before:d.inclusive,values:d.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(d){return{before:!d.inclusive,values:d.position}}(t.endAt)),{_t:e,parent:i}}function Rm(r){let t=Im(r.parent),e=r.structuredQuery,n=e.from?e.from.length:0,i=null;if(n>0){U(n===1);let f=e.from[0];f.allDescendants?i=f.collectionId:t=t.child(f.collectionId)}let s=[];e.where&&(s=function(g){let _=Pm(g);return _ instanceof et&&rl(_)?_.getFilters():[_]}(e.where));let a=[];e.orderBy&&(a=function(g){return g.map(_=>function(V){return new wn(tr(V.field),function(x){switch(x){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(V.direction))}(_))}(e.orderBy));let u=null;e.limit&&(u=function(g){let _;return _=typeof g=="object"?g.value:g,Li(_)?null:_}(e.limit));let c=null;e.startAt&&(c=function(g){let _=!!g.before,A=g.values||[];return new ue(A,_)}(e.startAt));let d=null;return e.endAt&&(d=function(g){let _=!g.before,A=g.values||[];return new ue(A,_)}(e.endAt)),em(t,i,a,s,u,"F",c,d)}function Iy(r,t){let e=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return q()}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function Pm(r){return r.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":let n=tr(e.unaryFilter.field);return H.create(n,"==",{doubleValue:NaN});case"IS_NULL":let i=tr(e.unaryFilter.field);return H.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let s=tr(e.unaryFilter.field);return H.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let a=tr(e.unaryFilter.field);return H.create(a,"!=",{nullValue:"NULL_VALUE"});default:return q()}}(r):r.fieldFilter!==void 0?function(e){return H.create(tr(e.fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return q()}}(e.fieldFilter.op),e.fieldFilter.value)}(r):r.compositeFilter!==void 0?function(e){return et.create(e.compositeFilter.filters.map(n=>Pm(n)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return q()}}(e.compositeFilter.op))}(r):q()}function Ey(r){return gy[r]}function Ay(r){return py[r]}function Sy(r){return _y[r]}function Zn(r){return{fieldPath:r.canonicalString()}}function tr(r){return mt.fromServerFormat(r.fieldPath)}function Cm(r){return r instanceof H?function(e){if(e.op==="=="){if(Md(e.value))return{unaryFilter:{field:Zn(e.field),op:"IS_NAN"}};if(Od(e.value))return{unaryFilter:{field:Zn(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(Md(e.value))return{unaryFilter:{field:Zn(e.field),op:"IS_NOT_NAN"}};if(Od(e.value))return{unaryFilter:{field:Zn(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Zn(e.field),op:Ay(e.op),value:e.value}}}(r):r instanceof et?function(e){let n=e.getFilters().map(i=>Cm(i));return n.length===1?n[0]:{compositeFilter:{op:Sy(e.op),filters:n}}}(r):q()}function by(r){let t=[];return r.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function xm(r){return r.length>=4&&r.get(0)==="projects"&&r.get(2)==="databases"}var fr=class r{constructor(t,e,n,i,s=B.min(),a=B.min(),u=pt.EMPTY_BYTE_STRING,c=null){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=a,this.resumeToken=u,this.expectedCount=c}withSequenceNumber(t){return new r(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new r(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new r(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new r(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}};var Ws=class{constructor(t){this.ct=t}};function Ry(r,t){let e;if(t.document)e=Am(r.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let n=L.fromSegments(t.noDocument.path),i=En(t.noDocument.readTime);e=vt.newNoDocument(n,i),t.hasCommittedMutations&&e.setHasCommittedMutations()}else{if(!t.unknownDocument)return q();{let n=L.fromSegments(t.unknownDocument.path),i=En(t.unknownDocument.version);e=vt.newUnknownDocument(n,i)}}return t.readTime&&e.setReadTime(function(i){let s=new ct(i[0],i[1]);return B.fromTimestamp(s)}(t.readTime)),e}function ef(r,t){let e=t.key,n={prefixPath:e.getCollectionPath().popLast().toArray(),collectionGroup:e.collectionGroup,documentId:e.path.lastSegment(),readTime:Hs(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())n.document=function(s,a){return{name:Pi(s,a.key),fields:a.data.value.mapValue.fields,updateTime:dr(s,a.version.toTimestamp()),createTime:dr(s,a.createTime.toTimestamp())}}(r.ct,t);else if(t.isNoDocument())n.noDocument={path:e.path.toArray(),readTime:In(t.version)};else{if(!t.isUnknownDocument())return q();n.unknownDocument={path:e.path.toArray(),version:In(t.version)}}return n}function Hs(r){let t=r.toTimestamp();return[t.seconds,t.nanoseconds]}function In(r){let t=r.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function En(r){let t=new ct(r.seconds,r.nanoseconds);return B.fromTimestamp(t)}function dn(r,t){let e=(t.baseMutations||[]).map(s=>Nu(r.ct,s));for(let s=0;s<t.mutations.length-1;++s){let a=t.mutations[s];if(s+1<t.mutations.length&&t.mutations[s+1].transform!==void 0){let u=t.mutations[s+1];a.updateTransforms=u.transform.fieldTransforms,t.mutations.splice(s+1,1),++s}}let n=t.mutations.map(s=>Nu(r.ct,s)),i=ct.fromMillis(t.localWriteTimeMs);return new Ai(t.batchId,i,e,n)}function hi(r){let t=En(r.readTime),e=r.lastLimboFreeSnapshotVersion!==void 0?En(r.lastLimboFreeSnapshotVersion):B.min(),n;return n=function(s){return s.documents!==void 0}(r.query)?function(s){return U(s.documents.length===1),Mt(Ar(Im(s.documents[0])))}(r.query):function(s){return Mt(Rm(s))}(r.query),new fr(n,r.targetId,"TargetPurposeListen",r.lastListenSequenceNumber,t,e,pt.fromBase64String(r.resumeToken))}function Dm(r,t){let e=In(t.snapshotVersion),n=In(t.lastLimboFreeSnapshotVersion),i;i=js(t.target)?Sm(r.ct,t.target):bm(r.ct,t.target)._t;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:vn(t.target),readTime:e,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:n,query:i}}function ul(r){let t=Rm({parent:r.parent,structuredQuery:r.structuredQuery});return r.limitType==="LAST"?Gs(t,t.limit,"L"):t}function Wa(r,t){return new Si(t.largestBatchId,Nu(r.ct,t.overlayMutation))}function nf(r,t){let e=t.path.lastSegment();return[r,Ot(t.path.popLast()),e]}function rf(r,t,e,n){return{indexId:r,uid:t,sequenceNumber:e,readTime:In(n.readTime),documentKey:Ot(n.documentKey.path),largestBatchId:n.largestBatchId}}var Fu=class{getBundleMetadata(t,e){return sf(t).get(e).next(n=>{if(n)return function(s){return{id:s.bundleId,createTime:En(s.createTime),version:s.version}}(n)})}saveBundleMetadata(t,e){return sf(t).put(function(i){return{bundleId:i.id,createTime:In(gt(i.createTime)),version:i.version}}(e))}getNamedQuery(t,e){return of(t).get(e).next(n=>{if(n)return function(s){return{name:s.name,query:ul(s.bundledQuery),readTime:En(s.readTime)}}(n)})}saveNamedQuery(t,e){return of(t).put(function(i){return{name:i.name,readTime:In(gt(i.readTime)),bundledQuery:i.bundledQuery}}(e))}};function sf(r){return It(r,"bundles")}function of(r){return It(r,"namedQueries")}var Js=class r{constructor(t,e){this.serializer=t,this.userId=e}static lt(t,e){let n=e.uid||"";return new r(t,n)}getOverlay(t,e){return oi(t).get(nf(this.userId,e)).next(n=>n?Wa(this.serializer,n):null)}getOverlays(t,e){let n=re();return b.forEach(e,i=>this.getOverlay(t,i).next(s=>{s!==null&&n.set(i,s)})).next(()=>n)}saveOverlays(t,e,n){let i=[];return n.forEach((s,a)=>{let u=new Si(e,a);i.push(this.ht(t,u))}),b.waitFor(i)}removeOverlaysForBatchId(t,e,n){let i=new Set;e.forEach(a=>i.add(Ot(a.getCollectionPath())));let s=[];return i.forEach(a=>{let u=IDBKeyRange.bound([this.userId,a,n],[this.userId,a,n+1],!1,!0);s.push(oi(t).j("collectionPathOverlayIndex",u))}),b.waitFor(s)}getOverlaysForCollection(t,e,n){let i=re(),s=Ot(e),a=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return oi(t).U("collectionPathOverlayIndex",a).next(u=>{for(let c of u){let d=Wa(this.serializer,c);i.set(d.getKey(),d)}return i})}getOverlaysForCollectionGroup(t,e,n,i){let s=re(),a,u=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return oi(t).J({index:"collectionGroupOverlayIndex",range:u},(c,d,f)=>{let g=Wa(this.serializer,d);s.size()<i||g.largestBatchId===a?(s.set(g.getKey(),g),a=g.largestBatchId):f.done()}).next(()=>s)}ht(t,e){return oi(t).put(function(i,s,a){let[u,c,d]=nf(s,a.mutation.key);return{userId:s,collectionPath:c,documentId:d,collectionGroup:a.mutation.key.getCollectionGroup(),largestBatchId:a.largestBatchId,overlayMutation:Ci(i.ct,a.mutation)}}(this.serializer,this.userId,e))}};function oi(r){return It(r,"documentOverlays")}var Ou=class{Pt(t){return It(t,"globals")}getSessionToken(t){return this.Pt(t).get("sessionToken").next(e=>{let n=e?.value;return n?pt.fromUint8Array(n):pt.EMPTY_BYTE_STRING})}setSessionToken(t,e){return this.Pt(t).put({name:"sessionToken",value:e.toUint8Array()})}};var pe=class{constructor(){}It(t,e){this.Tt(t,e),e.Et()}Tt(t,e){if("nullValue"in t)this.dt(e,5);else if("booleanValue"in t)this.dt(e,10),e.At(t.booleanValue?1:0);else if("integerValue"in t)this.dt(e,15),e.At(at(t.integerValue));else if("doubleValue"in t){let n=at(t.doubleValue);isNaN(n)?this.dt(e,13):(this.dt(e,15),yi(n)?e.At(0):e.At(n))}else if("timestampValue"in t){let n=t.timestampValue;this.dt(e,20),typeof n=="string"&&(n=ye(n)),e.Rt(`${n.seconds||""}`),e.At(n.nanos||0)}else if("stringValue"in t)this.Vt(t.stringValue,e),this.ft(e);else if("bytesValue"in t)this.dt(e,30),e.gt(ze(t.bytesValue)),this.ft(e);else if("referenceValue"in t)this.yt(t.referenceValue,e);else if("geoPointValue"in t){let n=t.geoPointValue;this.dt(e,45),e.At(n.latitude||0),e.At(n.longitude||0)}else"mapValue"in t?Qf(t)?this.dt(e,Number.MAX_SAFE_INTEGER):Vo(t)?this.wt(t.mapValue,e):(this.St(t.mapValue,e),this.ft(e)):"arrayValue"in t?(this.bt(t.arrayValue,e),this.ft(e)):q()}Vt(t,e){this.dt(e,25),this.Dt(t,e)}Dt(t,e){e.Rt(t)}St(t,e){let n=t.fields||{};this.dt(e,55);for(let i of Object.keys(n))this.Vt(i,e),this.Tt(n[i],e)}wt(t,e){var n,i;let s=t.fields||{};this.dt(e,53);let a="value",u=((i=(n=s[a].arrayValue)===null||n===void 0?void 0:n.values)===null||i===void 0?void 0:i.length)||0;this.dt(e,15),e.At(at(u)),this.Vt(a,e),this.Tt(s[a],e)}bt(t,e){let n=t.values||[];this.dt(e,50);for(let i of n)this.Tt(i,e)}yt(t,e){this.dt(e,37),L.fromName(t).path.forEach(n=>{this.dt(e,60),this.Dt(n,e)})}dt(t,e){t.At(e)}ft(t){t.At(2)}};pe.vt=new pe;function Py(r){if(r===0)return 8;let t=0;return!(r>>4)&&(t+=4,r<<=4),!(r>>6)&&(t+=2,r<<=2),!(r>>7)&&(t+=1),t}function af(r){let t=64-function(n){let i=0;for(let s=0;s<8;++s){let a=Py(255&n[s]);if(i+=a,a!==8)break}return i}(r);return Math.ceil(t/8)}var Mu=class{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(t){let e=t[Symbol.iterator](),n=e.next();for(;!n.done;)this.Ft(n.value),n=e.next();this.Mt()}xt(t){let e=t[Symbol.iterator](),n=e.next();for(;!n.done;)this.Ot(n.value),n=e.next();this.Nt()}Lt(t){for(let e of t){let n=e.charCodeAt(0);if(n<128)this.Ft(n);else if(n<2048)this.Ft(960|n>>>6),this.Ft(128|63&n);else if(e<"\uD800"||"\uDBFF"<e)this.Ft(480|n>>>12),this.Ft(128|63&n>>>6),this.Ft(128|63&n);else{let i=e.codePointAt(0);this.Ft(240|i>>>18),this.Ft(128|63&i>>>12),this.Ft(128|63&i>>>6),this.Ft(128|63&i)}}this.Mt()}Bt(t){for(let e of t){let n=e.charCodeAt(0);if(n<128)this.Ot(n);else if(n<2048)this.Ot(960|n>>>6),this.Ot(128|63&n);else if(e<"\uD800"||"\uDBFF"<e)this.Ot(480|n>>>12),this.Ot(128|63&n>>>6),this.Ot(128|63&n);else{let i=e.codePointAt(0);this.Ot(240|i>>>18),this.Ot(128|63&i>>>12),this.Ot(128|63&i>>>6),this.Ot(128|63&i)}}this.Nt()}kt(t){let e=this.qt(t),n=af(e);this.Qt(1+n),this.buffer[this.position++]=255&n;for(let i=e.length-n;i<e.length;++i)this.buffer[this.position++]=255&e[i]}Kt(t){let e=this.qt(t),n=af(e);this.Qt(1+n),this.buffer[this.position++]=~(255&n);for(let i=e.length-n;i<e.length;++i)this.buffer[this.position++]=~(255&e[i])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(t){this.Qt(t.length),this.buffer.set(t,this.position),this.position+=t.length}zt(){return this.buffer.slice(0,this.position)}qt(t){let e=function(s){let a=new DataView(new ArrayBuffer(8));return a.setFloat64(0,s,!1),new Uint8Array(a.buffer)}(t),n=(128&e[0])!=0;e[0]^=n?255:128;for(let i=1;i<e.length;++i)e[i]^=n?255:0;return e}Ft(t){let e=255&t;e===0?(this.Ut(0),this.Ut(255)):e===255?(this.Ut(255),this.Ut(0)):this.Ut(e)}Ot(t){let e=255&t;e===0?(this.Gt(0),this.Gt(255)):e===255?(this.Gt(255),this.Gt(0)):this.Gt(t)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(t){this.Qt(1),this.buffer[this.position++]=t}Gt(t){this.Qt(1),this.buffer[this.position++]=~t}Qt(t){let e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);let i=new Uint8Array(n);i.set(this.buffer),this.buffer=i}},Lu=class{constructor(t){this.jt=t}gt(t){this.jt.Ct(t)}Rt(t){this.jt.Lt(t)}At(t){this.jt.kt(t)}Et(){this.jt.$t()}},qu=class{constructor(t){this.jt=t}gt(t){this.jt.xt(t)}Rt(t){this.jt.Bt(t)}At(t){this.jt.Kt(t)}Et(){this.jt.Wt()}},fn=class{constructor(){this.jt=new Mu,this.Ht=new Lu(this.jt),this.Jt=new qu(this.jt)}seed(t){this.jt.seed(t)}Yt(t){return t===0?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}};var mn=class r{constructor(t,e,n,i){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=i}Zt(){let t=this.directionalValue.length,e=t===0||this.directionalValue[t-1]===255?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new r(this.indexId,this.documentKey,this.arrayValue,n)}};function Fe(r,t){let e=r.indexId-t.indexId;return e!==0?e:(e=uf(r.arrayValue,t.arrayValue),e!==0?e:(e=uf(r.directionalValue,t.directionalValue),e!==0?e:L.comparator(r.documentKey,t.documentKey)))}function uf(r,t){for(let e=0;e<r.length&&e<t.length;++e){let n=r[e]-t[e];if(n!==0)return n}return r.length-t.length}var Ys=class{constructor(t){this.Xt=new rt((e,n)=>mt.comparator(e.field,n.field)),this.collectionId=t.collectionGroup!=null?t.collectionGroup:t.path.lastSegment(),this.en=t.orderBy,this.tn=[];for(let e of t.filters){let n=e;n.isInequality()?this.Xt=this.Xt.add(n):this.tn.push(n)}}get nn(){return this.Xt.size>1}rn(t){if(U(t.collectionGroup===this.collectionId),this.nn)return!1;let e=ou(t);if(e!==void 0&&!this.sn(e))return!1;let n=ln(t),i=new Set,s=0,a=0;for(;s<n.length&&this.sn(n[s]);++s)i=i.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Xt.size>0){let u=this.Xt.getIterator().getNext();if(!i.has(u.field.canonicalString())){let c=n[s];if(!this.on(u,c)||!this._n(this.en[a++],c))return!1}++s}for(;s<n.length;++s){let u=n[s];if(a>=this.en.length||!this._n(this.en[a++],u))return!1}return!0}an(){if(this.nn)return null;let t=new rt(mt.comparator),e=[];for(let n of this.tn)if(!n.field.isKeyField())if(n.op==="array-contains"||n.op==="array-contains-any")e.push(new rr(n.field,2));else{if(t.has(n.field))continue;t=t.add(n.field),e.push(new rr(n.field,0))}for(let n of this.en)n.field.isKeyField()||t.has(n.field)||(t=t.add(n.field),e.push(new rr(n.field,n.dir==="asc"?0:1)));return new ar(ar.UNKNOWN_ID,this.collectionId,e,_i.empty())}sn(t){for(let e of this.tn)if(this.on(e,t))return!0;return!1}on(t,e){if(t===void 0||!t.field.isEqual(e.fieldPath))return!1;let n=t.op==="array-contains"||t.op==="array-contains-any";return e.kind===2===n}_n(t,e){return!!t.field.isEqual(e.fieldPath)&&(e.kind===0&&t.dir==="asc"||e.kind===1&&t.dir==="desc")}};function Vm(r){var t,e;if(U(r instanceof H||r instanceof et),r instanceof H){if(r instanceof Bs){let i=((e=(t=r.value.arrayValue)===null||t===void 0?void 0:t.values)===null||e===void 0?void 0:e.map(s=>H.create(r.field,"==",s)))||[];return et.create(i,"or")}return r}let n=r.filters.map(i=>Vm(i));return et.create(n,r.op)}function Cy(r){if(r.getFilters().length===0)return[];let t=ju(Vm(r));return U(km(t)),Uu(t)||Bu(t)?[t]:t.getFilters()}function Uu(r){return r instanceof H}function Bu(r){return r instanceof et&&rl(r)}function km(r){return Uu(r)||Bu(r)||function(e){if(e instanceof et&&mu(e)){for(let n of e.getFilters())if(!Uu(n)&&!Bu(n))return!1;return!0}return!1}(r)}function ju(r){if(U(r instanceof H||r instanceof et),r instanceof H)return r;if(r.filters.length===1)return ju(r.filters[0]);let t=r.filters.map(n=>ju(n)),e=et.create(t,r.op);return e=Xs(e),km(e)?e:(U(e instanceof et),U(cr(e)),U(e.filters.length>1),e.filters.reduce((n,i)=>cl(n,i)))}function cl(r,t){let e;return U(r instanceof H||r instanceof et),U(t instanceof H||t instanceof et),e=r instanceof H?t instanceof H?function(i,s){return et.create([i,s],"and")}(r,t):cf(r,t):t instanceof H?cf(t,r):function(i,s){if(U(i.filters.length>0&&s.filters.length>0),cr(i)&&cr(s))return Xf(i,s.getFilters());let a=mu(i)?i:s,u=mu(i)?s:i,c=a.filters.map(d=>cl(d,u));return et.create(c,"or")}(r,t),Xs(e)}function cf(r,t){if(cr(t))return Xf(t,r.getFilters());{let e=t.filters.map(n=>cl(r,n));return et.create(e,"or")}}function Xs(r){if(U(r instanceof H||r instanceof et),r instanceof H)return r;let t=r.getFilters();if(t.length===1)return Xs(t[0]);if(Jf(r))return r;let e=t.map(i=>Xs(i)),n=[];return e.forEach(i=>{i instanceof H?n.push(i):i instanceof et&&(i.op===r.op?n.push(...i.filters):n.push(i))}),n.length===1?n[0]:et.create(n,r.op)}var zu=class{constructor(){this.un=new xi}addToCollectionParentIndex(t,e){return this.un.add(e),b.resolve()}getCollectionParents(t,e){return b.resolve(this.un.getEntries(e))}addFieldIndex(t,e){return b.resolve()}deleteFieldIndex(t,e){return b.resolve()}deleteAllFieldIndexes(t){return b.resolve()}createTargetIndexes(t,e){return b.resolve()}getDocumentsMatchingTarget(t,e){return b.resolve(null)}getIndexType(t,e){return b.resolve(0)}getFieldIndexes(t,e){return b.resolve([])}getNextCollectionGroupToUpdate(t){return b.resolve(null)}getMinOffset(t,e){return b.resolve($t.min())}getMinOffsetFromCollectionGroup(t,e){return b.resolve($t.min())}updateCollectionGroup(t,e,n){return b.resolve()}updateIndexEntries(t,e){return b.resolve()}},xi=class{constructor(){this.index={}}add(t){let e=t.lastSegment(),n=t.popLast(),i=this.index[e]||new rt(X.comparator),s=!i.has(n);return this.index[e]=i.add(n),s}has(t){let e=t.lastSegment(),n=t.popLast(),i=this.index[e];return i&&i.has(n)}getEntries(t){return(this.index[t]||new rt(X.comparator)).toArray()}};var As=new Uint8Array(0),Gu=class{constructor(t,e){this.databaseId=e,this.cn=new xi,this.ln=new ce(n=>vn(n),(n,i)=>qi(n,i)),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.cn.has(e)){let n=e.lastSegment(),i=e.popLast();t.addOnCommittedListener(()=>{this.cn.add(e)});let s={collectionId:n,parent:Ot(i)};return lf(t).put(s)}return b.resolve()}getCollectionParents(t,e){let n=[],i=IDBKeyRange.bound([e,""],[Ff(e),""],!1,!0);return lf(t).U(i).next(s=>{for(let a of s){if(a.collectionId!==e)break;n.push(ne(a.parent))}return n})}addFieldIndex(t,e){let n=ai(t),i=function(u){return{indexId:u.indexId,collectionGroup:u.collectionGroup,fields:u.fields.map(c=>[c.fieldPath.canonicalString(),c.kind])}}(e);delete i.indexId;let s=n.add(i);if(e.indexState){let a=Hn(t);return s.next(u=>{a.put(rf(u,this.uid,e.indexState.sequenceNumber,e.indexState.offset))})}return s.next()}deleteFieldIndex(t,e){let n=ai(t),i=Hn(t),s=Wn(t);return n.delete(e.indexId).next(()=>i.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))}deleteAllFieldIndexes(t){let e=ai(t),n=Wn(t),i=Hn(t);return e.j().next(()=>n.j()).next(()=>i.j())}createTargetIndexes(t,e){return b.forEach(this.hn(e),n=>this.getIndexType(t,n).next(i=>{if(i===0||i===1){let s=new Ys(n).an();if(s!=null)return this.addFieldIndex(t,s)}}))}getDocumentsMatchingTarget(t,e){let n=Wn(t),i=!0,s=new Map;return b.forEach(this.hn(e),a=>this.Pn(t,a).next(u=>{i&&(i=!!u),s.set(a,u)})).next(()=>{if(i){let a=W(),u=[];return b.forEach(s,(c,d)=>{k("IndexedDbIndexManager",`Using index ${function(O){return`id=${O.indexId}|cg=${O.collectionGroup}|f=${O.fields.map(G=>`${G.fieldPath}:${G.kind}`).join(",")}`}(c)} to execute ${vn(e)}`);let f=function(O,G){let $=ou(G);if($===void 0)return null;for(let Q of zs(O,$.fieldPath))switch(Q.op){case"array-contains-any":return Q.value.arrayValue.values||[];case"array-contains":return[Q.value]}return null}(d,c),g=function(O,G){let $=new Map;for(let Q of ln(G))for(let v of zs(O,Q.fieldPath))switch(v.op){case"==":case"in":$.set(Q.fieldPath.canonicalString(),v.value);break;case"not-in":case"!=":return $.set(Q.fieldPath.canonicalString(),v.value),Array.from($.values())}return null}(d,c),_=function(O,G){let $=[],Q=!0;for(let v of ln(G)){let p=v.kind===0?jd(O,v.fieldPath,O.startAt):zd(O,v.fieldPath,O.startAt);$.push(p.value),Q&&(Q=p.inclusive)}return new ue($,Q)}(d,c),A=function(O,G){let $=[],Q=!0;for(let v of ln(G)){let p=v.kind===0?zd(O,v.fieldPath,O.endAt):jd(O,v.fieldPath,O.endAt);$.push(p.value),Q&&(Q=p.inclusive)}return new ue($,Q)}(d,c),V=this.In(c,d,_),N=this.In(c,d,A),x=this.Tn(c,d,g),j=this.En(c.indexId,f,V,_.inclusive,N,A.inclusive,x);return b.forEach(j,z=>n.G(z,e.limit).next(O=>{O.forEach(G=>{let $=L.fromSegments(G.documentKey);a.has($)||(a=a.add($),u.push($))})}))}).next(()=>u)}return b.resolve(null)})}hn(t){let e=this.ln.get(t);return e||(t.filters.length===0?e=[t]:e=Cy(et.create(t.filters,"and")).map(n=>Eu(t.path,t.collectionGroup,t.orderBy,n.getFilters(),t.limit,t.startAt,t.endAt)),this.ln.set(t,e),e)}En(t,e,n,i,s,a,u){let c=(e!=null?e.length:1)*Math.max(n.length,s.length),d=c/(e!=null?e.length:1),f=[];for(let g=0;g<c;++g){let _=e?this.dn(e[g/d]):As,A=this.An(t,_,n[g%d],i),V=this.Rn(t,_,s[g%d],a),N=u.map(x=>this.An(t,_,x,!0));f.push(...this.createRange(A,V,N))}return f}An(t,e,n,i){let s=new mn(t,L.empty(),e,n);return i?s:s.Zt()}Rn(t,e,n,i){let s=new mn(t,L.empty(),e,n);return i?s.Zt():s}Pn(t,e){let n=new Ys(e),i=e.collectionGroup!=null?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,i).next(s=>{let a=null;for(let u of s)n.rn(u)&&(!a||u.fields.length>a.fields.length)&&(a=u);return a})}getIndexType(t,e){let n=2,i=this.hn(e);return b.forEach(i,s=>this.Pn(t,s).next(a=>{a?n!==0&&a.fields.length<function(c){let d=new rt(mt.comparator),f=!1;for(let g of c.filters)for(let _ of g.getFlattenedFilters())_.field.isKeyField()||(_.op==="array-contains"||_.op==="array-contains-any"?f=!0:d=d.add(_.field));for(let g of c.orderBy)g.field.isKeyField()||(d=d.add(g.field));return d.size+(f?1:0)}(s)&&(n=1):n=0})).next(()=>function(a){return a.limit!==null}(e)&&i.length>1&&n===2?1:n)}Vn(t,e){let n=new fn;for(let i of ln(t)){let s=e.data.field(i.fieldPath);if(s==null)return null;let a=n.Yt(i.kind);pe.vt.It(s,a)}return n.zt()}dn(t){let e=new fn;return pe.vt.It(t,e.Yt(0)),e.zt()}mn(t,e){let n=new fn;return pe.vt.It(yn(this.databaseId,e),n.Yt(function(s){let a=ln(s);return a.length===0?0:a[a.length-1].kind}(t))),n.zt()}Tn(t,e,n){if(n===null)return[];let i=[];i.push(new fn);let s=0;for(let a of ln(t)){let u=n[s++];for(let c of i)if(this.fn(e,a.fieldPath)&&Ii(u))i=this.gn(i,a,u);else{let d=c.Yt(a.kind);pe.vt.It(u,d)}}return this.pn(i)}In(t,e,n){return this.Tn(t,e,n.position)}pn(t){let e=[];for(let n=0;n<t.length;++n)e[n]=t[n].zt();return e}gn(t,e,n){let i=[...t],s=[];for(let a of n.arrayValue.values||[])for(let u of i){let c=new fn;c.seed(u.zt()),pe.vt.It(a,c.Yt(e.kind)),s.push(c)}return s}fn(t,e){return!!t.filters.find(n=>n instanceof H&&n.field.isEqual(e)&&(n.op==="in"||n.op==="not-in"))}getFieldIndexes(t,e){let n=ai(t),i=Hn(t);return(e?n.U("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.U()).next(s=>{let a=[];return b.forEach(s,u=>i.get([u.indexId,this.uid]).next(c=>{a.push(function(f,g){let _=g?new _i(g.sequenceNumber,new $t(En(g.readTime),new L(ne(g.documentKey)),g.largestBatchId)):_i.empty(),A=f.fields.map(([V,N])=>new rr(mt.fromServerFormat(V),N));return new ar(f.indexId,f.collectionGroup,A,_)}(u,c))})).next(()=>a)})}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next(e=>e.length===0?null:(e.sort((n,i)=>{let s=n.indexState.sequenceNumber-i.indexState.sequenceNumber;return s!==0?s:K(n.collectionGroup,i.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(t,e,n){let i=ai(t),s=Hn(t);return this.yn(t).next(a=>i.U("collectionGroupIndex",IDBKeyRange.bound(e,e)).next(u=>b.forEach(u,c=>s.put(rf(c.indexId,this.uid,a,n)))))}updateIndexEntries(t,e){let n=new Map;return b.forEach(e,(i,s)=>{let a=n.get(i.collectionGroup);return(a?b.resolve(a):this.getFieldIndexes(t,i.collectionGroup)).next(u=>(n.set(i.collectionGroup,u),b.forEach(u,c=>this.wn(t,i,c).next(d=>{let f=this.Sn(s,c);return d.isEqual(f)?b.resolve():this.bn(t,s,c,d,f)}))))})}Dn(t,e,n,i){return Wn(t).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.mn(n,e.key),documentKey:e.key.path.toArray()})}vn(t,e,n,i){return Wn(t).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.mn(n,e.key),e.key.path.toArray()])}wn(t,e,n){let i=Wn(t),s=new rt(Fe);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.mn(n,e)])},(a,u)=>{s=s.add(new mn(n.indexId,e,u.arrayValue,u.directionalValue))}).next(()=>s)}Sn(t,e){let n=new rt(Fe),i=this.Vn(e,t);if(i==null)return n;let s=ou(e);if(s!=null){let a=t.data.field(s.fieldPath);if(Ii(a))for(let u of a.arrayValue.values||[])n=n.add(new mn(e.indexId,t.key,this.dn(u),i))}else n=n.add(new mn(e.indexId,t.key,As,i));return n}bn(t,e,n,i,s){k("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);let a=[];return function(c,d,f,g,_){let A=c.getIterator(),V=d.getIterator(),N=Qn(A),x=Qn(V);for(;N||x;){let j=!1,z=!1;if(N&&x){let O=f(N,x);O<0?z=!0:O>0&&(j=!0)}else N!=null?z=!0:j=!0;j?(g(x),x=Qn(V)):z?(_(N),N=Qn(A)):(N=Qn(A),x=Qn(V))}}(i,s,Fe,u=>{a.push(this.Dn(t,e,n,u))},u=>{a.push(this.vn(t,e,n,u))}),b.waitFor(a)}yn(t){let e=1;return Hn(t).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(n,i,s)=>{s.done(),e=i.sequenceNumber+1}).next(()=>e)}createRange(t,e,n){n=n.sort((a,u)=>Fe(a,u)).filter((a,u,c)=>!u||Fe(a,c[u-1])!==0);let i=[];i.push(t);for(let a of n){let u=Fe(a,t),c=Fe(a,e);if(u===0)i[0]=t.Zt();else if(u>0&&c<0)i.push(a),i.push(a.Zt());else if(c>0)break}i.push(e);let s=[];for(let a=0;a<i.length;a+=2){if(this.Cn(i[a],i[a+1]))return[];let u=[i[a].indexId,this.uid,i[a].arrayValue,i[a].directionalValue,As,[]],c=[i[a+1].indexId,this.uid,i[a+1].arrayValue,i[a+1].directionalValue,As,[]];s.push(IDBKeyRange.bound(u,c))}return s}Cn(t,e){return Fe(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(hf)}getMinOffset(t,e){return b.mapArray(this.hn(e),n=>this.Pn(t,n).next(i=>i||q())).next(hf)}};function lf(r){return It(r,"collectionParents")}function Wn(r){return It(r,"indexEntries")}function ai(r){return It(r,"indexConfiguration")}function Hn(r){return It(r,"indexState")}function hf(r){U(r.length!==0);let t=r[0].indexState.offset,e=t.largestBatchId;for(let n=1;n<r.length;n++){let i=r[n].indexState.offset;Zc(i,t)<0&&(t=i),e<i.largestBatchId&&(e=i.largestBatchId)}return new $t(t.readTime,t.documentKey,e)}var df={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Kt=class r{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new r(t,r.DEFAULT_COLLECTION_PERCENTILE,r.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};function Nm(r,t,e){let n=r.store("mutations"),i=r.store("documentMutations"),s=[],a=IDBKeyRange.only(e.batchId),u=0,c=n.J({range:a},(f,g,_)=>(u++,_.delete()));s.push(c.next(()=>{U(u===1)}));let d=[];for(let f of e.mutations){let g=Bf(t,f.key.path,e.batchId);s.push(i.delete(g)),d.push(f.key)}return b.waitFor(s).next(()=>d)}function Zs(r){if(!r)return 0;let t;if(r.document)t=r.document;else if(r.unknownDocument)t=r.unknownDocument;else{if(!r.noDocument)throw q();t=r.noDocument}return JSON.stringify(t).length}Kt.DEFAULT_COLLECTION_PERCENTILE=10,Kt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Kt.DEFAULT=new Kt(41943040,Kt.DEFAULT_COLLECTION_PERCENTILE,Kt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Kt.DISABLED=new Kt(-1,0,0);var to=class r{constructor(t,e,n,i){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=i,this.Fn={}}static lt(t,e,n,i){U(t.uid!=="");let s=t.isAuthenticated()?t.uid:"";return new r(s,e,n,i)}checkEmpty(t){let e=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Oe(t).J({index:"userMutationsIndex",range:n},(i,s,a)=>{e=!1,a.done()}).next(()=>e)}addMutationBatch(t,e,n,i){let s=er(t),a=Oe(t);return a.add({}).next(u=>{U(typeof u=="number");let c=new Ai(u,e,n,i),d=function(A,V,N){let x=N.baseMutations.map(z=>Ci(A.ct,z)),j=N.mutations.map(z=>Ci(A.ct,z));return{userId:V,batchId:N.batchId,localWriteTimeMs:N.localWriteTime.toMillis(),baseMutations:x,mutations:j}}(this.serializer,this.userId,c),f=[],g=new rt((_,A)=>K(_.canonicalString(),A.canonicalString()));for(let _ of i){let A=Bf(this.userId,_.key.path,u);g=g.add(_.key.path.popLast()),f.push(a.put(d)),f.push(s.put(A,F_))}return g.forEach(_=>{f.push(this.indexManager.addToCollectionParentIndex(t,_))}),t.addOnCommittedListener(()=>{this.Fn[u]=c.keys()}),b.waitFor(f).next(()=>c)})}lookupMutationBatch(t,e){return Oe(t).get(e).next(n=>n?(U(n.userId===this.userId),dn(this.serializer,n)):null)}Mn(t,e){return this.Fn[e]?b.resolve(this.Fn[e]):this.lookupMutationBatch(t,e).next(n=>{if(n){let i=n.keys();return this.Fn[e]=i,i}return null})}getNextMutationBatchAfterBatchId(t,e){let n=e+1,i=IDBKeyRange.lowerBound([this.userId,n]),s=null;return Oe(t).J({index:"userMutationsIndex",range:i},(a,u,c)=>{u.userId===this.userId&&(U(u.batchId>=n),s=dn(this.serializer,u)),c.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(t){let e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return Oe(t).J({index:"userMutationsIndex",range:e,reverse:!0},(i,s,a)=>{n=s.batchId,a.done()}).next(()=>n)}getAllMutationBatches(t){let e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Oe(t).U("userMutationsIndex",e).next(n=>n.map(i=>dn(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(t,e){let n=Ps(this.userId,e.path),i=IDBKeyRange.lowerBound(n),s=[];return er(t).J({range:i},(a,u,c)=>{let[d,f,g]=a,_=ne(f);if(d===this.userId&&e.path.isEqual(_))return Oe(t).get(g).next(A=>{if(!A)throw q();U(A.userId===this.userId),s.push(dn(this.serializer,A))});c.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new rt(K),i=[];return e.forEach(s=>{let a=Ps(this.userId,s.path),u=IDBKeyRange.lowerBound(a),c=er(t).J({range:u},(d,f,g)=>{let[_,A,V]=d,N=ne(A);_===this.userId&&s.path.isEqual(N)?n=n.add(V):g.done()});i.push(c)}),b.waitFor(i).next(()=>this.xn(t,n))}getAllMutationBatchesAffectingQuery(t,e){let n=e.path,i=n.length+1,s=Ps(this.userId,n),a=IDBKeyRange.lowerBound(s),u=new rt(K);return er(t).J({range:a},(c,d,f)=>{let[g,_,A]=c,V=ne(_);g===this.userId&&n.isPrefixOf(V)?V.length===i&&(u=u.add(A)):f.done()}).next(()=>this.xn(t,u))}xn(t,e){let n=[],i=[];return e.forEach(s=>{i.push(Oe(t).get(s).next(a=>{if(a===null)throw q();U(a.userId===this.userId),n.push(dn(this.serializer,a))}))}),b.waitFor(i).next(()=>n)}removeMutationBatch(t,e){return Nm(t._e,this.userId,e).next(n=>(t.addOnCommittedListener(()=>{this.On(e.batchId)}),b.forEach(n,i=>this.referenceDelegate.markPotentiallyOrphaned(t,i))))}On(t){delete this.Fn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next(e=>{if(!e)return b.resolve();let n=IDBKeyRange.lowerBound(function(a){return[a]}(this.userId)),i=[];return er(t).J({range:n},(s,a,u)=>{if(s[0]===this.userId){let c=ne(s[1]);i.push(c)}else u.done()}).next(()=>{U(i.length===0)})})}containsKey(t,e){return Fm(t,this.userId,e)}Nn(t){return Om(t).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}};function Fm(r,t,e){let n=Ps(t,e.path),i=n[1],s=IDBKeyRange.lowerBound(n),a=!1;return er(r).J({range:s,H:!0},(u,c,d)=>{let[f,g,_]=u;f===t&&g===i&&(a=!0),d.done()}).next(()=>a)}function Oe(r){return It(r,"mutations")}function er(r){return It(r,"documentMutations")}function Om(r){return It(r,"mutationQueues")}var mr=class r{constructor(t){this.Ln=t}next(){return this.Ln+=2,this.Ln}static Bn(){return new r(0)}static kn(){return new r(-1)}};var Ku=class{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.qn(t).next(e=>{let n=new mr(e.highestTargetId);return e.highestTargetId=n.next(),this.Qn(t,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(t){return this.qn(t).next(e=>B.fromTimestamp(new ct(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(t){return this.qn(t).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,e,n){return this.qn(t).next(i=>(i.highestListenSequenceNumber=e,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),this.Qn(t,i)))}addTargetData(t,e){return this.Kn(t,e).next(()=>this.qn(t).next(n=>(n.targetCount+=1,this.$n(e,n),this.Qn(t,n))))}updateTargetData(t,e){return this.Kn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Jn(t).delete(e.targetId)).next(()=>this.qn(t)).next(n=>(U(n.targetCount>0),n.targetCount-=1,this.Qn(t,n)))}removeTargets(t,e,n){let i=0,s=[];return Jn(t).J((a,u)=>{let c=hi(u);c.sequenceNumber<=e&&n.get(c.targetId)===null&&(i++,s.push(this.removeTargetData(t,c)))}).next(()=>b.waitFor(s)).next(()=>i)}forEachTarget(t,e){return Jn(t).J((n,i)=>{let s=hi(i);e(s)})}qn(t){return ff(t).get("targetGlobalKey").next(e=>(U(e!==null),e))}Qn(t,e){return ff(t).put("targetGlobalKey",e)}Kn(t,e){return Jn(t).put(Dm(this.serializer,e))}$n(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.qn(t).next(e=>e.targetCount)}getTargetData(t,e){let n=vn(e),i=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),s=null;return Jn(t).J({range:i,index:"queryTargetsIndex"},(a,u,c)=>{let d=hi(u);qi(e,d.target)&&(s=d,c.done())}).next(()=>s)}addMatchingKeys(t,e,n){let i=[],s=Me(t);return e.forEach(a=>{let u=Ot(a.path);i.push(s.put({targetId:n,path:u})),i.push(this.referenceDelegate.addReference(t,n,a))}),b.waitFor(i)}removeMatchingKeys(t,e,n){let i=Me(t);return b.forEach(e,s=>{let a=Ot(s.path);return b.waitFor([i.delete([n,a]),this.referenceDelegate.removeReference(t,n,s)])})}removeMatchingKeysForTargetId(t,e){let n=Me(t),i=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(i)}getMatchingKeysForTargetId(t,e){let n=IDBKeyRange.bound([e],[e+1],!1,!0),i=Me(t),s=W();return i.J({range:n,H:!0},(a,u,c)=>{let d=ne(a[1]),f=new L(d);s=s.add(f)}).next(()=>s)}containsKey(t,e){let n=Ot(e.path),i=IDBKeyRange.bound([n],[Ff(n)],!1,!0),s=0;return Me(t).J({index:"documentTargetsIndex",H:!0,range:i},([a,u],c,d)=>{a!==0&&(s++,d.done())}).next(()=>s>0)}ot(t,e){return Jn(t).get(e).next(n=>n?hi(n):null)}};function Jn(r){return It(r,"targets")}function ff(r){return It(r,"targetGlobal")}function Me(r){return It(r,"targetDocuments")}function mf([r,t],[e,n]){let i=K(r,e);return i===0?K(t,n):i}var $u=class{constructor(t){this.Un=t,this.buffer=new rt(mf),this.Wn=0}Gn(){return++this.Wn}zn(t){let e=[t,this.Gn()];if(this.buffer.size<this.Un)this.buffer=this.buffer.add(e);else{let n=this.buffer.last();mf(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}}get maxValue(){return this.buffer.last()[0]}},Qu=class{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.jn=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Hn(6e4)}stop(){this.jn&&(this.jn.cancel(),this.jn=null)}get started(){return this.jn!==null}Hn(t){k("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.jn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,()=>C(this,null,function*(){this.jn=null;try{yield this.localStore.collectGarbage(this.garbageCollector)}catch(e){Xe(e)?k("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):yield Ye(e)}yield this.Hn(3e5)}))}},Wu=class{constructor(t,e){this.Jn=t,this.params=e}calculateTargetCount(t,e){return this.Jn.Yn(t).next(n=>Math.floor(e/100*n))}nthSequenceNumber(t,e){if(e===0)return b.resolve(zt.oe);let n=new $u(e);return this.Jn.forEachTarget(t,i=>n.zn(i.sequenceNumber)).next(()=>this.Jn.Zn(t,i=>n.zn(i))).next(()=>n.maxValue)}removeTargets(t,e,n){return this.Jn.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.Jn.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(k("LruGarbageCollector","Garbage collection skipped; disabled"),b.resolve(df)):this.getCacheSize(t).next(n=>n<this.params.cacheSizeCollectionThreshold?(k("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),df):this.Xn(t,e))}getCacheSize(t){return this.Jn.getCacheSize(t)}Xn(t,e){let n,i,s,a,u,c,d,f=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(g=>(g>this.params.maximumSequenceNumbersToCollect?(k("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${g}`),i=this.params.maximumSequenceNumbersToCollect):i=g,a=Date.now(),this.nthSequenceNumber(t,i))).next(g=>(n=g,u=Date.now(),this.removeTargets(t,n,e))).next(g=>(s=g,c=Date.now(),this.removeOrphanedDocuments(t,n))).next(g=>(d=Date.now(),Yn()<=ee.DEBUG&&k("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${a-f}ms
	Determined least recently used ${i} in `+(u-a)+`ms
	Removed ${s} targets in `+(c-u)+`ms
	Removed ${g} documents in `+(d-c)+`ms
Total Duration: ${d-f}ms`),b.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:g})))}};function xy(r,t){return new Wu(r,t)}var Hu=class{constructor(t,e){this.db=t,this.garbageCollector=xy(this,e)}Yn(t){let e=this.er(t);return this.db.getTargetCache().getTargetCount(t).next(n=>e.next(i=>n+i))}er(t){let e=0;return this.Zn(t,n=>{e++}).next(()=>e)}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Zn(t,e){return this.tr(t,(n,i)=>e(i))}addReference(t,e,n){return Ss(t,n)}removeReference(t,e,n){return Ss(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Ss(t,e)}nr(t,e){return function(i,s){let a=!1;return Om(i).Y(u=>Fm(i,u,s).next(c=>(c&&(a=!0),b.resolve(!c)))).next(()=>a)}(t,e)}removeOrphanedDocuments(t,e){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],s=0;return this.tr(t,(a,u)=>{if(u<=e){let c=this.nr(t,a).next(d=>{if(!d)return s++,n.getEntry(t,a).next(()=>(n.removeEntry(a,B.min()),Me(t).delete(function(g){return[0,Ot(g.path)]}(a))))});i.push(c)}}).next(()=>b.waitFor(i)).next(()=>n.apply(t)).next(()=>s)}removeTarget(t,e){let n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Ss(t,e)}tr(t,e){let n=Me(t),i,s=zt.oe;return n.J({index:"documentTargetsIndex"},([a,u],{path:c,sequenceNumber:d})=>{a===0?(s!==zt.oe&&e(new L(ne(i)),s),s=d,i=c):s=zt.oe}).next(()=>{s!==zt.oe&&e(new L(ne(i)),s)})}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}};function Ss(r,t){return Me(r).put(function(n,i){return{targetId:0,path:Ot(n.path),sequenceNumber:i}}(t,r.currentSequenceNumber))}var eo=class{constructor(){this.changes=new ce(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,vt.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();let n=this.changes.get(e);return n!==void 0?b.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}};var Ju=class{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return cn(t).put(n)}removeEntry(t,e,n){return cn(t).delete(function(s,a){let u=s.path.toArray();return[u.slice(0,u.length-2),u[u.length-2],Hs(a),u[u.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next(n=>(n.byteSize+=e,this.rr(t,n)))}getEntry(t,e){let n=vt.newInvalidDocument(e);return cn(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(ui(e))},(i,s)=>{n=this.ir(e,s)}).next(()=>n)}sr(t,e){let n={size:0,document:vt.newInvalidDocument(e)};return cn(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(ui(e))},(i,s)=>{n={document:this.ir(e,s),size:Zs(s)}}).next(()=>n)}getEntries(t,e){let n=Bt();return this._r(t,e,(i,s)=>{let a=this.ir(i,s);n=n.insert(i,a)}).next(()=>n)}ar(t,e){let n=Bt(),i=new ot(L.comparator);return this._r(t,e,(s,a)=>{let u=this.ir(s,a);n=n.insert(s,u),i=i.insert(s,Zs(a))}).next(()=>({documents:n,ur:i}))}_r(t,e,n){if(e.isEmpty())return b.resolve();let i=new rt(_f);e.forEach(c=>i=i.add(c));let s=IDBKeyRange.bound(ui(i.first()),ui(i.last())),a=i.getIterator(),u=a.getNext();return cn(t).J({index:"documentKeyIndex",range:s},(c,d,f)=>{let g=L.fromSegments([...d.prefixPath,d.collectionGroup,d.documentId]);for(;u&&_f(u,g)<0;)n(u,null),u=a.getNext();u&&u.isEqual(g)&&(n(u,d),u=a.hasNext()?a.getNext():null),u?f.$(ui(u)):f.done()}).next(()=>{for(;u;)n(u,null),u=a.hasNext()?a.getNext():null})}getDocumentsMatchingQuery(t,e,n,i,s){let a=e.path,u=[a.popLast().toArray(),a.lastSegment(),Hs(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],c=[a.popLast().toArray(),a.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return cn(t).U(IDBKeyRange.bound(u,c,!0)).next(d=>{s?.incrementDocumentReadCount(d.length);let f=Bt();for(let g of d){let _=this.ir(L.fromSegments(g.prefixPath.concat(g.collectionGroup,g.documentId)),g);_.isFoundDocument()&&(Bi(e,_)||i.has(_.key))&&(f=f.insert(_.key,_))}return f})}getAllFromCollectionGroup(t,e,n,i){let s=Bt(),a=pf(e,n),u=pf(e,$t.max());return cn(t).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(a,u,!0)},(c,d,f)=>{let g=this.ir(L.fromSegments(d.prefixPath.concat(d.collectionGroup,d.documentId)),d);s=s.insert(g.key,g),s.size===i&&f.done()}).next(()=>s)}newChangeBuffer(t){return new Yu(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next(e=>e.byteSize)}getMetadata(t){return gf(t).get("remoteDocumentGlobalKey").next(e=>(U(!!e),e))}rr(t,e){return gf(t).put("remoteDocumentGlobalKey",e)}ir(t,e){if(e){let n=Ry(this.serializer,e);if(!(n.isNoDocument()&&n.version.isEqual(B.min())))return n}return vt.newInvalidDocument(t)}};function Mm(r){return new Ju(r)}var Yu=class extends eo{constructor(t,e){super(),this.cr=t,this.trackRemovals=e,this.lr=new ce(n=>n.toString(),(n,i)=>n.isEqual(i))}applyChanges(t){let e=[],n=0,i=new rt((s,a)=>K(s.canonicalString(),a.canonicalString()));return this.changes.forEach((s,a)=>{let u=this.lr.get(s);if(e.push(this.cr.removeEntry(t,s,u.readTime)),a.isValidDocument()){let c=ef(this.cr.serializer,a);i=i.add(s.path.popLast());let d=Zs(c);n+=d-u.size,e.push(this.cr.addEntry(t,s,c))}else if(n-=u.size,this.trackRemovals){let c=ef(this.cr.serializer,a.convertToNoDocument(B.min()));e.push(this.cr.addEntry(t,s,c))}}),i.forEach(s=>{e.push(this.cr.indexManager.addToCollectionParentIndex(t,s))}),e.push(this.cr.updateMetadata(t,n)),b.waitFor(e)}getFromCache(t,e){return this.cr.sr(t,e).next(n=>(this.lr.set(e,{size:n.size,readTime:n.document.readTime}),n.document))}getAllFromCache(t,e){return this.cr.ar(t,e).next(({documents:n,ur:i})=>(i.forEach((s,a)=>{this.lr.set(s,{size:a,readTime:n.get(s).readTime})}),n))}};function gf(r){return It(r,"remoteDocumentGlobal")}function cn(r){return It(r,"remoteDocumentsV14")}function ui(r){let t=r.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function pf(r,t){let e=t.documentKey.path.toArray();return[r,Hs(t.readTime),e.slice(0,e.length-2),e.length>0?e[e.length-1]:""]}function _f(r,t){let e=r.path.toArray(),n=t.path.toArray(),i=0;for(let s=0;s<e.length-2&&s<n.length-2;++s)if(i=K(e[s],n[s]),i)return i;return i=K(e.length,n.length),i||(i=K(e[e.length-2],n[n.length-2]),i||K(e[e.length-1],n[n.length-1]))}var Xu=class{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}};var no=class{constructor(t,e,n,i){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=i}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next(i=>(n=i,this.remoteDocumentCache.getEntry(t,e))).next(i=>(n!==null&&mi(n.mutation,i,Gt.empty(),ct.now()),i))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(n=>this.getLocalViewOfDocuments(t,n,W()).next(()=>n))}getLocalViewOfDocuments(t,e,n=W()){let i=re();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,n).next(s=>{let a=li();return s.forEach((u,c)=>{a=a.insert(u,c.overlayedDocument)}),a}))}getOverlayedDocuments(t,e){let n=re();return this.populateOverlays(t,n,e).next(()=>this.computeViews(t,e,n,W()))}populateOverlays(t,e,n){let i=[];return n.forEach(s=>{e.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(t,i).next(s=>{s.forEach((a,u)=>{e.set(a,u)})})}computeViews(t,e,n,i){let s=Bt(),a=fi(),u=function(){return fi()}();return e.forEach((c,d)=>{let f=n.get(d.key);i.has(d.key)&&(f===void 0||f.mutation instanceof Xt)?s=s.insert(d.key,d):f!==void 0?(a.set(d.key,f.mutation.getFieldMask()),mi(f.mutation,d,f.mutation.getFieldMask(),ct.now())):a.set(d.key,Gt.empty())}),this.recalculateAndSaveOverlays(t,s).next(c=>(c.forEach((d,f)=>a.set(d,f)),e.forEach((d,f)=>{var g;return u.set(d,new Xu(f,(g=a.get(d))!==null&&g!==void 0?g:null))}),u))}recalculateAndSaveOverlays(t,e){let n=fi(),i=new ot((a,u)=>a-u),s=W();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(a=>{for(let u of a)u.keys().forEach(c=>{let d=e.get(c);if(d===null)return;let f=n.get(c)||Gt.empty();f=u.applyToLocalView(d,f),n.set(c,f);let g=(i.get(u.batchId)||W()).add(c);i=i.insert(u.batchId,g)})}).next(()=>{let a=[],u=i.getReverseIterator();for(;u.hasNext();){let c=u.getNext(),d=c.key,f=c.value,g=am();f.forEach(_=>{if(!s.has(_)){let A=mm(e.get(_),n.get(_));A!==null&&g.set(_,A),s=s.add(_)}}),a.push(this.documentOverlayCache.saveOverlays(t,d,g))}return b.waitFor(a)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(n=>this.recalculateAndSaveOverlays(t,n))}getDocumentsMatchingQuery(t,e,n,i){return function(a){return L.isDocumentKey(a.path)&&a.collectionGroup===null&&a.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):il(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n,i):this.getDocumentsMatchingCollectionQuery(t,e,n,i)}getNextDocuments(t,e,n,i){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,i).next(s=>{let a=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,i-s.size):b.resolve(re()),u=-1,c=s;return a.next(d=>b.forEach(d,(f,g)=>(u<g.largestBatchId&&(u=g.largestBatchId),s.get(f)?b.resolve():this.remoteDocumentCache.getEntry(t,f).next(_=>{c=c.insert(f,_)}))).next(()=>this.populateOverlays(t,d,s)).next(()=>this.computeViews(t,c,d,W())).next(f=>({batchId:u,changes:om(f)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new L(e)).next(n=>{let i=li();return n.isFoundDocument()&&(i=i.insert(n.key,n)),i})}getDocumentsMatchingCollectionGroupQuery(t,e,n,i){let s=e.collectionGroup,a=li();return this.indexManager.getCollectionParents(t,s).next(u=>b.forEach(u,c=>{let d=function(g,_){return new Yt(_,null,g.explicitOrderBy.slice(),g.filters.slice(),g.limit,g.limitType,g.startAt,g.endAt)}(e,c.child(s));return this.getDocumentsMatchingCollectionQuery(t,d,n,i).next(f=>{f.forEach((g,_)=>{a=a.insert(g,_)})})}).next(()=>a))}getDocumentsMatchingCollectionQuery(t,e,n,i){let s;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId).next(a=>(s=a,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n,s,i))).next(a=>{s.forEach((c,d)=>{let f=d.getKey();a.get(f)===null&&(a=a.insert(f,vt.newInvalidDocument(f)))});let u=li();return a.forEach((c,d)=>{let f=s.get(c);f!==void 0&&mi(f.mutation,d,Gt.empty(),ct.now()),Bi(e,d)&&(u=u.insert(c,d))}),u})}};var Zu=class{constructor(t){this.serializer=t,this.hr=new Map,this.Pr=new Map}getBundleMetadata(t,e){return b.resolve(this.hr.get(e))}saveBundleMetadata(t,e){return this.hr.set(e.id,function(i){return{id:i.id,version:i.version,createTime:gt(i.createTime)}}(e)),b.resolve()}getNamedQuery(t,e){return b.resolve(this.Pr.get(e))}saveNamedQuery(t,e){return this.Pr.set(e.name,function(i){return{name:i.name,query:ul(i.bundledQuery),readTime:gt(i.readTime)}}(e)),b.resolve()}};var tc=class{constructor(){this.overlays=new ot(L.comparator),this.Ir=new Map}getOverlay(t,e){return b.resolve(this.overlays.get(e))}getOverlays(t,e){let n=re();return b.forEach(e,i=>this.getOverlay(t,i).next(s=>{s!==null&&n.set(i,s)})).next(()=>n)}saveOverlays(t,e,n){return n.forEach((i,s)=>{this.ht(t,e,s)}),b.resolve()}removeOverlaysForBatchId(t,e,n){let i=this.Ir.get(n);return i!==void 0&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.Ir.delete(n)),b.resolve()}getOverlaysForCollection(t,e,n){let i=re(),s=e.length+1,a=new L(e.child("")),u=this.overlays.getIteratorFrom(a);for(;u.hasNext();){let c=u.getNext().value,d=c.getKey();if(!e.isPrefixOf(d.path))break;d.path.length===s&&c.largestBatchId>n&&i.set(c.getKey(),c)}return b.resolve(i)}getOverlaysForCollectionGroup(t,e,n,i){let s=new ot((d,f)=>d-f),a=this.overlays.getIterator();for(;a.hasNext();){let d=a.getNext().value;if(d.getKey().getCollectionGroup()===e&&d.largestBatchId>n){let f=s.get(d.largestBatchId);f===null&&(f=re(),s=s.insert(d.largestBatchId,f)),f.set(d.getKey(),d)}}let u=re(),c=s.getIterator();for(;c.hasNext()&&(c.getNext().value.forEach((d,f)=>u.set(d,f)),!(u.size()>=i)););return b.resolve(u)}ht(t,e,n){let i=this.overlays.get(n.key);if(i!==null){let a=this.Ir.get(i.largestBatchId).delete(n.key);this.Ir.set(i.largestBatchId,a)}this.overlays=this.overlays.insert(n.key,new Si(e,n));let s=this.Ir.get(e);s===void 0&&(s=W(),this.Ir.set(e,s)),this.Ir.set(e,s.add(n.key))}};var ec=class{constructor(){this.sessionToken=pt.EMPTY_BYTE_STRING}getSessionToken(t){return b.resolve(this.sessionToken)}setSessionToken(t,e){return this.sessionToken=e,b.resolve()}};var Di=class{constructor(){this.Tr=new rt(yt.Er),this.dr=new rt(yt.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(t,e){let n=new yt(t,e);this.Tr=this.Tr.add(n),this.dr=this.dr.add(n)}Rr(t,e){t.forEach(n=>this.addReference(n,e))}removeReference(t,e){this.Vr(new yt(t,e))}mr(t,e){t.forEach(n=>this.removeReference(n,e))}gr(t){let e=new L(new X([])),n=new yt(e,t),i=new yt(e,t+1),s=[];return this.dr.forEachInRange([n,i],a=>{this.Vr(a),s.push(a.key)}),s}pr(){this.Tr.forEach(t=>this.Vr(t))}Vr(t){this.Tr=this.Tr.delete(t),this.dr=this.dr.delete(t)}yr(t){let e=new L(new X([])),n=new yt(e,t),i=new yt(e,t+1),s=W();return this.dr.forEachInRange([n,i],a=>{s=s.add(a.key)}),s}containsKey(t){let e=new yt(t,0),n=this.Tr.firstAfterOrEqual(e);return n!==null&&t.isEqual(n.key)}},yt=class{constructor(t,e){this.key=t,this.wr=e}static Er(t,e){return L.comparator(t.key,e.key)||K(t.wr,e.wr)}static Ar(t,e){return K(t.wr,e.wr)||L.comparator(t.key,e.key)}};var nc=class{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.Sr=1,this.br=new rt(yt.Er)}checkEmpty(t){return b.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,n,i){let s=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let a=new Ai(s,e,n,i);this.mutationQueue.push(a);for(let u of i)this.br=this.br.add(new yt(u.key,s)),this.indexManager.addToCollectionParentIndex(t,u.key.path.popLast());return b.resolve(a)}lookupMutationBatch(t,e){return b.resolve(this.Dr(e))}getNextMutationBatchAfterBatchId(t,e){let n=e+1,i=this.vr(n),s=i<0?0:i;return b.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return b.resolve(this.mutationQueue.length===0?-1:this.Sr-1)}getAllMutationBatches(t){return b.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){let n=new yt(e,0),i=new yt(e,Number.POSITIVE_INFINITY),s=[];return this.br.forEachInRange([n,i],a=>{let u=this.Dr(a.wr);s.push(u)}),b.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new rt(K);return e.forEach(i=>{let s=new yt(i,0),a=new yt(i,Number.POSITIVE_INFINITY);this.br.forEachInRange([s,a],u=>{n=n.add(u.wr)})}),b.resolve(this.Cr(n))}getAllMutationBatchesAffectingQuery(t,e){let n=e.path,i=n.length+1,s=n;L.isDocumentKey(s)||(s=s.child(""));let a=new yt(new L(s),0),u=new rt(K);return this.br.forEachWhile(c=>{let d=c.key.path;return!!n.isPrefixOf(d)&&(d.length===i&&(u=u.add(c.wr)),!0)},a),b.resolve(this.Cr(u))}Cr(t){let e=[];return t.forEach(n=>{let i=this.Dr(n);i!==null&&e.push(i)}),e}removeMutationBatch(t,e){U(this.Fr(e.batchId,"removed")===0),this.mutationQueue.shift();let n=this.br;return b.forEach(e.mutations,i=>{let s=new yt(i.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,i.key)}).next(()=>{this.br=n})}On(t){}containsKey(t,e){let n=new yt(e,0),i=this.br.firstAfterOrEqual(n);return b.resolve(e.isEqual(i&&i.key))}performConsistencyCheck(t){return this.mutationQueue.length,b.resolve()}Fr(t,e){return this.vr(t)}vr(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Dr(t){let e=this.vr(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}};var rc=class{constructor(t){this.Mr=t,this.docs=function(){return new ot(L.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){let n=e.key,i=this.docs.get(n),s=i?i.size:0,a=this.Mr(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:a}),this.size+=a-s,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){let e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){let n=this.docs.get(e);return b.resolve(n?n.document.mutableCopy():vt.newInvalidDocument(e))}getEntries(t,e){let n=Bt();return e.forEach(i=>{let s=this.docs.get(i);n=n.insert(i,s?s.document.mutableCopy():vt.newInvalidDocument(i))}),b.resolve(n)}getDocumentsMatchingQuery(t,e,n,i){let s=Bt(),a=e.path,u=new L(a.child("")),c=this.docs.getIteratorFrom(u);for(;c.hasNext();){let{key:d,value:{document:f}}=c.getNext();if(!a.isPrefixOf(d.path))break;d.path.length>a.length+1||Zc(Mf(f),n)<=0||(i.has(f.key)||Bi(e,f))&&(s=s.insert(f.key,f.mutableCopy()))}return b.resolve(s)}getAllFromCollectionGroup(t,e,n,i){q()}Or(t,e){return b.forEach(this.docs,n=>e(n))}newChangeBuffer(t){return new ic(this)}getSize(t){return b.resolve(this.size)}},ic=class extends eo{constructor(t){super(),this.cr=t}applyChanges(t){let e=[];return this.changes.forEach((n,i)=>{i.isValidDocument()?e.push(this.cr.addEntry(t,i)):this.cr.removeEntry(n)}),b.waitFor(e)}getFromCache(t,e){return this.cr.getEntry(t,e)}getAllFromCache(t,e){return this.cr.getEntries(t,e)}};var sc=class{constructor(t){this.persistence=t,this.Nr=new ce(e=>vn(e),qi),this.lastRemoteSnapshotVersion=B.min(),this.highestTargetId=0,this.Lr=0,this.Br=new Di,this.targetCount=0,this.kr=mr.Bn()}forEachTarget(t,e){return this.Nr.forEach((n,i)=>e(i)),b.resolve()}getLastRemoteSnapshotVersion(t){return b.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return b.resolve(this.Lr)}allocateTargetId(t){return this.highestTargetId=this.kr.next(),b.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Lr&&(this.Lr=e),b.resolve()}Kn(t){this.Nr.set(t.target,t);let e=t.targetId;e>this.highestTargetId&&(this.kr=new mr(e),this.highestTargetId=e),t.sequenceNumber>this.Lr&&(this.Lr=t.sequenceNumber)}addTargetData(t,e){return this.Kn(e),this.targetCount+=1,b.resolve()}updateTargetData(t,e){return this.Kn(e),b.resolve()}removeTargetData(t,e){return this.Nr.delete(e.target),this.Br.gr(e.targetId),this.targetCount-=1,b.resolve()}removeTargets(t,e,n){let i=0,s=[];return this.Nr.forEach((a,u)=>{u.sequenceNumber<=e&&n.get(u.targetId)===null&&(this.Nr.delete(a),s.push(this.removeMatchingKeysForTargetId(t,u.targetId)),i++)}),b.waitFor(s).next(()=>i)}getTargetCount(t){return b.resolve(this.targetCount)}getTargetData(t,e){let n=this.Nr.get(e)||null;return b.resolve(n)}addMatchingKeys(t,e,n){return this.Br.Rr(e,n),b.resolve()}removeMatchingKeys(t,e,n){this.Br.mr(e,n);let i=this.persistence.referenceDelegate,s=[];return i&&e.forEach(a=>{s.push(i.markPotentiallyOrphaned(t,a))}),b.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.Br.gr(e),b.resolve()}getMatchingKeysForTargetId(t,e){let n=this.Br.yr(e);return b.resolve(n)}containsKey(t,e){return b.resolve(this.Br.containsKey(e))}};var ro=class{constructor(t,e){this.qr={},this.overlays={},this.Qr=new zt(0),this.Kr=!1,this.Kr=!0,this.$r=new ec,this.referenceDelegate=t(this),this.Ur=new sc(this),this.indexManager=new zu,this.remoteDocumentCache=function(i){return new rc(i)}(n=>this.referenceDelegate.Wr(n)),this.serializer=new Ws(e),this.Gr=new Zu(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new tc,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.qr[t.toKey()];return n||(n=new nc(e,this.referenceDelegate),this.qr[t.toKey()]=n),n}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(t,e,n){k("MemoryPersistence","Starting transaction:",t);let i=new oc(this.Qr.next());return this.referenceDelegate.zr(),n(i).next(s=>this.referenceDelegate.jr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Hr(t,e){return b.or(Object.values(this.qr).map(n=>()=>n.containsKey(t,e)))}},oc=class extends Os{constructor(t){super(),this.currentSequenceNumber=t}},io=class r{constructor(t){this.persistence=t,this.Jr=new Di,this.Yr=null}static Zr(t){return new r(t)}get Xr(){if(this.Yr)return this.Yr;throw q()}addReference(t,e,n){return this.Jr.addReference(n,e),this.Xr.delete(n.toString()),b.resolve()}removeReference(t,e,n){return this.Jr.removeReference(n,e),this.Xr.add(n.toString()),b.resolve()}markPotentiallyOrphaned(t,e){return this.Xr.add(e.toString()),b.resolve()}removeTarget(t,e){this.Jr.gr(e.targetId).forEach(i=>this.Xr.add(i.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next(i=>{i.forEach(s=>this.Xr.add(s.toString()))}).next(()=>n.removeTargetData(t,e))}zr(){this.Yr=new Set}jr(t){let e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return b.forEach(this.Xr,n=>{let i=L.fromPath(n);return this.ei(t,i).next(s=>{s||e.removeEntry(i,B.min())})}).next(()=>(this.Yr=null,e.apply(t)))}updateLimboDocument(t,e){return this.ei(t,e).next(n=>{n?this.Xr.delete(e.toString()):this.Xr.add(e.toString())})}Wr(t){return 0}ei(t,e){return b.or([()=>b.resolve(this.Jr.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Hr(t,e)])}};var ac=class{constructor(t){this.serializer=t}O(t,e,n,i){let s=new Ms("createOrUpgrade",e);n<1&&i>=1&&(function(c){c.createObjectStore("owner")}(t),function(c){c.createObjectStore("mutationQueues",{keyPath:"userId"}),c.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Vd,{unique:!0}),c.createObjectStore("documentMutations")}(t),yf(t),function(c){c.createObjectStore("remoteDocuments")}(t));let a=b.resolve();return n<3&&i>=3&&(n!==0&&(function(c){c.deleteObjectStore("targetDocuments"),c.deleteObjectStore("targets"),c.deleteObjectStore("targetGlobal")}(t),yf(t)),a=a.next(()=>function(c){let d=c.store("targetGlobal"),f={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:B.min().toTimestamp(),targetCount:0};return d.put("targetGlobalKey",f)}(s))),n<4&&i>=4&&(n!==0&&(a=a.next(()=>function(c,d){return d.store("mutations").U().next(f=>{c.deleteObjectStore("mutations"),c.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Vd,{unique:!0});let g=d.store("mutations"),_=f.map(A=>g.put(A));return b.waitFor(_)})}(t,s))),a=a.next(()=>{(function(c){c.createObjectStore("clientMetadata",{keyPath:"clientId"})})(t)})),n<5&&i>=5&&(a=a.next(()=>this.ni(s))),n<6&&i>=6&&(a=a.next(()=>(function(c){c.createObjectStore("remoteDocumentGlobal")}(t),this.ri(s)))),n<7&&i>=7&&(a=a.next(()=>this.ii(s))),n<8&&i>=8&&(a=a.next(()=>this.si(t,s))),n<9&&i>=9&&(a=a.next(()=>{(function(c){c.objectStoreNames.contains("remoteDocumentChanges")&&c.deleteObjectStore("remoteDocumentChanges")})(t)})),n<10&&i>=10&&(a=a.next(()=>this.oi(s))),n<11&&i>=11&&(a=a.next(()=>{(function(c){c.createObjectStore("bundles",{keyPath:"bundleId"})})(t),function(c){c.createObjectStore("namedQueries",{keyPath:"name"})}(t)})),n<12&&i>=12&&(a=a.next(()=>{(function(c){let d=c.createObjectStore("documentOverlays",{keyPath:Q_});d.createIndex("collectionPathOverlayIndex",W_,{unique:!1}),d.createIndex("collectionGroupOverlayIndex",H_,{unique:!1})})(t)})),n<13&&i>=13&&(a=a.next(()=>function(c){let d=c.createObjectStore("remoteDocumentsV14",{keyPath:O_});d.createIndex("documentKeyIndex",M_),d.createIndex("collectionGroupIndex",L_)}(t)).next(()=>this._i(t,s)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&i>=14&&(a=a.next(()=>this.ai(t,s))),n<15&&i>=15&&(a=a.next(()=>function(c){c.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),c.createObjectStore("indexState",{keyPath:z_}).createIndex("sequenceNumberIndex",G_,{unique:!1}),c.createObjectStore("indexEntries",{keyPath:K_}).createIndex("documentKeyIndex",$_,{unique:!1})}(t))),n<16&&i>=16&&(a=a.next(()=>{e.objectStore("indexState").clear()}).next(()=>{e.objectStore("indexEntries").clear()})),n<17&&i>=17&&(a=a.next(()=>{(function(c){c.createObjectStore("globals",{keyPath:"name"})})(t)})),a}ri(t){let e=0;return t.store("remoteDocuments").J((n,i)=>{e+=Zs(i)}).next(()=>{let n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)})}ni(t){let e=t.store("mutationQueues"),n=t.store("mutations");return e.U().next(i=>b.forEach(i,s=>{let a=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return n.U("userMutationsIndex",a).next(u=>b.forEach(u,c=>{U(c.userId===s.userId);let d=dn(this.serializer,c);return Nm(t,s.userId,d).next(()=>{})}))}))}ii(t){let e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next(i=>{let s=[];return n.J((a,u)=>{let c=new X(a),d=function(g){return[0,Ot(g)]}(c);s.push(e.get(d).next(f=>f?b.resolve():(g=>e.put({targetId:0,path:Ot(g),sequenceNumber:i.highestListenSequenceNumber}))(c)))}).next(()=>b.waitFor(s))})}si(t,e){t.createObjectStore("collectionParents",{keyPath:j_});let n=e.store("collectionParents"),i=new xi,s=a=>{if(i.add(a)){let u=a.lastSegment(),c=a.popLast();return n.put({collectionId:u,parent:Ot(c)})}};return e.store("remoteDocuments").J({H:!0},(a,u)=>{let c=new X(a);return s(c.popLast())}).next(()=>e.store("documentMutations").J({H:!0},([a,u,c],d)=>{let f=ne(u);return s(f.popLast())}))}oi(t){let e=t.store("targets");return e.J((n,i)=>{let s=hi(i),a=Dm(this.serializer,s);return e.put(a)})}_i(t,e){let n=e.store("remoteDocuments"),i=[];return n.J((s,a)=>{let u=e.store("remoteDocumentsV14"),c=function(g){return g.document?new L(X.fromString(g.document.name).popFirst(5)):g.noDocument?L.fromSegments(g.noDocument.path):g.unknownDocument?L.fromSegments(g.unknownDocument.path):q()}(a).path.toArray(),d={prefixPath:c.slice(0,c.length-2),collectionGroup:c[c.length-2],documentId:c[c.length-1],readTime:a.readTime||[0,0],unknownDocument:a.unknownDocument,noDocument:a.noDocument,document:a.document,hasCommittedMutations:!!a.hasCommittedMutations};i.push(u.put(d))}).next(()=>b.waitFor(i))}ai(t,e){let n=e.store("mutations"),i=Mm(this.serializer),s=new ro(io.Zr,this.serializer.ct);return n.U().next(a=>{let u=new Map;return a.forEach(c=>{var d;let f=(d=u.get(c.userId))!==null&&d!==void 0?d:W();dn(this.serializer,c).keys().forEach(g=>f=f.add(g)),u.set(c.userId,f)}),b.forEach(u,(c,d)=>{let f=new wt(d),g=Js.lt(this.serializer,f),_=s.getIndexManager(f),A=to.lt(f,this.serializer,_,s.referenceDelegate);return new no(i,A,g,_).recalculateAndSaveOverlaysForDocumentKeys(new wi(e,zt.oe),c).next()})})}};function yf(r){r.createObjectStore("targetDocuments",{keyPath:U_}).createIndex("documentTargetsIndex",B_,{unique:!0}),r.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",q_,{unique:!0}),r.createObjectStore("targetGlobal")}var Ha="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",uc=class r{constructor(t,e,n,i,s,a,u,c,d,f,g=17){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.ui=s,this.window=a,this.document=u,this.ci=d,this.li=f,this.hi=g,this.Qr=null,this.Kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Pi=null,this.inForeground=!1,this.Ii=null,this.Ti=null,this.Ei=Number.NEGATIVE_INFINITY,this.di=_=>Promise.resolve(),!r.D())throw new D(P.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Hu(this,i),this.Ai=e+"main",this.serializer=new Ws(c),this.Ri=new je(this.Ai,this.hi,new ac(this.serializer)),this.$r=new Ou,this.Ur=new Ku(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Mm(this.serializer),this.Gr=new Fu,this.window&&this.window.localStorage?this.Vi=this.window.localStorage:(this.Vi=null,f===!1&&ft("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new D(P.FAILED_PRECONDITION,Ha);return this.fi(),this.gi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",t=>this.Ur.getHighestSequenceNumber(t))}).then(t=>{this.Qr=new zt(t,this.ci)}).then(()=>{this.Kr=!0}).catch(t=>(this.Ri&&this.Ri.close(),Promise.reject(t)))}yi(t){return this.di=e=>C(this,null,function*(){if(this.started)return t(e)}),t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ri.L(e=>C(this,null,function*(){e.newVersion===null&&(yield t())}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.ui.enqueueAndForget(()=>C(this,null,function*(){this.started&&(yield this.mi())})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>bs(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.wi(t).next(e=>{e||(this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.Si(t)).next(e=>this.isPrimary&&!e?this.bi(t).next(()=>!1):!!e&&this.Di(t).next(()=>!0))).catch(t=>{if(Xe(t))return k("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return k("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1}).then(t=>{this.isPrimary!==t&&this.ui.enqueueRetryable(()=>this.di(t)),this.isPrimary=t})}wi(t){return ci(t).get("owner").next(e=>b.resolve(this.vi(e)))}Ci(t){return bs(t).delete(this.clientId)}Fi(){return C(this,null,function*(){if(this.isPrimary&&!this.Mi(this.Ei,18e5)){this.Ei=Date.now();let t=yield this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let n=It(e,"clientMetadata");return n.U().next(i=>{let s=this.xi(i,18e5),a=i.filter(u=>s.indexOf(u)===-1);return b.forEach(a,u=>n.delete(u.clientId)).next(()=>a)})}).catch(()=>[]);if(this.Vi)for(let e of t)this.Vi.removeItem(this.Oi(e.clientId))}})}pi(){this.Ti=this.ui.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.mi().then(()=>this.Fi()).then(()=>this.pi()))}vi(t){return!!t&&t.ownerId===this.clientId}Si(t){return this.li?b.resolve(!0):ci(t).get("owner").next(e=>{if(e!==null&&this.Mi(e.leaseTimestampMs,5e3)&&!this.Ni(e.ownerId)){if(this.vi(e)&&this.networkEnabled)return!0;if(!this.vi(e)){if(!e.allowTabSynchronization)throw new D(P.FAILED_PRECONDITION,Ha);return!1}}return!(!this.networkEnabled||!this.inForeground)||bs(t).U().next(n=>this.xi(n,5e3).find(i=>{if(this.clientId!==i.clientId){let s=!this.networkEnabled&&i.networkEnabled,a=!this.inForeground&&i.inForeground,u=this.networkEnabled===i.networkEnabled;if(s||a&&u)return!0}return!1})===void 0)}).next(e=>(this.isPrimary!==e&&k("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}shutdown(){return C(this,null,function*(){this.Kr=!1,this.Li(),this.Ti&&(this.Ti.cancel(),this.Ti=null),this.Bi(),this.ki(),yield this.Ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],t=>{let e=new wi(t,zt.oe);return this.bi(e).next(()=>this.Ci(e))}),this.Ri.close(),this.qi()})}xi(t,e){return t.filter(n=>this.Mi(n.updateTimeMs,e)&&!this.Ni(n.clientId))}Qi(){return this.runTransaction("getActiveClients","readonly",t=>bs(t).U().next(e=>this.xi(e,18e5).map(n=>n.clientId)))}get started(){return this.Kr}getGlobalsCache(){return this.$r}getMutationQueue(t,e){return to.lt(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new Gu(t,this.serializer.ct.databaseId)}getDocumentOverlayCache(t){return Js.lt(this.serializer,t)}getBundleCache(){return this.Gr}runTransaction(t,e,n){k("IndexedDbPersistence","Starting transaction:",t);let i=e==="readonly"?"readonly":"readwrite",s=function(c){return c===17?X_:c===16?Y_:c===15?el:c===14?Gf:c===13?zf:c===12?J_:c===11?jf:void q()}(this.hi),a;return this.Ri.runTransaction(t,i,s,u=>(a=new wi(u,this.Qr?this.Qr.next():zt.oe),e==="readwrite-primary"?this.wi(a).next(c=>!!c||this.Si(a)).next(c=>{if(!c)throw ft(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)),new D(P.FAILED_PRECONDITION,Lf);return n(a)}).next(c=>this.Di(a).next(()=>c)):this.Ki(a).next(()=>n(a)))).then(u=>(a.raiseOnCommittedEvent(),u))}Ki(t){return ci(t).get("owner").next(e=>{if(e!==null&&this.Mi(e.leaseTimestampMs,5e3)&&!this.Ni(e.ownerId)&&!this.vi(e)&&!(this.li||this.allowTabSynchronization&&e.allowTabSynchronization))throw new D(P.FAILED_PRECONDITION,Ha)})}Di(t){let e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return ci(t).put("owner",e)}static D(){return je.D()}bi(t){let e=ci(t);return e.get("owner").next(n=>this.vi(n)?(k("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):b.resolve())}Mi(t,e){let n=Date.now();return!(t<n-e)&&(!(t>n)||(ft(`Detected an update time that is in the future: ${t} > ${n}`),!1))}fi(){this.document!==null&&typeof this.document.addEventListener=="function"&&(this.Ii=()=>{this.ui.enqueueAndForget(()=>(this.inForeground=this.document.visibilityState==="visible",this.mi()))},this.document.addEventListener("visibilitychange",this.Ii),this.inForeground=this.document.visibilityState==="visible")}Bi(){this.Ii&&(this.document.removeEventListener("visibilitychange",this.Ii),this.Ii=null)}gi(){var t;typeof((t=this.window)===null||t===void 0?void 0:t.addEventListener)=="function"&&(this.Pi=()=>{this.Li();let e=/(?:Version|Mobile)\/1[456]/;Aa()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ui.enterRestrictedMode(!0),this.ui.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Pi))}ki(){this.Pi&&(this.window.removeEventListener("pagehide",this.Pi),this.Pi=null)}Ni(t){var e;try{let n=((e=this.Vi)===null||e===void 0?void 0:e.getItem(this.Oi(t)))!==null;return k("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(n){return ft("IndexedDbPersistence","Failed to get zombied client id.",n),!1}}Li(){if(this.Vi)try{this.Vi.setItem(this.Oi(this.clientId),String(Date.now()))}catch(t){ft("Failed to set zombie client id.",t)}}qi(){if(this.Vi)try{this.Vi.removeItem(this.Oi(this.clientId))}catch{}}Oi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}};function ci(r){return It(r,"owner")}function bs(r){return It(r,"clientMetadata")}function ll(r,t){let e=r.projectId;return r.isDefaultDatabase||(e+="."+r.database),"firestore/"+t+"/"+e+"/"}var cc=class r{constructor(t,e,n,i){this.targetId=t,this.fromCache=e,this.$i=n,this.Ui=i}static Wi(t,e){let n=W(),i=W();for(let s of e.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new r(t,e.fromCache,n,i)}};var lc=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}};var so=class{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=function(){return Aa()?8:qf(ei())>0?6:4}()}initialize(t,e){this.Ji=t,this.indexManager=e,this.Gi=!0}getDocumentsMatchingQuery(t,e,n,i){let s={result:null};return this.Yi(t,e).next(a=>{s.result=a}).next(()=>{if(!s.result)return this.Zi(t,e,i,n).next(a=>{s.result=a})}).next(()=>{if(s.result)return;let a=new lc;return this.Xi(t,e,a).next(u=>{if(s.result=u,this.zi)return this.es(t,e,a,u.size)})}).next(()=>s.result)}es(t,e,n,i){return n.documentReadCount<this.ji?(Yn()<=ee.DEBUG&&k("QueryEngine","SDK will not create cache indexes for query:",Xn(e),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),b.resolve()):(Yn()<=ee.DEBUG&&k("QueryEngine","Query:",Xn(e),"scans",n.documentReadCount,"local documents and returns",i,"documents as results."),n.documentReadCount>this.Hi*i?(Yn()<=ee.DEBUG&&k("QueryEngine","The SDK decides to create cache indexes for query:",Xn(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,Mt(e))):b.resolve())}Yi(t,e){if(Gd(e))return b.resolve(null);let n=Mt(e);return this.indexManager.getIndexType(t,n).next(i=>i===0?null:(e.limit!==null&&i===1&&(e=Gs(e,null,"F"),n=Mt(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next(s=>{let a=W(...s);return this.Ji.getDocuments(t,a).next(u=>this.indexManager.getMinOffset(t,n).next(c=>{let d=this.ts(e,u);return this.ns(e,d,a,c.readTime)?this.Yi(t,Gs(e,null,"F")):this.rs(t,d,e,c)}))})))}Zi(t,e,n,i){return Gd(e)||i.isEqual(B.min())?b.resolve(null):this.Ji.getDocuments(t,n).next(s=>{let a=this.ts(e,s);return this.ns(e,a,n,i)?b.resolve(null):(Yn()<=ee.DEBUG&&k("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Xn(e)),this.rs(t,a,e,Of(i,-1)).next(u=>u))})}ts(t,e){let n=new rt(im(t));return e.forEach((i,s)=>{Bi(t,s)&&(n=n.add(s))}),n}ns(t,e,n,i){if(t.limit===null)return!1;if(n.size!==e.size)return!0;let s=t.limitType==="F"?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Xi(t,e,n){return Yn()<=ee.DEBUG&&k("QueryEngine","Using full collection scan to execute query:",Xn(e)),this.Ji.getDocumentsMatchingQuery(t,e,$t.min(),n)}rs(t,e,n,i){return this.Ji.getDocumentsMatchingQuery(t,n,i).next(s=>(e.forEach(a=>{s=s.insert(a.key,a)}),s))}};var hc=class{constructor(t,e,n,i){this.persistence=t,this.ss=e,this.serializer=i,this.os=new ot(K),this._s=new ce(s=>vn(s),qi),this.us=new Map,this.cs=t.getRemoteDocumentCache(),this.Ur=t.getTargetCache(),this.Gr=t.getBundleCache(),this.ls(n)}ls(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new no(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.os))}};function Lm(r,t,e,n){return new hc(r,t,e,n)}function qm(r,t){return C(this,null,function*(){let e=M(r);return yield e.persistence.runTransaction("Handle user change","readonly",n=>{let i;return e.mutationQueue.getAllMutationBatches(n).next(s=>(i=s,e.ls(t),e.mutationQueue.getAllMutationBatches(n))).next(s=>{let a=[],u=[],c=W();for(let d of i){a.push(d.batchId);for(let f of d.mutations)c=c.add(f.key)}for(let d of s){u.push(d.batchId);for(let f of d.mutations)c=c.add(f.key)}return e.localDocuments.getDocuments(n,c).next(d=>({hs:d,removedBatchIds:a,addedBatchIds:u}))})})})}function Dy(r,t){let e=M(r);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",n=>{let i=t.batch.keys(),s=e.cs.newChangeBuffer({trackRemovals:!0});return function(u,c,d,f){let g=d.batch,_=g.keys(),A=b.resolve();return _.forEach(V=>{A=A.next(()=>f.getEntry(c,V)).next(N=>{let x=d.docVersions.get(V);U(x!==null),N.version.compareTo(x)<0&&(g.applyToRemoteDocument(N,d),N.isValidDocument()&&(N.setReadTime(d.commitVersion),f.addEntry(N)))})}),A.next(()=>u.mutationQueue.removeMutationBatch(c,g))}(e,n,t,s).next(()=>s.apply(n)).next(()=>e.mutationQueue.performConsistencyCheck(n)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(n,i,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(n,function(u){let c=W();for(let d=0;d<u.mutationResults.length;++d)u.mutationResults[d].transformResults.length>0&&(c=c.add(u.batch.mutations[d].key));return c}(t))).next(()=>e.localDocuments.getDocuments(n,i))})}function Um(r){let t=M(r);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Ur.getLastRemoteSnapshotVersion(e))}function Vy(r,t){let e=M(r),n=t.snapshotVersion,i=e.os;return e.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{let a=e.cs.newChangeBuffer({trackRemovals:!0});i=e.os;let u=[];t.targetChanges.forEach((f,g)=>{let _=i.get(g);if(!_)return;u.push(e.Ur.removeMatchingKeys(s,f.removedDocuments,g).next(()=>e.Ur.addMatchingKeys(s,f.addedDocuments,g)));let A=_.withSequenceNumber(s.currentSequenceNumber);t.targetMismatches.get(g)!==null?A=A.withResumeToken(pt.EMPTY_BYTE_STRING,B.min()).withLastLimboFreeSnapshotVersion(B.min()):f.resumeToken.approximateByteSize()>0&&(A=A.withResumeToken(f.resumeToken,n)),i=i.insert(g,A),function(N,x,j){return N.resumeToken.approximateByteSize()===0||x.snapshotVersion.toMicroseconds()-N.snapshotVersion.toMicroseconds()>=3e8?!0:j.addedDocuments.size+j.modifiedDocuments.size+j.removedDocuments.size>0}(_,A,f)&&u.push(e.Ur.updateTargetData(s,A))});let c=Bt(),d=W();if(t.documentUpdates.forEach(f=>{t.resolvedLimboDocuments.has(f)&&u.push(e.persistence.referenceDelegate.updateLimboDocument(s,f))}),u.push(Bm(s,a,t.documentUpdates).next(f=>{c=f.Ps,d=f.Is})),!n.isEqual(B.min())){let f=e.Ur.getLastRemoteSnapshotVersion(s).next(g=>e.Ur.setTargetsMetadata(s,s.currentSequenceNumber,n));u.push(f)}return b.waitFor(u).next(()=>a.apply(s)).next(()=>e.localDocuments.getLocalViewOfDocuments(s,c,d)).next(()=>c)}).then(s=>(e.os=i,s))}function Bm(r,t,e){let n=W(),i=W();return e.forEach(s=>n=n.add(s)),t.getEntries(r,n).next(s=>{let a=Bt();return e.forEach((u,c)=>{let d=s.get(u);c.isFoundDocument()!==d.isFoundDocument()&&(i=i.add(u)),c.isNoDocument()&&c.version.isEqual(B.min())?(t.removeEntry(u,c.readTime),a=a.insert(u,c)):!d.isValidDocument()||c.version.compareTo(d.version)>0||c.version.compareTo(d.version)===0&&d.hasPendingWrites?(t.addEntry(c),a=a.insert(u,c)):k("LocalStore","Ignoring outdated watch update for ",u,". Current version:",d.version," Watch version:",c.version)}),{Ps:a,Is:i}})}function ky(r,t){let e=M(r);return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(t===void 0&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}function gr(r,t){let e=M(r);return e.persistence.runTransaction("Allocate target","readwrite",n=>{let i;return e.Ur.getTargetData(n,t).next(s=>s?(i=s,b.resolve(i)):e.Ur.allocateTargetId(n).next(a=>(i=new fr(t,a,"TargetPurposeListen",n.currentSequenceNumber),e.Ur.addTargetData(n,i).next(()=>i))))}).then(n=>{let i=e.os.get(n.targetId);return(i===null||n.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(e.os=e.os.insert(n.targetId,n),e._s.set(t,n.targetId)),n})}function pr(r,t,e){return C(this,null,function*(){let n=M(r),i=n.os.get(t),s=e?"readwrite":"readwrite-primary";try{e||(yield n.persistence.runTransaction("Release target",s,a=>n.persistence.referenceDelegate.removeTarget(a,i)))}catch(a){if(!Xe(a))throw a;k("LocalStore",`Failed to update sequence numbers for target ${t}: ${a}`)}n.os=n.os.remove(t),n._s.delete(i.target)})}function oo(r,t,e){let n=M(r),i=B.min(),s=W();return n.persistence.runTransaction("Execute query","readwrite",a=>function(c,d,f){let g=M(c),_=g._s.get(f);return _!==void 0?b.resolve(g.os.get(_)):g.Ur.getTargetData(d,f)}(n,a,Mt(t)).next(u=>{if(u)return i=u.lastLimboFreeSnapshotVersion,n.Ur.getMatchingKeysForTargetId(a,u.targetId).next(c=>{s=c})}).next(()=>n.ss.getDocumentsMatchingQuery(a,t,e?i:B.min(),e?s:W())).next(u=>(Gm(n,rm(t),u),{documents:u,Ts:s})))}function jm(r,t){let e=M(r),n=M(e.Ur),i=e.os.get(t);return i?Promise.resolve(i.target):e.persistence.runTransaction("Get target data","readonly",s=>n.ot(s,t).next(a=>a?a.target:null))}function zm(r,t){let e=M(r),n=e.us.get(t)||B.min();return e.persistence.runTransaction("Get new document changes","readonly",i=>e.cs.getAllFromCollectionGroup(i,t,Of(n,-1),Number.MAX_SAFE_INTEGER)).then(i=>(Gm(e,t,i),i))}function Gm(r,t,e){let n=r.us.get(t)||B.min();e.forEach((i,s)=>{s.readTime.compareTo(n)>0&&(n=s.readTime)}),r.us.set(t,n)}function Ny(r,t,e,n){return C(this,null,function*(){let i=M(r),s=W(),a=Bt();for(let d of e){let f=t.Es(d.metadata.name);d.document&&(s=s.add(f));let g=t.ds(d);g.setReadTime(t.As(d.metadata.readTime)),a=a.insert(f,g)}let u=i.cs.newChangeBuffer({trackRemovals:!0}),c=yield gr(i,function(f){return Mt(Ar(X.fromString(`__bundle__/docs/${f}`)))}(n));return i.persistence.runTransaction("Apply bundle documents","readwrite",d=>Bm(d,u,a).next(f=>(u.apply(d),f)).next(f=>i.Ur.removeMatchingKeysForTargetId(d,c.targetId).next(()=>i.Ur.addMatchingKeys(d,s,c.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(d,f.Ps,f.Is)).next(()=>f.Ps)))})}function Fy(n,i){return C(this,arguments,function*(r,t,e=W()){let s=yield gr(r,Mt(ul(t.bundledQuery))),a=M(r);return a.persistence.runTransaction("Save named query","readwrite",u=>{let c=gt(t.readTime);if(s.snapshotVersion.compareTo(c)>=0)return a.Gr.saveNamedQuery(u,t);let d=s.withResumeToken(pt.EMPTY_BYTE_STRING,c);return a.os=a.os.insert(d.targetId,d),a.Ur.updateTargetData(u,d).next(()=>a.Ur.removeMatchingKeysForTargetId(u,s.targetId)).next(()=>a.Ur.addMatchingKeys(u,e,s.targetId)).next(()=>a.Gr.saveNamedQuery(u,t))})})}function wf(r,t){return`firestore_clients_${r}_${t}`}function vf(r,t,e){let n=`firestore_mutations_${r}_${e}`;return t.isAuthenticated()&&(n+=`_${t.uid}`),n}function Ja(r,t){return`firestore_targets_${r}_${t}`}var ao=class r{constructor(t,e,n,i){this.user=t,this.batchId=e,this.state=n,this.error=i}static Rs(t,e,n){let i=JSON.parse(n),s,a=typeof i=="object"&&["pending","acknowledged","rejected"].indexOf(i.state)!==-1&&(i.error===void 0||typeof i.error=="object");return a&&i.error&&(a=typeof i.error.message=="string"&&typeof i.error.code=="string",a&&(s=new D(i.error.code,i.error.message))),a?new r(t,e,i.state,s):(ft("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Vs(){let t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}},gi=class r{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Rs(t,e){let n=JSON.parse(e),i,s=typeof n=="object"&&["not-current","current","rejected"].indexOf(n.state)!==-1&&(n.error===void 0||typeof n.error=="object");return s&&n.error&&(s=typeof n.error.message=="string"&&typeof n.error.code=="string",s&&(i=new D(n.error.code,n.error.message))),s?new r(t,n.state,i):(ft("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Vs(){let t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}},uo=class r{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Rs(t,e){let n=JSON.parse(e),i=typeof n=="object"&&n.activeTargetIds instanceof Array,s=sl();for(let a=0;i&&a<n.activeTargetIds.length;++a)i=Uf(n.activeTargetIds[a]),s=s.add(n.activeTargetIds[a]);return i?new r(t,s):(ft("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}},dc=class r{constructor(t,e){this.clientId=t,this.onlineState=e}static Rs(t){let e=JSON.parse(t);return typeof e=="object"&&["Unknown","Online","Offline"].indexOf(e.onlineState)!==-1&&typeof e.clientId=="string"?new r(e.clientId,e.onlineState):(ft("SharedClientState",`Failed to parse online state: ${t}`),null)}},Vi=class{constructor(){this.activeTargetIds=sl()}fs(t){this.activeTargetIds=this.activeTargetIds.add(t)}gs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Vs(){let t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}},pi=class{constructor(t,e,n,i,s){this.window=t,this.ui=e,this.persistenceKey=n,this.ps=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ys=this.ws.bind(this),this.Ss=new ot(K),this.started=!1,this.bs=[];let a=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ds=wf(this.persistenceKey,this.ps),this.vs=function(c){return`firestore_sequence_number_${c}`}(this.persistenceKey),this.Ss=this.Ss.insert(this.ps,new Vi),this.Cs=new RegExp(`^firestore_clients_${a}_([^_]*)$`),this.Fs=new RegExp(`^firestore_mutations_${a}_(\\d+)(?:_(.*))?$`),this.Ms=new RegExp(`^firestore_targets_${a}_(\\d+)$`),this.xs=function(c){return`firestore_online_state_${c}`}(this.persistenceKey),this.Os=function(c){return`firestore_bundle_loaded_v2_${c}`}(this.persistenceKey),this.window.addEventListener("storage",this.ys)}static D(t){return!(!t||!t.localStorage)}start(){return C(this,null,function*(){let t=yield this.syncEngine.Qi();for(let n of t){if(n===this.ps)continue;let i=this.getItem(wf(this.persistenceKey,n));if(i){let s=uo.Rs(n,i);s&&(this.Ss=this.Ss.insert(s.clientId,s))}}this.Ns();let e=this.storage.getItem(this.xs);if(e){let n=this.Ls(e);n&&this.Bs(n)}for(let n of this.bs)this.ws(n);this.bs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0})}writeSequenceNumber(t){this.setItem(this.vs,JSON.stringify(t))}getAllActiveQueryTargets(){return this.ks(this.Ss)}isActiveQueryTarget(t){let e=!1;return this.Ss.forEach((n,i)=>{i.activeTargetIds.has(t)&&(e=!0)}),e}addPendingMutation(t){this.qs(t,"pending")}updateMutationState(t,e,n){this.qs(t,e,n),this.Qs(t)}addLocalQueryTarget(t,e=!0){let n="not-current";if(this.isActiveQueryTarget(t)){let i=this.storage.getItem(Ja(this.persistenceKey,t));if(i){let s=gi.Rs(t,i);s&&(n=s.state)}}return e&&this.Ks.fs(t),this.Ns(),n}removeLocalQueryTarget(t){this.Ks.gs(t),this.Ns()}isLocalQueryTarget(t){return this.Ks.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(Ja(this.persistenceKey,t))}updateQueryState(t,e,n){this.$s(t,e,n)}handleUserChange(t,e,n){e.forEach(i=>{this.Qs(i)}),this.currentUser=t,n.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(t){this.Us(t)}notifyBundleLoaded(t){this.Ws(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ys),this.removeItem(this.Ds),this.started=!1)}getItem(t){let e=this.storage.getItem(t);return k("SharedClientState","READ",t,e),e}setItem(t,e){k("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){k("SharedClientState","REMOVE",t),this.storage.removeItem(t)}ws(t){let e=t;if(e.storageArea===this.storage){if(k("SharedClientState","EVENT",e.key,e.newValue),e.key===this.Ds)return void ft("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ui.enqueueRetryable(()=>C(this,null,function*(){if(this.started){if(e.key!==null){if(this.Cs.test(e.key)){if(e.newValue==null){let n=this.Gs(e.key);return this.zs(n,null)}{let n=this.js(e.key,e.newValue);if(n)return this.zs(n.clientId,n)}}else if(this.Fs.test(e.key)){if(e.newValue!==null){let n=this.Hs(e.key,e.newValue);if(n)return this.Js(n)}}else if(this.Ms.test(e.key)){if(e.newValue!==null){let n=this.Ys(e.key,e.newValue);if(n)return this.Zs(n)}}else if(e.key===this.xs){if(e.newValue!==null){let n=this.Ls(e.newValue);if(n)return this.Bs(n)}}else if(e.key===this.vs){let n=function(s){let a=zt.oe;if(s!=null)try{let u=JSON.parse(s);U(typeof u=="number"),a=u}catch(u){ft("SharedClientState","Failed to read sequence number from WebStorage",u)}return a}(e.newValue);n!==zt.oe&&this.sequenceNumberHandler(n)}else if(e.key===this.Os){let n=this.Xs(e.newValue);yield Promise.all(n.map(i=>this.syncEngine.eo(i)))}}}else this.bs.push(e)}))}}get Ks(){return this.Ss.get(this.ps)}Ns(){this.setItem(this.Ds,this.Ks.Vs())}qs(t,e,n){let i=new ao(this.currentUser,t,e,n),s=vf(this.persistenceKey,this.currentUser,t);this.setItem(s,i.Vs())}Qs(t){let e=vf(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Us(t){let e={clientId:this.ps,onlineState:t};this.storage.setItem(this.xs,JSON.stringify(e))}$s(t,e,n){let i=Ja(this.persistenceKey,t),s=new gi(t,e,n);this.setItem(i,s.Vs())}Ws(t){let e=JSON.stringify(Array.from(t));this.setItem(this.Os,e)}Gs(t){let e=this.Cs.exec(t);return e?e[1]:null}js(t,e){let n=this.Gs(t);return uo.Rs(n,e)}Hs(t,e){let n=this.Fs.exec(t),i=Number(n[1]),s=n[2]!==void 0?n[2]:null;return ao.Rs(new wt(s),i,e)}Ys(t,e){let n=this.Ms.exec(t),i=Number(n[1]);return gi.Rs(i,e)}Ls(t){return dc.Rs(t)}Xs(t){return JSON.parse(t)}Js(t){return C(this,null,function*(){if(t.user.uid===this.currentUser.uid)return this.syncEngine.no(t.batchId,t.state,t.error);k("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)})}Zs(t){return this.syncEngine.ro(t.targetId,t.state,t.error)}zs(t,e){let n=e?this.Ss.insert(t,e):this.Ss.remove(t),i=this.ks(this.Ss),s=this.ks(n),a=[],u=[];return s.forEach(c=>{i.has(c)||a.push(c)}),i.forEach(c=>{s.has(c)||u.push(c)}),this.syncEngine.io(a,u).then(()=>{this.Ss=n})}Bs(t){this.Ss.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}ks(t){let e=sl();return t.forEach((n,i)=>{e=e.unionWith(i.activeTargetIds)}),e}},co=class{constructor(){this.so=new Vi,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t,e=!0){return e&&this.so.fs(t),this.oo[t]||"not-current"}updateQueryState(t,e,n){this.oo[t]=e}removeLocalQueryTarget(t){this.so.gs(t)}isLocalQueryTarget(t){return this.so.activeTargetIds.has(t)}clearQueryState(t){delete this.oo[t]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(t){return this.so.activeTargetIds.has(t)}start(){return this.so=new Vi,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}};var fc=class{_o(t){}shutdown(){}};var lo=class{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(t){this.ho.push(t)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){k("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(let t of this.ho)t(0)}lo(){k("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(let t of this.ho)t(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};var Rs=null;function Ya(){return Rs===null?Rs=function(){return 268435456+Math.round(2147483648*Math.random())}():Rs++,"0x"+Rs.toString(16)}var Oy={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};var mc=class{constructor(t){this.Io=t.Io,this.To=t.To}Eo(t){this.Ao=t}Ro(t){this.Vo=t}mo(t){this.fo=t}onMessage(t){this.po=t}close(){this.To()}send(t){this.Io(t)}yo(){this.Ao()}wo(){this.Vo()}So(t){this.fo(t)}bo(t){this.po(t)}};var xt="WebChannelConnection",gc=class extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let n=e.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.Do=n+"://"+e.host,this.vo=`projects/${i}/databases/${s}`,this.Co=this.databaseId.database==="(default)"?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get Fo(){return!1}Mo(e,n,i,s,a){let u=Ya(),c=this.xo(e,n.toUriEncodedString());k("RestConnection",`Sending RPC '${e}' ${u}:`,c,i);let d={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(d,s,a),this.No(e,c,d,i).then(f=>(k("RestConnection",`Received RPC '${e}' ${u}: `,f),f),f=>{throw Jt("RestConnection",`RPC '${e}' ${u} failed with error: `,f,"url: ",c,"request:",i),f})}Lo(e,n,i,s,a,u){return this.Mo(e,n,i,s,a)}Oo(e,n,i){e["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Er}(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),n&&n.headers.forEach((s,a)=>e[a]=s),i&&i.headers.forEach((s,a)=>e[a]=s)}xo(e,n){let i=Oy[e];return`${this.Do}/v1/${n}:${i}`}terminate(){}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}No(t,e,n,i){let s=Ya();return new Promise((a,u)=>{let c=new za;c.setWithCredentials(!0),c.listenOnce(Ga.COMPLETE,()=>{try{switch(c.getLastErrorCode()){case si.NO_ERROR:let f=c.getResponseJson();k(xt,`XHR for RPC '${t}' ${s} received:`,JSON.stringify(f)),a(f);break;case si.TIMEOUT:k(xt,`RPC '${t}' ${s} timed out`),u(new D(P.DEADLINE_EXCEEDED,"Request time out"));break;case si.HTTP_ERROR:let g=c.getStatus();if(k(xt,`RPC '${t}' ${s} failed with status:`,g,"response text:",c.getResponseText()),g>0){let _=c.getResponseJson();Array.isArray(_)&&(_=_[0]);let A=_?.error;if(A&&A.status&&A.message){let V=function(x){let j=x.toLowerCase().replace(/_/g,"-");return Object.values(P).indexOf(j)>=0?j:P.UNKNOWN}(A.status);u(new D(V,A.message))}else u(new D(P.UNKNOWN,"Server responded with status "+c.getStatus()))}else u(new D(P.UNAVAILABLE,"Connection failed."));break;default:q()}}finally{k(xt,`RPC '${t}' ${s} completed.`)}});let d=JSON.stringify(i);k(xt,`RPC '${t}' ${s} sending request:`,i),c.send(e,"POST",d,n,15)})}Bo(t,e,n){let i=Ya(),s=[this.Do,"/","google.firestore.v1.Firestore","/",t,"/channel"],a=Qa(),u=$a(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},d=this.longPollingOptions.timeoutSeconds;d!==void 0&&(c.longPollingTimeout=Math.round(1e3*d)),this.useFetchStreams&&(c.useFetchStreams=!0),this.Oo(c.initMessageHeaders,e,n),c.encodeInitMessageHeaders=!0;let f=s.join("");k(xt,`Creating RPC '${t}' stream ${i}: ${f}`,c);let g=a.createWebChannel(f,c),_=!1,A=!1,V=new mc({Io:x=>{A?k(xt,`Not sending because RPC '${t}' stream ${i} is closed:`,x):(_||(k(xt,`Opening RPC '${t}' stream ${i} transport.`),g.open(),_=!0),k(xt,`RPC '${t}' stream ${i} sending:`,x),g.send(x))},To:()=>g.close()}),N=(x,j,z)=>{x.listen(j,O=>{try{z(O)}catch(G){setTimeout(()=>{throw G},0)}})};return N(g,$n.EventType.OPEN,()=>{A||(k(xt,`RPC '${t}' stream ${i} transport opened.`),V.yo())}),N(g,$n.EventType.CLOSE,()=>{A||(A=!0,k(xt,`RPC '${t}' stream ${i} transport closed`),V.So())}),N(g,$n.EventType.ERROR,x=>{A||(A=!0,Jt(xt,`RPC '${t}' stream ${i} transport errored:`,x),V.So(new D(P.UNAVAILABLE,"The operation could not be completed")))}),N(g,$n.EventType.MESSAGE,x=>{var j;if(!A){let z=x.data[0];U(!!z);let O=z,G=O.error||((j=O[0])===null||j===void 0?void 0:j.error);if(G){k(xt,`RPC '${t}' stream ${i} received error:`,G);let $=G.status,Q=function(w){let T=_t[w];if(T!==void 0)return _m(T)}($),v=G.message;Q===void 0&&(Q=P.INTERNAL,v="Unknown error status: "+$+" with message "+G.message),A=!0,V.So(new D(Q,v)),g.close()}else k(xt,`RPC '${t}' stream ${i} received:`,z),V.bo(z)}}),N(u,Ka.STAT_EVENT,x=>{x.stat===Es.PROXY?k(xt,`RPC '${t}' stream ${i} detected buffering proxy`):x.stat===Es.NOPROXY&&k(xt,`RPC '${t}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{V.wo()},0),V}};function Km(){return typeof window<"u"?window:null}function Vs(){return typeof document<"u"?document:null}function ji(r){return new xu(r,!0)}var ki=class{constructor(t,e,n=1e3,i=1.5,s=6e4){this.ui=t,this.timerId=e,this.ko=n,this.qo=i,this.Qo=s,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(t){this.cancel();let e=Math.floor(this.Ko+this.zo()),n=Math.max(0,Date.now()-this.Uo),i=Math.max(0,e-n);i>0&&k("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.Ko} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,i,()=>(this.Uo=Date.now(),t())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){this.$o!==null&&(this.$o.skipDelay(),this.$o=null)}cancel(){this.$o!==null&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}};var ho=class{constructor(t,e,n,i,s,a,u,c){this.ui=t,this.Ho=n,this.Jo=i,this.connection=s,this.authCredentialsProvider=a,this.appCheckCredentialsProvider=u,this.listener=c,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new ki(t,e)}n_(){return this.state===1||this.state===5||this.r_()}r_(){return this.state===2||this.state===3}start(){this.e_=0,this.state!==4?this.auth():this.i_()}stop(){return C(this,null,function*(){this.n_()&&(yield this.close(0))})}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&this.Zo===null&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(t){this.u_(),this.stream.send(t)}__(){return C(this,null,function*(){if(this.r_())return this.close(0)})}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}close(t,e){return C(this,null,function*(){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,t!==4?this.t_.reset():e&&e.code===P.RESOURCE_EXHAUSTED?(ft(e.toString()),ft("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):e&&e.code===P.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.l_(),this.stream.close(),this.stream=null),this.state=t,yield this.listener.mo(e)})}l_(){}auth(){this.state=1;let t=this.h_(this.Yo),e=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([n,i])=>{this.Yo===e&&this.P_(n,i)},n=>{t(()=>{let i=new D(P.UNKNOWN,"Fetching auth token failed: "+n.message);return this.I_(i)})})}P_(t,e){let n=this.h_(this.Yo);this.stream=this.T_(t,e),this.stream.Eo(()=>{n(()=>this.listener.Eo())}),this.stream.Ro(()=>{n(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(i=>{n(()=>this.I_(i))}),this.stream.onMessage(i=>{n(()=>++this.e_==1?this.E_(i):this.onNext(i))})}i_(){this.state=5,this.t_.Go(()=>C(this,null,function*(){this.state=0,this.start()}))}I_(t){return k("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}h_(t){return e=>{this.ui.enqueueAndForget(()=>this.Yo===t?e():(k("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}},pc=class extends ho{constructor(t,e,n,i,s,a){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,i,a),this.serializer=s}T_(t,e){return this.connection.Bo("Listen",t,e)}E_(t){return this.onNext(t)}onNext(t){this.t_.reset();let e=vy(this.serializer,t),n=function(s){if(!("targetChange"in s))return B.min();let a=s.targetChange;return a.targetIds&&a.targetIds.length?B.min():a.readTime?gt(a.readTime):B.min()}(t);return this.listener.d_(e,n)}A_(t){let e={};e.database=ku(this.serializer),e.addTarget=function(s,a){let u,c=a.target;if(u=js(c)?{documents:Sm(s,c)}:{query:bm(s,c)._t},u.targetId=a.targetId,a.resumeToken.approximateByteSize()>0){u.resumeToken=wm(s,a.resumeToken);let d=Du(s,a.expectedCount);d!==null&&(u.expectedCount=d)}else if(a.snapshotVersion.compareTo(B.min())>0){u.readTime=dr(s,a.snapshotVersion.toTimestamp());let d=Du(s,a.expectedCount);d!==null&&(u.expectedCount=d)}return u}(this.serializer,t);let n=Iy(this.serializer,t);n&&(e.labels=n),this.a_(e)}R_(t){let e={};e.database=ku(this.serializer),e.removeTarget=t,this.a_(e)}},_c=class extends ho{constructor(t,e,n,i,s,a){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,i,a),this.serializer=s}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(t,e){return this.connection.Bo("Write",t,e)}E_(t){return U(!!t.streamToken),this.lastStreamToken=t.streamToken,U(!t.writeResults||t.writeResults.length===0),this.listener.f_()}onNext(t){U(!!t.streamToken),this.lastStreamToken=t.streamToken,this.t_.reset();let e=Ty(t.writeResults,t.commitTime),n=gt(t.commitTime);return this.listener.g_(n,e)}p_(){let t={};t.database=ku(this.serializer),this.a_(t)}m_(t){let e={streamToken:this.lastStreamToken,writes:t.map(n=>Ci(this.serializer,n))};this.a_(e)}};var yc=class extends class{}{constructor(t,e,n,i){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.serializer=i,this.y_=!1}w_(){if(this.y_)throw new D(P.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(t,e,n,i){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Mo(t,Vu(e,n),i,s,a)).catch(s=>{throw s.name==="FirebaseError"?(s.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new D(P.UNKNOWN,s.toString())})}Lo(t,e,n,i,s){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([a,u])=>this.connection.Lo(t,Vu(e,n),i,a,u,s)).catch(a=>{throw a.name==="FirebaseError"?(a.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),a):new D(P.UNKNOWN,a.toString())})}terminate(){this.y_=!0,this.connection.terminate()}},wc=class{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){this.S_===0&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(t){this.state==="Online"?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.C_("Offline")))}set(t){this.x_(),this.S_=0,t==="Online"&&(this.D_=!1),this.C_(t)}C_(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}F_(t){let e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(ft(e),this.D_=!1):k("OnlineStateTracker",e)}x_(){this.b_!==null&&(this.b_.cancel(),this.b_=null)}};var vc=class{constructor(t,e,n,i,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=s,this.k_._o(a=>{n.enqueueAndForget(()=>C(this,null,function*(){Ze(this)&&(k("RemoteStore","Restarting streams for network reachability change."),yield function(c){return C(this,null,function*(){let d=M(c);d.L_.add(4),yield Sr(d),d.q_.set("Unknown"),d.L_.delete(4),yield zi(d)})}(this))}))}),this.q_=new wc(n,i)}};function zi(r){return C(this,null,function*(){if(Ze(r))for(let t of r.B_)yield t(!0)})}function Sr(r){return C(this,null,function*(){for(let t of r.B_)yield t(!1)})}function ko(r,t){let e=M(r);e.N_.has(t.targetId)||(e.N_.set(t.targetId,t),fl(e)?dl(e):Rr(e).r_()&&hl(e,t))}function _r(r,t){let e=M(r),n=Rr(e);e.N_.delete(t),n.r_()&&$m(e,t),e.N_.size===0&&(n.r_()?n.o_():Ze(e)&&e.q_.set("Unknown"))}function hl(r,t){if(r.Q_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(B.min())>0){let e=r.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}Rr(r).A_(t)}function $m(r,t){r.Q_.xe(t),Rr(r).R_(t)}function dl(r){r.Q_=new Cu({getRemoteKeysForTarget:t=>r.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>r.N_.get(t)||null,tt:()=>r.datastore.serializer.databaseId}),Rr(r).start(),r.q_.v_()}function fl(r){return Ze(r)&&!Rr(r).n_()&&r.N_.size>0}function Ze(r){return M(r).L_.size===0}function Qm(r){r.Q_=void 0}function My(r){return C(this,null,function*(){r.q_.set("Online")})}function Ly(r){return C(this,null,function*(){r.N_.forEach((t,e)=>{hl(r,t)})})}function qy(r,t){return C(this,null,function*(){Qm(r),fl(r)?(r.q_.M_(t),dl(r)):r.q_.set("Unknown")})}function Uy(r,t,e){return C(this,null,function*(){if(r.q_.set("Online"),t instanceof $s&&t.state===2&&t.cause)try{yield function(i,s){return C(this,null,function*(){let a=s.cause;for(let u of s.targetIds)i.N_.has(u)&&(yield i.remoteSyncer.rejectListen(u,a),i.N_.delete(u),i.Q_.removeTarget(u))})}(r,t)}catch(n){k("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),yield fo(r,n)}else if(t instanceof sr?r.Q_.Ke(t):t instanceof Ks?r.Q_.He(t):r.Q_.We(t),!e.isEqual(B.min()))try{let n=yield Um(r.localStore);e.compareTo(n)>=0&&(yield function(s,a){let u=s.Q_.rt(a);return u.targetChanges.forEach((c,d)=>{if(c.resumeToken.approximateByteSize()>0){let f=s.N_.get(d);f&&s.N_.set(d,f.withResumeToken(c.resumeToken,a))}}),u.targetMismatches.forEach((c,d)=>{let f=s.N_.get(c);if(!f)return;s.N_.set(c,f.withResumeToken(pt.EMPTY_BYTE_STRING,f.snapshotVersion)),$m(s,c);let g=new fr(f.target,c,d,f.sequenceNumber);hl(s,g)}),s.remoteSyncer.applyRemoteEvent(u)}(r,e))}catch(n){k("RemoteStore","Failed to raise snapshot:",n),yield fo(r,n)}})}function fo(r,t,e){return C(this,null,function*(){if(!Xe(t))throw t;r.L_.add(1),yield Sr(r),r.q_.set("Offline"),e||(e=()=>Um(r.localStore)),r.asyncQueue.enqueueRetryable(()=>C(this,null,function*(){k("RemoteStore","Retrying IndexedDB access"),yield e(),r.L_.delete(1),yield zi(r)}))})}function Wm(r,t){return t().catch(e=>fo(r,e,t))}function br(r){return C(this,null,function*(){let t=M(r),e=Je(t),n=t.O_.length>0?t.O_[t.O_.length-1].batchId:-1;for(;By(t);)try{let i=yield ky(t.localStore,n);if(i===null){t.O_.length===0&&e.o_();break}n=i.batchId,jy(t,i)}catch(i){yield fo(t,i)}Hm(t)&&Jm(t)})}function By(r){return Ze(r)&&r.O_.length<10}function jy(r,t){r.O_.push(t);let e=Je(r);e.r_()&&e.V_&&e.m_(t.mutations)}function Hm(r){return Ze(r)&&!Je(r).n_()&&r.O_.length>0}function Jm(r){Je(r).start()}function zy(r){return C(this,null,function*(){Je(r).p_()})}function Gy(r){return C(this,null,function*(){let t=Je(r);for(let e of r.O_)t.m_(e.mutations)})}function Ky(r,t,e){return C(this,null,function*(){let n=r.O_.shift(),i=bu.from(n,t,e);yield Wm(r,()=>r.remoteSyncer.applySuccessfulWrite(i)),yield br(r)})}function $y(r,t){return C(this,null,function*(){t&&Je(r).V_&&(yield function(n,i){return C(this,null,function*(){if(function(a){return pm(a)&&a!==P.ABORTED}(i.code)){let s=n.O_.shift();Je(n).s_(),yield Wm(n,()=>n.remoteSyncer.rejectFailedWrite(s.batchId,i)),yield br(n)}})}(r,t)),Hm(r)&&Jm(r)})}function Tf(r,t){return C(this,null,function*(){let e=M(r);e.asyncQueue.verifyOperationInProgress(),k("RemoteStore","RemoteStore received new credentials");let n=Ze(e);e.L_.add(3),yield Sr(e),n&&e.q_.set("Unknown"),yield e.remoteSyncer.handleCredentialChange(t),e.L_.delete(3),yield zi(e)})}function Tc(r,t){return C(this,null,function*(){let e=M(r);t?(e.L_.delete(2),yield zi(e)):t||(e.L_.add(2),yield Sr(e),e.q_.set("Unknown"))})}function Rr(r){return r.K_||(r.K_=function(e,n,i){let s=M(e);return s.w_(),new pc(n,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(r.datastore,r.asyncQueue,{Eo:My.bind(null,r),Ro:Ly.bind(null,r),mo:qy.bind(null,r),d_:Uy.bind(null,r)}),r.B_.push(t=>C(this,null,function*(){t?(r.K_.s_(),fl(r)?dl(r):r.q_.set("Unknown")):(yield r.K_.stop(),Qm(r))}))),r.K_}function Je(r){return r.U_||(r.U_=function(e,n,i){let s=M(e);return s.w_(),new _c(n,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(r.datastore,r.asyncQueue,{Eo:()=>Promise.resolve(),Ro:zy.bind(null,r),mo:$y.bind(null,r),f_:Gy.bind(null,r),g_:Ky.bind(null,r)}),r.B_.push(t=>C(this,null,function*(){t?(r.U_.s_(),yield br(r)):(yield r.U_.stop(),r.O_.length>0&&(k("RemoteStore",`Stopping write stream with ${r.O_.length} pending writes`),r.O_=[]))}))),r.U_}var Ic=class r{constructor(t,e,n,i,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=i,this.removalCallback=s,this.deferred=new Tt,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(a=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,n,i,s){let a=Date.now()+n,u=new r(t,e,a,i,s);return u.start(n),u}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new D(P.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function Pr(r,t){if(ft("AsyncQueue",`${t}: ${r}`),Xe(r))return new D(P.UNAVAILABLE,`${t}: ${r}`);throw r}var mo=class r{constructor(t){this.comparator=t?(e,n)=>t(e,n)||L.comparator(e.key,n.key):(e,n)=>L.comparator(e.key,n.key),this.keyedMap=li(),this.sortedSet=new ot(this.comparator)}static emptySet(t){return new r(t.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){let e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,n)=>(t(e),!1))}add(t){let e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){let e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof r)||this.size!==t.size)return!1;let e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){let i=e.getNext().key,s=n.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){let t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){let n=new r;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}};var go=class{constructor(){this.W_=new ot(L.comparator)}track(t){let e=t.doc.key,n=this.W_.get(e);n?t.type!==0&&n.type===3?this.W_=this.W_.insert(e,t):t.type===3&&n.type!==1?this.W_=this.W_.insert(e,{type:n.type,doc:t.doc}):t.type===2&&n.type===2?this.W_=this.W_.insert(e,{type:2,doc:t.doc}):t.type===2&&n.type===0?this.W_=this.W_.insert(e,{type:0,doc:t.doc}):t.type===1&&n.type===0?this.W_=this.W_.remove(e):t.type===1&&n.type===2?this.W_=this.W_.insert(e,{type:1,doc:n.doc}):t.type===0&&n.type===1?this.W_=this.W_.insert(e,{type:2,doc:t.doc}):q():this.W_=this.W_.insert(e,t)}G_(){let t=[];return this.W_.inorderTraversal((e,n)=>{t.push(n)}),t}},yr=class r{constructor(t,e,n,i,s,a,u,c,d){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=i,this.mutatedKeys=s,this.fromCache=a,this.syncStateChanged=u,this.excludesMetadataChanges=c,this.hasCachedResults=d}static fromInitialDocuments(t,e,n,i,s){let a=[];return e.forEach(u=>{a.push({type:0,doc:u})}),new r(t,e,mo.emptySet(e),a,n,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Ui(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;let e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let i=0;i<e.length;i++)if(e[i].type!==n[i].type||!e[i].doc.isEqual(n[i].doc))return!1;return!0}};var Ec=class{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(t=>t.J_())}},Ac=class{constructor(){this.queries=If(),this.onlineState="Unknown",this.Y_=new Set}terminate(){(function(e,n){let i=M(e),s=i.queries;i.queries=If(),s.forEach((a,u)=>{for(let c of u.j_)c.onError(n)})})(this,new D(P.ABORTED,"Firestore shutting down"))}};function If(){return new ce(r=>nm(r),Ui)}function ml(r,t){return C(this,null,function*(){let e=M(r),n=3,i=t.query,s=e.queries.get(i);s?!s.H_()&&t.J_()&&(n=2):(s=new Ec,n=t.J_()?0:1);try{switch(n){case 0:s.z_=yield e.onListen(i,!0);break;case 1:s.z_=yield e.onListen(i,!1);break;case 2:yield e.onFirstRemoteStoreListen(i)}}catch(a){let u=Pr(a,`Initialization of query '${Xn(t.query)}' failed`);return void t.onError(u)}e.queries.set(i,s),s.j_.push(t),t.Z_(e.onlineState),s.z_&&t.X_(s.z_)&&pl(e)})}function gl(r,t){return C(this,null,function*(){let e=M(r),n=t.query,i=3,s=e.queries.get(n);if(s){let a=s.j_.indexOf(t);a>=0&&(s.j_.splice(a,1),s.j_.length===0?i=t.J_()?0:1:!s.H_()&&t.J_()&&(i=2))}switch(i){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}})}function Qy(r,t){let e=M(r),n=!1;for(let i of t){let s=i.query,a=e.queries.get(s);if(a){for(let u of a.j_)u.X_(i)&&(n=!0);a.z_=i}}n&&pl(e)}function Wy(r,t,e){let n=M(r),i=n.queries.get(t);if(i)for(let s of i.j_)s.onError(e);n.queries.delete(t)}function pl(r){r.Y_.forEach(t=>{t.next()})}var Sc,Ef;(Ef=Sc||(Sc={})).ea="default",Ef.Cache="cache";var Ni=class{constructor(t,e,n){this.query=t,this.ta=e,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=n||{}}X_(t){if(!this.options.includeMetadataChanges){let n=[];for(let i of t.docChanges)i.type!==3&&n.push(i);t=new yr(t.query,t.docs,t.oldDocs,n,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.na?this.ia(t)&&(this.ta.next(t),e=!0):this.sa(t,this.onlineState)&&(this.oa(t),e=!0),this.ra=t,e}onError(t){this.ta.error(t)}Z_(t){this.onlineState=t;let e=!1;return this.ra&&!this.na&&this.sa(this.ra,t)&&(this.oa(this.ra),e=!0),e}sa(t,e){if(!t.fromCache||!this.J_())return!0;let n=e!=="Offline";return(!this.options._a||!n)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}ia(t){if(t.docChanges.length>0)return!0;let e=this.ra&&this.ra.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}oa(t){t=yr.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.na=!0,this.ta.next(t)}J_(){return this.options.source!==Sc.Cache}};var bc=class{constructor(t,e){this.aa=t,this.byteLength=e}ua(){return"metadata"in this.aa}};var po=class{constructor(t){this.serializer=t}Es(t){return se(this.serializer,t)}ds(t){return t.metadata.exists?Am(this.serializer,t.document,!1):vt.newNoDocument(this.Es(t.metadata.name),this.As(t.metadata.readTime))}As(t){return gt(t)}},Rc=class{constructor(t,e,n){this.ca=t,this.localStore=e,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Ym(t)}la(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.aa.namedQuery)this.queries.push(t.aa.namedQuery);else if(t.aa.documentMetadata){this.documents.push({metadata:t.aa.documentMetadata}),t.aa.documentMetadata.exists||++e;let n=X.fromString(t.aa.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.aa.document&&(this.documents[this.documents.length-1].document=t.aa.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}ha(t){let e=new Map,n=new po(this.serializer);for(let i of t)if(i.metadata.queries){let s=n.Es(i.metadata.name);for(let a of i.metadata.queries){let u=(e.get(a)||W()).add(s);e.set(a,u)}}return e}complete(){return C(this,null,function*(){let t=yield Ny(this.localStore,new po(this.serializer),this.documents,this.ca.id),e=this.ha(this.documents);for(let n of this.queries)yield Fy(this.localStore,n,e.get(n.name));return this.progress.taskState="Success",{progress:this.progress,Pa:this.collectionGroups,Ia:t}})}};function Ym(r){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:r.totalDocuments,totalBytes:r.totalBytes}}var _o=class{constructor(t){this.key=t}},yo=class{constructor(t){this.key=t}},wo=class{constructor(t,e){this.query=t,this.Ta=e,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=W(),this.mutatedKeys=W(),this.Aa=im(t),this.Ra=new mo(this.Aa)}get Va(){return this.Ta}ma(t,e){let n=e?e.fa:new go,i=e?e.Ra:this.Ra,s=e?e.mutatedKeys:this.mutatedKeys,a=i,u=!1,c=this.query.limitType==="F"&&i.size===this.query.limit?i.last():null,d=this.query.limitType==="L"&&i.size===this.query.limit?i.first():null;if(t.inorderTraversal((f,g)=>{let _=i.get(f),A=Bi(this.query,g)?g:null,V=!!_&&this.mutatedKeys.has(_.key),N=!!A&&(A.hasLocalMutations||this.mutatedKeys.has(A.key)&&A.hasCommittedMutations),x=!1;_&&A?_.data.isEqual(A.data)?V!==N&&(n.track({type:3,doc:A}),x=!0):this.ga(_,A)||(n.track({type:2,doc:A}),x=!0,(c&&this.Aa(A,c)>0||d&&this.Aa(A,d)<0)&&(u=!0)):!_&&A?(n.track({type:0,doc:A}),x=!0):_&&!A&&(n.track({type:1,doc:_}),x=!0,(c||d)&&(u=!0)),x&&(A?(a=a.add(A),s=N?s.add(f):s.delete(f)):(a=a.delete(f),s=s.delete(f)))}),this.query.limit!==null)for(;a.size>this.query.limit;){let f=this.query.limitType==="F"?a.last():a.first();a=a.delete(f.key),s=s.delete(f.key),n.track({type:1,doc:f})}return{Ra:a,fa:n,ns:u,mutatedKeys:s}}ga(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n,i){let s=this.Ra;this.Ra=t.Ra,this.mutatedKeys=t.mutatedKeys;let a=t.fa.G_();a.sort((f,g)=>function(A,V){let N=x=>{switch(x){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return q()}};return N(A)-N(V)}(f.type,g.type)||this.Aa(f.doc,g.doc)),this.pa(n),i=i!=null&&i;let u=e&&!i?this.ya():[],c=this.da.size===0&&this.current&&!i?1:0,d=c!==this.Ea;return this.Ea=c,a.length!==0||d?{snapshot:new yr(this.query,t.Ra,s,a,t.mutatedKeys,c===0,d,!1,!!n&&n.resumeToken.approximateByteSize()>0),wa:u}:{wa:u}}Z_(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new go,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(t){return!this.Ta.has(t)&&!!this.Ra.has(t)&&!this.Ra.get(t).hasLocalMutations}pa(t){t&&(t.addedDocuments.forEach(e=>this.Ta=this.Ta.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.Ta=this.Ta.delete(e)),this.current=t.current)}ya(){if(!this.current)return[];let t=this.da;this.da=W(),this.Ra.forEach(n=>{this.Sa(n.key)&&(this.da=this.da.add(n.key))});let e=[];return t.forEach(n=>{this.da.has(n)||e.push(new yo(n))}),this.da.forEach(n=>{t.has(n)||e.push(new _o(n))}),e}ba(t){this.Ta=t.Ts,this.da=W();let e=this.ma(t.documents);return this.applyChanges(e,!0)}Da(){return yr.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,this.Ea===0,this.hasCachedResults)}},Pc=class{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}},Cc=class{constructor(t){this.key=t,this.va=!1}},xc=class{constructor(t,e,n,i,s,a){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=a,this.Ca={},this.Fa=new ce(u=>nm(u),Ui),this.Ma=new Map,this.xa=new Set,this.Oa=new ot(L.comparator),this.Na=new Map,this.La=new Di,this.Ba={},this.ka=new Map,this.qa=mr.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return this.Qa===!0}};function Hy(r,t,e=!0){return C(this,null,function*(){let n=No(r),i,s=n.Fa.get(t);return s?(n.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.Da()):i=yield Xm(n,t,e,!0),i})}function Jy(r,t){return C(this,null,function*(){let e=No(r);yield Xm(e,t,!0,!1)})}function Xm(r,t,e,n){return C(this,null,function*(){let i=yield gr(r.localStore,Mt(t)),s=i.targetId,a=r.sharedClientState.addLocalQueryTarget(s,e),u;return n&&(u=yield _l(r,t,s,a==="current",i.resumeToken)),r.isPrimaryClient&&e&&ko(r.remoteStore,i),u})}function _l(r,t,e,n,i){return C(this,null,function*(){r.Ka=(g,_,A)=>function(N,x,j,z){return C(this,null,function*(){let O=x.view.ma(j);O.ns&&(O=yield oo(N.localStore,x.query,!1).then(({documents:v})=>x.view.ma(v,O)));let G=z&&z.targetChanges.get(x.targetId),$=z&&z.targetMismatches.get(x.targetId)!=null,Q=x.view.applyChanges(O,N.isPrimaryClient,G,$);return Dc(N,x.targetId,Q.wa),Q.snapshot})}(r,g,_,A);let s=yield oo(r.localStore,t,!0),a=new wo(t,s.Ts),u=a.ma(s.documents),c=Ri.createSynthesizedTargetChangeForCurrentChange(e,n&&r.onlineState!=="Offline",i),d=a.applyChanges(u,r.isPrimaryClient,c);Dc(r,e,d.wa);let f=new Pc(t,e,a);return r.Fa.set(t,f),r.Ma.has(e)?r.Ma.get(e).push(t):r.Ma.set(e,[t]),d.snapshot})}function Yy(r,t,e){return C(this,null,function*(){let n=M(r),i=n.Fa.get(t),s=n.Ma.get(i.targetId);if(s.length>1)return n.Ma.set(i.targetId,s.filter(a=>!Ui(a,t))),void n.Fa.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(i.targetId),n.sharedClientState.isActiveQueryTarget(i.targetId)||(yield pr(n.localStore,i.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(i.targetId),e&&_r(n.remoteStore,i.targetId),wr(n,i.targetId)}).catch(Ye))):(wr(n,i.targetId),yield pr(n.localStore,i.targetId,!0))})}function Xy(r,t){return C(this,null,function*(){let e=M(r),n=e.Fa.get(t),i=e.Ma.get(n.targetId);e.isPrimaryClient&&i.length===1&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),_r(e.remoteStore,n.targetId))})}function Zy(r,t,e){return C(this,null,function*(){let n=Tl(r);try{let i=yield function(a,u){let c=M(a),d=ct.now(),f=u.reduce((A,V)=>A.add(V.key),W()),g,_;return c.persistence.runTransaction("Locally write mutations","readwrite",A=>{let V=Bt(),N=W();return c.cs.getEntries(A,f).next(x=>{V=x,V.forEach((j,z)=>{z.isValidDocument()||(N=N.add(j))})}).next(()=>c.localDocuments.getOverlayedDocuments(A,V)).next(x=>{g=x;let j=[];for(let z of u){let O=fy(z,g.get(z.key).overlayedDocument);O!=null&&j.push(new Xt(z.key,O,Hf(O.value.mapValue),dt.exists(!0)))}return c.mutationQueue.addMutationBatch(A,d,j,u)}).next(x=>{_=x;let j=x.applyToLocalDocumentSet(g,N);return c.documentOverlayCache.saveOverlays(A,x.batchId,j)})}).then(()=>({batchId:_.batchId,changes:om(g)}))}(n.localStore,t);n.sharedClientState.addPendingMutation(i.batchId),function(a,u,c){let d=a.Ba[a.currentUser.toKey()];d||(d=new ot(K)),d=d.insert(u,c),a.Ba[a.currentUser.toKey()]=d}(n,i.batchId,e),yield Ee(n,i.changes),yield br(n.remoteStore)}catch(i){let s=Pr(i,"Failed to persist write");e.reject(s)}})}function Zm(r,t){return C(this,null,function*(){let e=M(r);try{let n=yield Vy(e.localStore,t);t.targetChanges.forEach((i,s)=>{let a=e.Na.get(s);a&&(U(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?a.va=!0:i.modifiedDocuments.size>0?U(a.va):i.removedDocuments.size>0&&(U(a.va),a.va=!1))}),yield Ee(e,n,t)}catch(n){yield Ye(n)}})}function Af(r,t,e){let n=M(r);if(n.isPrimaryClient&&e===0||!n.isPrimaryClient&&e===1){let i=[];n.Fa.forEach((s,a)=>{let u=a.view.Z_(t);u.snapshot&&i.push(u.snapshot)}),function(a,u){let c=M(a);c.onlineState=u;let d=!1;c.queries.forEach((f,g)=>{for(let _ of g.j_)_.Z_(u)&&(d=!0)}),d&&pl(c)}(n.eventManager,t),i.length&&n.Ca.d_(i),n.onlineState=t,n.isPrimaryClient&&n.sharedClientState.setOnlineState(t)}}function tw(r,t,e){return C(this,null,function*(){let n=M(r);n.sharedClientState.updateQueryState(t,"rejected",e);let i=n.Na.get(t),s=i&&i.key;if(s){let a=new ot(L.comparator);a=a.insert(s,vt.newNoDocument(s,B.min()));let u=W().add(s),c=new bi(B.min(),new Map,new ot(K),a,u);yield Zm(n,c),n.Oa=n.Oa.remove(s),n.Na.delete(t),vl(n)}else yield pr(n.localStore,t,!1).then(()=>wr(n,t,e)).catch(Ye)})}function ew(r,t){return C(this,null,function*(){let e=M(r),n=t.batch.batchId;try{let i=yield Dy(e.localStore,t);wl(e,n,null),yl(e,n),e.sharedClientState.updateMutationState(n,"acknowledged"),yield Ee(e,i)}catch(i){yield Ye(i)}})}function nw(r,t,e){return C(this,null,function*(){let n=M(r);try{let i=yield function(a,u){let c=M(a);return c.persistence.runTransaction("Reject batch","readwrite-primary",d=>{let f;return c.mutationQueue.lookupMutationBatch(d,u).next(g=>(U(g!==null),f=g.keys(),c.mutationQueue.removeMutationBatch(d,g))).next(()=>c.mutationQueue.performConsistencyCheck(d)).next(()=>c.documentOverlayCache.removeOverlaysForBatchId(d,f,u)).next(()=>c.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(d,f)).next(()=>c.localDocuments.getDocuments(d,f))})}(n.localStore,t);wl(n,t,e),yl(n,t),n.sharedClientState.updateMutationState(t,"rejected",e),yield Ee(n,i)}catch(i){yield Ye(i)}})}function rw(r,t){return C(this,null,function*(){let e=M(r);Ze(e.remoteStore)||k("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let n=yield function(a){let u=M(a);return u.persistence.runTransaction("Get highest unacknowledged batch id","readonly",c=>u.mutationQueue.getHighestUnacknowledgedBatchId(c))}(e.localStore);if(n===-1)return void t.resolve();let i=e.ka.get(n)||[];i.push(t),e.ka.set(n,i)}catch(n){let i=Pr(n,"Initialization of waitForPendingWrites() operation failed");t.reject(i)}})}function yl(r,t){(r.ka.get(t)||[]).forEach(e=>{e.resolve()}),r.ka.delete(t)}function wl(r,t,e){let n=M(r),i=n.Ba[n.currentUser.toKey()];if(i){let s=i.get(t);s&&(e?s.reject(e):s.resolve(),i=i.remove(t)),n.Ba[n.currentUser.toKey()]=i}}function wr(r,t,e=null){r.sharedClientState.removeLocalQueryTarget(t);for(let n of r.Ma.get(t))r.Fa.delete(n),e&&r.Ca.$a(n,e);r.Ma.delete(t),r.isPrimaryClient&&r.La.gr(t).forEach(n=>{r.La.containsKey(n)||tg(r,n)})}function tg(r,t){r.xa.delete(t.path.canonicalString());let e=r.Oa.get(t);e!==null&&(_r(r.remoteStore,e),r.Oa=r.Oa.remove(t),r.Na.delete(e),vl(r))}function Dc(r,t,e){for(let n of e)n instanceof _o?(r.La.addReference(n.key,t),iw(r,n)):n instanceof yo?(k("SyncEngine","Document no longer in limbo: "+n.key),r.La.removeReference(n.key,t),r.La.containsKey(n.key)||tg(r,n.key)):q()}function iw(r,t){let e=t.key,n=e.path.canonicalString();r.Oa.get(e)||r.xa.has(n)||(k("SyncEngine","New document in limbo: "+e),r.xa.add(n),vl(r))}function vl(r){for(;r.xa.size>0&&r.Oa.size<r.maxConcurrentLimboResolutions;){let t=r.xa.values().next().value;r.xa.delete(t);let e=new L(X.fromString(t)),n=r.qa.next();r.Na.set(n,new Cc(e)),r.Oa=r.Oa.insert(e,n),ko(r.remoteStore,new fr(Mt(Ar(e.path)),n,"TargetPurposeLimboResolution",zt.oe))}}function Ee(r,t,e){return C(this,null,function*(){let n=M(r),i=[],s=[],a=[];n.Fa.isEmpty()||(n.Fa.forEach((u,c)=>{a.push(n.Ka(c,t,e).then(d=>{var f;if((d||e)&&n.isPrimaryClient){let g=d?!d.fromCache:(f=e?.targetChanges.get(c.targetId))===null||f===void 0?void 0:f.current;n.sharedClientState.updateQueryState(c.targetId,g?"current":"not-current")}if(d){i.push(d);let g=cc.Wi(c.targetId,d);s.push(g)}}))}),yield Promise.all(a),n.Ca.d_(i),yield function(c,d){return C(this,null,function*(){let f=M(c);try{yield f.persistence.runTransaction("notifyLocalViewChanges","readwrite",g=>b.forEach(d,_=>b.forEach(_.$i,A=>f.persistence.referenceDelegate.addReference(g,_.targetId,A)).next(()=>b.forEach(_.Ui,A=>f.persistence.referenceDelegate.removeReference(g,_.targetId,A)))))}catch(g){if(!Xe(g))throw g;k("LocalStore","Failed to update sequence numbers: "+g)}for(let g of d){let _=g.targetId;if(!g.fromCache){let A=f.os.get(_),V=A.snapshotVersion,N=A.withLastLimboFreeSnapshotVersion(V);f.os=f.os.insert(_,N)}}})}(n.localStore,s))})}function sw(r,t){return C(this,null,function*(){let e=M(r);if(!e.currentUser.isEqual(t)){k("SyncEngine","User change. New user:",t.toKey());let n=yield qm(e.localStore,t);e.currentUser=t,function(s,a){s.ka.forEach(u=>{u.forEach(c=>{c.reject(new D(P.CANCELLED,a))})}),s.ka.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),yield Ee(e,n.hs)}})}function ow(r,t){let e=M(r),n=e.Na.get(t);if(n&&n.va)return W().add(n.key);{let i=W(),s=e.Ma.get(t);if(!s)return i;for(let a of s){let u=e.Fa.get(a);i=i.unionWith(u.view.Va)}return i}}function aw(r,t){return C(this,null,function*(){let e=M(r),n=yield oo(e.localStore,t.query,!0),i=t.view.ba(n);return e.isPrimaryClient&&Dc(e,t.targetId,i.wa),i})}function uw(r,t){return C(this,null,function*(){let e=M(r);return zm(e.localStore,t).then(n=>Ee(e,n))})}function cw(r,t,e,n){return C(this,null,function*(){let i=M(r),s=yield function(u,c){let d=M(u),f=M(d.mutationQueue);return d.persistence.runTransaction("Lookup mutation documents","readonly",g=>f.Mn(g,c).next(_=>_?d.localDocuments.getDocuments(g,_):b.resolve(null)))}(i.localStore,t);s!==null?(e==="pending"?yield br(i.remoteStore):e==="acknowledged"||e==="rejected"?(wl(i,t,n||null),yl(i,t),function(u,c){M(M(u).mutationQueue).On(c)}(i.localStore,t)):q(),yield Ee(i,s)):k("SyncEngine","Cannot apply mutation batch with id: "+t)})}function lw(r,t){return C(this,null,function*(){let e=M(r);if(No(e),Tl(e),t===!0&&e.Qa!==!0){let n=e.sharedClientState.getAllActiveQueryTargets(),i=yield Sf(e,n.toArray());e.Qa=!0,yield Tc(e.remoteStore,!0);for(let s of i)ko(e.remoteStore,s)}else if(t===!1&&e.Qa!==!1){let n=[],i=Promise.resolve();e.Ma.forEach((s,a)=>{e.sharedClientState.isLocalQueryTarget(a)?n.push(a):i=i.then(()=>(wr(e,a),pr(e.localStore,a,!0))),_r(e.remoteStore,a)}),yield i,yield Sf(e,n),function(a){let u=M(a);u.Na.forEach((c,d)=>{_r(u.remoteStore,d)}),u.La.pr(),u.Na=new Map,u.Oa=new ot(L.comparator)}(e),e.Qa=!1,yield Tc(e.remoteStore,!1)}})}function Sf(r,t,e){return C(this,null,function*(){let n=M(r),i=[],s=[];for(let a of t){let u,c=n.Ma.get(a);if(c&&c.length!==0){u=yield gr(n.localStore,Mt(c[0]));for(let d of c){let f=n.Fa.get(d),g=yield aw(n,f);g.snapshot&&s.push(g.snapshot)}}else{let d=yield jm(n.localStore,a);u=yield gr(n.localStore,d),yield _l(n,eg(d),a,!1,u.resumeToken)}i.push(u)}return n.Ca.d_(s),i})}function eg(r){return em(r.path,r.collectionGroup,r.orderBy,r.filters,r.limit,"F",r.startAt,r.endAt)}function hw(r){return function(e){return M(M(e).persistence).Qi()}(M(r).localStore)}function dw(r,t,e,n){return C(this,null,function*(){let i=M(r);if(i.Qa)return void k("SyncEngine","Ignoring unexpected query state notification.");let s=i.Ma.get(t);if(s&&s.length>0)switch(e){case"current":case"not-current":{let a=yield zm(i.localStore,rm(s[0])),u=bi.createSynthesizedRemoteEventForCurrentChange(t,e==="current",pt.EMPTY_BYTE_STRING);yield Ee(i,a,u);break}case"rejected":yield pr(i.localStore,t,!0),wr(i,t,n);break;default:q()}})}function fw(r,t,e){return C(this,null,function*(){let n=No(r);if(n.Qa){for(let i of t){if(n.Ma.has(i)&&n.sharedClientState.isActiveQueryTarget(i)){k("SyncEngine","Adding an already active target "+i);continue}let s=yield jm(n.localStore,i),a=yield gr(n.localStore,s);yield _l(n,eg(s),a.targetId,!1,a.resumeToken),ko(n.remoteStore,a)}for(let i of e)n.Ma.has(i)&&(yield pr(n.localStore,i,!1).then(()=>{_r(n.remoteStore,i),wr(n,i)}).catch(Ye))}})}function No(r){let t=M(r);return t.remoteStore.remoteSyncer.applyRemoteEvent=Zm.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=ow.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=tw.bind(null,t),t.Ca.d_=Qy.bind(null,t.eventManager),t.Ca.$a=Wy.bind(null,t.eventManager),t}function Tl(r){let t=M(r);return t.remoteStore.remoteSyncer.applySuccessfulWrite=ew.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=nw.bind(null,t),t}function mw(r,t,e){let n=M(r);(function(s,a,u){return C(this,null,function*(){try{let c=yield a.getMetadata();if(yield function(A,V){let N=M(A),x=gt(V.createTime);return N.persistence.runTransaction("hasNewerBundle","readonly",j=>N.Gr.getBundleMetadata(j,V.id)).then(j=>!!j&&j.createTime.compareTo(x)>=0)}(s.localStore,c))return yield a.close(),u._completeWith(function(A){return{taskState:"Success",documentsLoaded:A.totalDocuments,bytesLoaded:A.totalBytes,totalDocuments:A.totalDocuments,totalBytes:A.totalBytes}}(c)),Promise.resolve(new Set);u._updateProgress(Ym(c));let d=new Rc(c,s.localStore,a.serializer),f=yield a.Ua();for(;f;){let _=yield d.la(f);_&&u._updateProgress(_),f=yield a.Ua()}let g=yield d.complete();return yield Ee(s,g.Ia,void 0),yield function(A,V){let N=M(A);return N.persistence.runTransaction("Save bundle","readwrite",x=>N.Gr.saveBundleMetadata(x,V))}(s.localStore,c),u._completeWith(g.progress),Promise.resolve(g.Pa)}catch(c){return Jt("SyncEngine",`Loading bundle failed with ${c}`),u._failWith(c),Promise.resolve(new Set)}})})(n,t,e).then(i=>{n.sharedClientState.notifyBundleLoaded(i)})}var Vc=(()=>{class r{constructor(){this.kind="memory",this.synchronizeTabs=!1}initialize(e){return C(this,null,function*(){this.serializer=ji(e.databaseInfo.databaseId),this.sharedClientState=this.Wa(e),this.persistence=this.Ga(e),yield this.persistence.start(),this.localStore=this.za(e),this.gcScheduler=this.ja(e,this.localStore),this.indexBackfillerScheduler=this.Ha(e,this.localStore)})}ja(e,n){return null}Ha(e,n){return null}za(e){return Lm(this.persistence,new so,e.initialUser,this.serializer)}Ga(e){return new ro(io.Zr,this.serializer)}Wa(e){return new co}terminate(){return C(this,null,function*(){var e,n;(e=this.gcScheduler)===null||e===void 0||e.stop(),(n=this.indexBackfillerScheduler)===null||n===void 0||n.stop(),this.sharedClientState.shutdown(),yield this.persistence.shutdown()})}}return r.provider={build:()=>new r},r})();var vo=class r extends Vc{constructor(t,e,n){super(),this.Ja=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}initialize(t){return C(this,null,function*(){yield wa(r.prototype,this,"initialize").call(this,t),yield this.Ja.initialize(this,t),yield Tl(this.Ja.syncEngine),yield br(this.Ja.remoteStore),yield this.persistence.yi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))})}za(t){return Lm(this.persistence,new so,t.initialUser,this.serializer)}ja(t,e){let n=this.persistence.referenceDelegate.garbageCollector;return new Qu(n,t.asyncQueue,e)}Ha(t,e){let n=new lu(e,this.persistence);return new cu(t.asyncQueue,n)}Ga(t){let e=ll(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=this.cacheSizeBytes!==void 0?Kt.withCacheSize(this.cacheSizeBytes):Kt.DEFAULT;return new uc(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Km(),Vs(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Wa(t){return new co}},kc=class r extends vo{constructor(t,e){super(t,e,!1),this.Ja=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}initialize(t){return C(this,null,function*(){yield wa(r.prototype,this,"initialize").call(this,t);let e=this.Ja.syncEngine;this.sharedClientState instanceof pi&&(this.sharedClientState.syncEngine={no:cw.bind(null,e),ro:dw.bind(null,e),io:fw.bind(null,e),Qi:hw.bind(null,e),eo:uw.bind(null,e)},yield this.sharedClientState.start()),yield this.persistence.yi(n=>C(this,null,function*(){yield lw(this.Ja.syncEngine,n),this.gcScheduler&&(n&&!this.gcScheduler.started?this.gcScheduler.start():n||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(n&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():n||this.indexBackfillerScheduler.stop())}))})}Wa(t){let e=Km();if(!pi.D(e))throw new D(P.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let n=ll(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new pi(e,t.asyncQueue,n,t.clientId,t.initialUser)}},Il=(()=>{class r{initialize(e,n){return C(this,null,function*(){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(n),this.remoteStore=this.createRemoteStore(n),this.eventManager=this.createEventManager(n),this.syncEngine=this.createSyncEngine(n,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=i=>Af(this.syncEngine,i,1),this.remoteStore.remoteSyncer.handleCredentialChange=sw.bind(null,this.syncEngine),yield Tc(this.remoteStore,this.syncEngine.isPrimaryClient))})}createEventManager(e){return function(){return new Ac}()}createDatastore(e){let n=ji(e.databaseInfo.databaseId),i=function(a){return new gc(a)}(e.databaseInfo);return function(a,u,c,d){return new yc(a,u,c,d)}(e.authCredentials,e.appCheckCredentials,i,n)}createRemoteStore(e){return function(i,s,a,u,c){return new vc(i,s,a,u,c)}(this.localStore,this.datastore,e.asyncQueue,n=>Af(this.syncEngine,n,0),function(){return lo.D()?new lo:new fc}())}createSyncEngine(e,n){return function(s,a,u,c,d,f,g){let _=new xc(s,a,u,c,d,f);return g&&(_.Qa=!0),_}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,n)}terminate(){return C(this,null,function*(){var e,n;yield function(s){return C(this,null,function*(){let a=M(s);k("RemoteStore","RemoteStore shutting down."),a.L_.add(5),yield Sr(a),a.k_.shutdown(),a.q_.set("Unknown")})}(this.remoteStore),(e=this.datastore)===null||e===void 0||e.terminate(),(n=this.eventManager)===null||n===void 0||n.terminate()})}}return r.provider={build:()=>new r},r})();function bf(r,t=10240){let e=0;return{read(){return C(this,null,function*(){if(e<r.byteLength){let i={value:r.slice(e,e+t),done:!1};return e+=t,i}return{done:!0}})},cancel(){return C(this,null,function*(){})},releaseLock(){},closed:Promise.resolve()}}var vr=class{constructor(t){this.observer=t,this.muted=!1}next(t){this.muted||this.observer.next&&this.Ya(this.observer.next,t)}error(t){this.muted||(this.observer.error?this.Ya(this.observer.error,t):ft("Uncaught Error in snapshot listener:",t.toString()))}Za(){this.muted=!0}Ya(t,e){setTimeout(()=>{this.muted||t(e)},0)}};var Nc=class{constructor(t,e){this.Xa=t,this.serializer=e,this.metadata=new Tt,this.buffer=new Uint8Array,this.eu=function(){return new TextDecoder("utf-8")}(),this.tu().then(n=>{n&&n.ua()?this.metadata.resolve(n.aa.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(n?.aa)}`))},n=>this.metadata.reject(n))}close(){return this.Xa.cancel()}getMetadata(){return C(this,null,function*(){return this.metadata.promise})}Ua(){return C(this,null,function*(){return yield this.getMetadata(),this.tu()})}tu(){return C(this,null,function*(){let t=yield this.nu();if(t===null)return null;let e=this.eu.decode(t),n=Number(e);isNaN(n)&&this.ru(`length string (${e}) is not valid number`);let i=yield this.iu(n);return new bc(JSON.parse(i),t.length+n)})}su(){return this.buffer.findIndex(t=>t===123)}nu(){return C(this,null,function*(){for(;this.su()<0&&!(yield this.ou()););if(this.buffer.length===0)return null;let t=this.su();t<0&&this.ru("Reached the end of bundle when a length string is expected.");let e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e})}iu(t){return C(this,null,function*(){for(;this.buffer.length<t;)(yield this.ou())&&this.ru("Reached the end of bundle when more is expected.");let e=this.eu.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e})}ru(t){throw this.Xa.cancel(),new Error(`Invalid bundle format: ${t}`)}ou(){return C(this,null,function*(){let t=yield this.Xa.read();if(!t.done){let e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done})}};var Fc=class{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(t){return C(this,null,function*(){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new D(P.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let e=yield function(i,s){return C(this,null,function*(){let a=M(i),u={documents:s.map(g=>Pi(a.serializer,g))},c=yield a.Lo("BatchGetDocuments",a.serializer.databaseId,X.emptyPath(),u,s.length),d=new Map;c.forEach(g=>{let _=wy(a.serializer,g);d.set(_.key.toString(),_)});let f=[];return s.forEach(g=>{let _=d.get(g.toString());U(!!_),f.push(_)}),f})}(this.datastore,t);return e.forEach(n=>this.recordVersion(n)),e})}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(n){this.lastTransactionError=n}this.writtenDocs.add(t.toString())}delete(t){this.write(new He(t,this.precondition(t))),this.writtenDocs.add(t.toString())}commit(){return C(this,null,function*(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,n)=>{let i=L.fromPath(n);this.mutations.push(new Ei(i,this.precondition(i)))}),yield function(n,i){return C(this,null,function*(){let s=M(n),a={writes:i.map(u=>Ci(s.serializer,u))};yield s.Mo("Commit",s.serializer.databaseId,X.emptyPath(),a)})}(this.datastore,this.mutations),this.committed=!0})}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw q();e=B.min()}let n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new D(P.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){let e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual(B.min())?dt.exists(!1):dt.updateTime(e):dt.none()}preconditionForUpdate(t){let e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(B.min()))throw new D(P.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return dt.updateTime(e)}return dt.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}};var Oc=class{constructor(t,e,n,i,s){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=i,this.deferred=s,this._u=n.maxAttempts,this.t_=new ki(this.asyncQueue,"transaction_retry")}au(){this._u-=1,this.uu()}uu(){this.t_.Go(()=>C(this,null,function*(){let t=new Fc(this.datastore),e=this.cu(t);e&&e.then(n=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(n)}).catch(i=>{this.lu(i)}))}).catch(n=>{this.lu(n)})}))}cu(t){try{let e=this.updateFunction(t);return!Li(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}lu(t){this._u>0&&this.hu(t)?(this._u-=1,this.asyncQueue.enqueueAndForget(()=>(this.uu(),Promise.resolve()))):this.deferred.reject(t)}hu(t){if(t.name==="FirebaseError"){let e=t.code;return e==="aborted"||e==="failed-precondition"||e==="already-exists"||!pm(e)}return!1}};var Mc=class{constructor(t,e,n,i,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=i,this.user=wt.UNAUTHENTICATED,this.clientId=Ns.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=s,this.authCredentials.start(n,a=>C(this,null,function*(){k("FirestoreClient","Received user=",a.uid),yield this.authCredentialListener(a),this.user=a})),this.appCheckCredentials.start(n,a=>(k("FirestoreClient","Received new app check token=",a),this.appCheckCredentialListener(a,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}terminate(){this.asyncQueue.enterRestrictedMode();let t=new Tt;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(()=>C(this,null,function*(){try{this._onlineComponents&&(yield this._onlineComponents.terminate()),this._offlineComponents&&(yield this._offlineComponents.terminate()),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){let n=Pr(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}};function Xa(r,t){return C(this,null,function*(){r.asyncQueue.verifyOperationInProgress(),k("FirestoreClient","Initializing OfflineComponentProvider");let e=r.configuration;yield t.initialize(e);let n=e.initialUser;r.setCredentialChangeListener(i=>C(this,null,function*(){n.isEqual(i)||(yield qm(t.localStore,i),n=i)})),t.persistence.setDatabaseDeletedListener(()=>r.terminate()),r._offlineComponents=t})}function Rf(r,t){return C(this,null,function*(){r.asyncQueue.verifyOperationInProgress();let e=yield El(r);k("FirestoreClient","Initializing OnlineComponentProvider"),yield t.initialize(e,r.configuration),r.setCredentialChangeListener(n=>Tf(t.remoteStore,n)),r.setAppCheckTokenChangeListener((n,i)=>Tf(t.remoteStore,i)),r._onlineComponents=t})}function El(r){return C(this,null,function*(){if(!r._offlineComponents)if(r._uninitializedComponentsProvider){k("FirestoreClient","Using user provided OfflineComponentProvider");try{yield Xa(r,r._uninitializedComponentsProvider._offline)}catch(t){let e=t;if(!function(i){return i.name==="FirebaseError"?i.code===P.FAILED_PRECONDITION||i.code===P.UNIMPLEMENTED:!(typeof DOMException<"u"&&i instanceof DOMException)||i.code===22||i.code===20||i.code===11}(e))throw e;Jt("Error using user provided cache. Falling back to memory cache: "+e),yield Xa(r,new Vc)}}else k("FirestoreClient","Using default OfflineComponentProvider"),yield Xa(r,new Vc);return r._offlineComponents})}function Fo(r){return C(this,null,function*(){return r._onlineComponents||(r._uninitializedComponentsProvider?(k("FirestoreClient","Using user provided OnlineComponentProvider"),yield Rf(r,r._uninitializedComponentsProvider._online)):(k("FirestoreClient","Using default OnlineComponentProvider"),yield Rf(r,new Il))),r._onlineComponents})}function ng(r){return El(r).then(t=>t.persistence)}function Al(r){return El(r).then(t=>t.localStore)}function rg(r){return Fo(r).then(t=>t.remoteStore)}function Sl(r){return Fo(r).then(t=>t.syncEngine)}function gw(r){return Fo(r).then(t=>t.datastore)}function Tr(r){return C(this,null,function*(){let t=yield Fo(r),e=t.eventManager;return e.onListen=Hy.bind(null,t.syncEngine),e.onUnlisten=Yy.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=Jy.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=Xy.bind(null,t.syncEngine),e})}function pw(r){return r.asyncQueue.enqueue(()=>C(this,null,function*(){let t=yield ng(r),e=yield rg(r);return t.setNetworkEnabled(!0),function(i){let s=M(i);return s.L_.delete(0),zi(s)}(e)}))}function _w(r){return r.asyncQueue.enqueue(()=>C(this,null,function*(){let t=yield ng(r),e=yield rg(r);return t.setNetworkEnabled(!1),function(i){return C(this,null,function*(){let s=M(i);s.L_.add(0),yield Sr(s),s.q_.set("Offline")})}(e)}))}function yw(r,t){let e=new Tt;return r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(i,s,a){return C(this,null,function*(){try{let u=yield function(d,f){let g=M(d);return g.persistence.runTransaction("read document","readonly",_=>g.localDocuments.getDocument(_,f))}(i,s);u.isFoundDocument()?a.resolve(u):u.isNoDocument()?a.resolve(null):a.reject(new D(P.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(u){let c=Pr(u,`Failed to get document '${s} from cache`);a.reject(c)}})}(yield Al(r),t,e)})),e.promise}function ig(r,t,e={}){let n=new Tt;return r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(s,a,u,c,d){let f=new vr({next:_=>{f.Za(),a.enqueueAndForget(()=>gl(s,g));let A=_.docs.has(u);!A&&_.fromCache?d.reject(new D(P.UNAVAILABLE,"Failed to get document because the client is offline.")):A&&_.fromCache&&c&&c.source==="server"?d.reject(new D(P.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):d.resolve(_)},error:_=>d.reject(_)}),g=new Ni(Ar(u.path),f,{includeMetadataChanges:!0,_a:!0});return ml(s,g)}(yield Tr(r),r.asyncQueue,t,e,n)})),n.promise}function ww(r,t){let e=new Tt;return r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(i,s,a){return C(this,null,function*(){try{let u=yield oo(i,s,!0),c=new wo(s,u.Ts),d=c.ma(u.documents),f=c.applyChanges(d,!1);a.resolve(f.snapshot)}catch(u){let c=Pr(u,`Failed to execute query '${s} against cache`);a.reject(c)}})}(yield Al(r),t,e)})),e.promise}function sg(r,t,e={}){let n=new Tt;return r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(s,a,u,c,d){let f=new vr({next:_=>{f.Za(),a.enqueueAndForget(()=>gl(s,g)),_.fromCache&&c.source==="server"?d.reject(new D(P.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):d.resolve(_)},error:_=>d.reject(_)}),g=new Ni(u,f,{includeMetadataChanges:!0,_a:!0});return ml(s,g)}(yield Tr(r),r.asyncQueue,t,e,n)})),n.promise}function vw(r,t){let e=new vr(t);return r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(i,s){M(i).Y_.add(s),s.next()}(yield Tr(r),e)})),()=>{e.Za(),r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(i,s){M(i).Y_.delete(s)}(yield Tr(r),e)}))}}function Tw(r,t,e,n){let i=function(a,u){let c;return c=typeof a=="string"?ym().encode(a):a,function(f,g){return new Nc(f,g)}(function(f,g){if(f instanceof Uint8Array)return bf(f,g);if(f instanceof ArrayBuffer)return bf(new Uint8Array(f),g);if(f instanceof ReadableStream)return f.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(c),u)}(e,ji(t));r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){mw(yield Sl(r),i,n)}))}function Iw(r,t){return r.asyncQueue.enqueue(()=>C(this,null,function*(){return function(n,i){let s=M(n);return s.persistence.runTransaction("Get named query","readonly",a=>s.Gr.getNamedQuery(a,i))}(yield Al(r),t)}))}function og(r){let t={};return r.timeoutSeconds!==void 0&&(t.timeoutSeconds=r.timeoutSeconds),t}var Pf=new Map;function bl(r,t,e){if(!e)throw new D(P.INVALID_ARGUMENT,`Function ${r}() cannot be called with an empty ${t}.`)}function Rl(r,t,e,n){if(t===!0&&n===!0)throw new D(P.INVALID_ARGUMENT,`${r} and ${e} cannot be used together.`)}function Cf(r){if(!L.isDocumentKey(r))throw new D(P.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${r} has ${r.length}.`)}function xf(r){if(L.isDocumentKey(r))throw new D(P.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${r} has ${r.length}.`)}function Oo(r){if(r===void 0)return"undefined";if(r===null)return"null";if(typeof r=="string")return r.length>20&&(r=`${r.substring(0,20)}...`),JSON.stringify(r);if(typeof r=="number"||typeof r=="boolean")return""+r;if(typeof r=="object"){if(r instanceof Array)return"an array";{let t=function(n){return n.constructor?n.constructor.name:null}(r);return t?`a custom ${t} object`:"an object"}}return typeof r=="function"?"a function":q()}function Z(r,t){if("_delegate"in r&&(r=r._delegate),!(r instanceof t)){if(t.name===r.constructor.name)throw new D(P.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let e=Oo(r);throw new D(P.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return r}function ag(r,t){if(t<=0)throw new D(P.INVALID_ARGUMENT,`Function ${r}() requires a positive number, but it was: ${t}.`)}var To=class{constructor(t){var e,n;if(t.host===void 0){if(t.ssl!==void 0)throw new D(P.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=(e=t.ssl)===null||e===void 0||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<1048576)throw new D(P.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}Rl("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=og((n=t.experimentalLongPollingOptions)!==null&&n!==void 0?n:{}),function(s){if(s.timeoutSeconds!==void 0){if(isNaN(s.timeoutSeconds))throw new D(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new D(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new D(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(n,i){return n.timeoutSeconds===i.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}},An=class{constructor(t,e,n,i){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new To({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new D(P.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(t){if(this._settingsFrozen)throw new D(P.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new To(t),t.credentials!==void 0&&(this._authCredentials=function(n){if(!n)return new Za;switch(n.type){case"firstParty":return new ru(n.sessionIndex||"0",n.iamToken||null,n.authTokenFactory||null);case"provider":return n.client;default:throw new D(P.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}_restart(){return C(this,null,function*(){this._terminateTask==="notTerminated"?yield this._terminate():this._terminateTask="notTerminated"})}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let n=Pf.get(e);n&&(k("ComponentProvider","Removing Datastore"),Pf.delete(e),n.terminate())}(this),Promise.resolve()}};function ug(r,t,e,n={}){var i;let s=(r=Z(r,An))._getSettings(),a=`${t}:${e}`;if(s.host!=="firestore.googleapis.com"&&s.host!==a&&Jt("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),r._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),n.mockUserToken){let u,c;if(typeof n.mockUserToken=="string")u=n.mockUserToken,c=wt.MOCK_USER;else{u=od(n.mockUserToken,(i=r._app)===null||i===void 0?void 0:i.options.projectId);let d=n.mockUserToken.sub||n.mockUserToken.user_id;if(!d)throw new D(P.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");c=new wt(d)}r._authCredentials=new tu(new ks(u,c))}}var At=class r{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new r(this.firestore,t,this._query)}},it=class r{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new oe(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new r(this.firestore,t,this._key)}},oe=class r extends At{constructor(t,e,n){super(t,e,Ar(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let t=this._path.popLast();return t.isEmpty()?null:new it(this.firestore,null,new L(t))}withConverter(t){return new r(this.firestore,t,this._path)}};function Pl(r,t,...e){if(r=ut(r),bl("collection","path",t),r instanceof An){let n=X.fromString(t,...e);return xf(n),new oe(r,null,n)}{if(!(r instanceof it||r instanceof oe))throw new D(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let n=r._path.child(X.fromString(t,...e));return xf(n),new oe(r.firestore,null,n)}}function cg(r,t){if(r=Z(r,An),bl("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new D(P.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new At(r,null,function(n){return new Yt(X.emptyPath(),n)}(t))}function Gi(r,t,...e){if(r=ut(r),arguments.length===1&&(t=Ns.newId()),bl("doc","path",t),r instanceof An){let n=X.fromString(t,...e);return Cf(n),new it(r,null,new L(n))}{if(!(r instanceof it||r instanceof oe))throw new D(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let n=r._path.child(X.fromString(t,...e));return Cf(n),new it(r.firestore,r instanceof oe?r.converter:null,new L(n))}}function Cl(r,t){return r=ut(r),t=ut(t),(r instanceof it||r instanceof oe)&&(t instanceof it||t instanceof oe)&&r.firestore===t.firestore&&r.path===t.path&&r.converter===t.converter}function xl(r,t){return r=ut(r),t=ut(t),r instanceof At&&t instanceof At&&r.firestore===t.firestore&&Ui(r._query,t._query)&&r.converter===t.converter}var Io=class{constructor(t=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new ki(this,"async_queue_retry"),this.Vu=()=>{let n=Vs();n&&k("AsyncQueue","Visibility state changed to "+n.visibilityState),this.t_.jo()},this.mu=t;let e=Vs();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.fu(),this.gu(t)}enterRestrictedMode(t){if(!this.Iu){this.Iu=!0,this.Au=t||!1;let e=Vs();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.Vu)}}enqueue(t){if(this.fu(),this.Iu)return new Promise(()=>{});let e=new Tt;return this.gu(()=>this.Iu&&this.Au?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.Pu.push(t),this.pu()))}pu(){return C(this,null,function*(){if(this.Pu.length!==0){try{yield this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(t){if(!Xe(t))throw t;k("AsyncQueue","Operation failed with retryable error: "+t)}this.Pu.length>0&&this.t_.Go(()=>this.pu())}})}gu(t){let e=this.mu.then(()=>(this.du=!0,t().catch(n=>{this.Eu=n,this.du=!1;let i=function(a){let u=a.message||"";return a.stack&&(u=a.stack.includes(a.message)?a.stack:a.message+`
`+a.stack),u}(n);throw ft("INTERNAL UNHANDLED ERROR: ",i),n}).then(n=>(this.du=!1,n))));return this.mu=e,e}enqueueAfterDelay(t,e,n){this.fu(),this.Ru.indexOf(t)>-1&&(e=0);let i=Ic.createAndSchedule(this,t,e,n,s=>this.yu(s));return this.Tu.push(i),i}fu(){this.Eu&&q()}verifyOperationInProgress(){}wu(){return C(this,null,function*(){let t;do t=this.mu,yield t;while(t!==this.mu)})}Su(t){for(let e of this.Tu)if(e.timerId===t)return!0;return!1}bu(t){return this.wu().then(()=>{this.Tu.sort((e,n)=>e.targetTimeMs-n.targetTimeMs);for(let e of this.Tu)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.wu()})}Du(t){this.Ru.push(t)}yu(t){let e=this.Tu.indexOf(t);this.Tu.splice(e,1)}};function Lc(r){return function(e,n){if(typeof e!="object"||e===null)return!1;let i=e;for(let s of n)if(s in i&&typeof i[s]=="function")return!0;return!1}(r,["next","error","complete"])}var qc=class{constructor(){this._progressObserver={},this._taskCompletionResolver=new Tt,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}};var lg=-1,lt=class extends An{constructor(t,e,n,i){super(t,e,n,i),this.type="firestore",this._queue=new Io,this._persistenceKey=i?.name||"[DEFAULT]"}_terminate(){return C(this,null,function*(){if(this._firestoreClient){let t=this._firestoreClient.terminate();this._queue=new Io(t),this._firestoreClient=void 0,yield t}})}};function St(r){if(r._terminated)throw new D(P.FAILED_PRECONDITION,"The client has already been terminated.");return r._firestoreClient||hg(r),r._firestoreClient}function hg(r){var t,e,n;let i=r._freezeSettings(),s=function(u,c,d,f){return new hu(u,c,d,f.host,f.ssl,f.experimentalForceLongPolling,f.experimentalAutoDetectLongPolling,og(f.experimentalLongPollingOptions),f.useFetchStreams)}(r._databaseId,((t=r._app)===null||t===void 0?void 0:t.options.appId)||"",r._persistenceKey,i);r._componentsProvider||!((e=i.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((n=i.localCache)===null||n===void 0)&&n._onlineComponentProvider)&&(r._componentsProvider={_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider}),r._firestoreClient=new Mc(r._authCredentials,r._appCheckCredentials,r._queue,s,r._componentsProvider&&function(u){let c=u?._online.build();return{_offline:u?._offline.build(c),_online:c}}(r._componentsProvider))}function dg(r,t){Jt("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let e=r._freezeSettings();return mg(r,Il.provider,{build:n=>new vo(n,e.cacheSizeBytes,t?.forceOwnership)}),Promise.resolve()}function fg(r){return C(this,null,function*(){Jt("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let t=r._freezeSettings();mg(r,Il.provider,{build:e=>new kc(e,t.cacheSizeBytes)})})}function mg(r,t,e){if((r=Z(r,lt))._firestoreClient||r._terminated)throw new D(P.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(r._componentsProvider||r._getSettings().localCache)throw new D(P.FAILED_PRECONDITION,"SDK cache is already specified.");r._componentsProvider={_online:t,_offline:e},hg(r)}function gg(r){if(r._initialized&&!r._terminated)throw new D(P.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let t=new Tt;return r._queue.enqueueAndForgetEvenWhileRestricted(()=>C(this,null,function*(){try{yield function(n){return C(this,null,function*(){if(!je.D())return Promise.resolve();let i=n+"main";yield je.delete(i)})}(ll(r._databaseId,r._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function pg(r){return function(e){let n=new Tt;return e.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return rw(yield Sl(e),n)})),n.promise}(St(r=Z(r,lt)))}function _g(r){return pw(St(r=Z(r,lt)))}function yg(r){return _w(St(r=Z(r,lt)))}function wg(r,t){let e=St(r=Z(r,lt)),n=new qc;return Tw(e,r._databaseId,t,n),n}function vg(r,t){return Iw(St(r=Z(r,lt)),t).then(e=>e?new At(r,null,e.query):null)}var le=class r{constructor(t){this._byteString=t}static fromBase64String(t){try{return new r(pt.fromBase64String(t))}catch(e){throw new D(P.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new r(pt.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}};var Zt=class{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new D(P.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new mt(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}};var Te=class{constructor(t){this._methodName=t}};var Sn=class{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new D(P.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new D(P.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return K(this._lat,t._lat)||K(this._long,t._long)}};var Fi=class{constructor(t){this._values=(t||[]).map(e=>e)}toArray(){return this._values.map(t=>t)}isEqual(t){return function(n,i){if(n.length!==i.length)return!1;for(let s=0;s<n.length;++s)if(n[s]!==i[s])return!1;return!0}(this._values,t._values)}};var Ew=/^__.*__$/,Uc=class{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return this.fieldMask!==null?new Xt(t,this.data,this.fieldMask,e,this.fieldTransforms):new We(t,this.data,e,this.fieldTransforms)}},Eo=class{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Xt(t,this.data,this.fieldMask,e,this.fieldTransforms)}};function Tg(r){switch(r){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw q()}}var Ao=class r{constructor(t,e,n,i,s,a){this.settings=t,this.databaseId=e,this.serializer=n,this.ignoreUndefinedProperties=i,s===void 0&&this.vu(),this.fieldTransforms=s||[],this.fieldMask=a||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(t){return new r(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(t){var e;let n=(e=this.path)===null||e===void 0?void 0:e.child(t),i=this.Fu({path:n,xu:!1});return i.Ou(t),i}Nu(t){var e;let n=(e=this.path)===null||e===void 0?void 0:e.child(t),i=this.Fu({path:n,xu:!1});return i.vu(),i}Lu(t){return this.Fu({path:void 0,xu:!0})}Bu(t){return So(t,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}vu(){if(this.path)for(let t=0;t<this.path.length;t++)this.Ou(this.path.get(t))}Ou(t){if(t.length===0)throw this.Bu("Document fields must not be empty");if(Tg(this.Cu)&&Ew.test(t))throw this.Bu('Document fields cannot begin and end with "__"')}},Bc=class{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=n||ji(t)}Qu(t,e,n,i=!1){return new Ao({Cu:t,methodName:e,qu:n,path:mt.emptyPath(),xu:!1,ku:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};function Cn(r){let t=r._freezeSettings(),e=ji(r._databaseId);return new Bc(r._databaseId,!!t.ignoreUndefinedProperties,e)}function Mo(r,t,e,n,i,s={}){let a=r.Qu(s.merge||s.mergeFields?2:0,t,e,i);kl("Data must be an object, but it was:",a,n);let u=Ag(n,a),c,d;if(s.merge)c=new Gt(a.fieldMask),d=a.fieldTransforms;else if(s.mergeFields){let f=[];for(let g of s.mergeFields){let _=$c(t,g,e);if(!a.contains(_))throw new D(P.INVALID_ARGUMENT,`Field '${_}' is specified in your field mask but missing from your input data.`);bg(f,_)||f.push(_)}c=new Gt(f),d=a.fieldTransforms.filter(g=>c.covers(g.field))}else c=null,d=a.fieldTransforms;return new Uc(new Dt(u),c,d)}var Oi=class r extends Te{_toFieldTransform(t){if(t.Cu!==2)throw t.Cu===1?t.Bu(`${this._methodName}() can only appear at the top level of your update data`):t.Bu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof r}};function Ig(r,t,e){return new Ao({Cu:3,qu:t.settings.qu,methodName:r._methodName,xu:e},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}var jc=class r extends Te{_toFieldTransform(t){return new Tn(t.path,new $e)}isEqual(t){return t instanceof r}},zc=class r extends Te{constructor(t,e){super(t),this.Ku=e}_toFieldTransform(t){let e=Ig(this,t,!0),n=this.Ku.map(s=>xn(s,e)),i=new we(n);return new Tn(t.path,i)}isEqual(t){return t instanceof r&&Sa(this.Ku,t.Ku)}},Gc=class r extends Te{constructor(t,e){super(t),this.Ku=e}_toFieldTransform(t){let e=Ig(this,t,!0),n=this.Ku.map(s=>xn(s,e)),i=new ve(n);return new Tn(t.path,i)}isEqual(t){return t instanceof r&&Sa(this.Ku,t.Ku)}},Kc=class r extends Te{constructor(t,e){super(t),this.$u=e}_toFieldTransform(t){let e=new Qe(t.serializer,cm(t.serializer,this.$u));return new Tn(t.path,e)}isEqual(t){return t instanceof r&&this.$u===t.$u}};function Dl(r,t,e,n){let i=r.Qu(1,t,e);kl("Data must be an object, but it was:",i,n);let s=[],a=Dt.empty();Pn(n,(c,d)=>{let f=Nl(t,c,e);d=ut(d);let g=i.Nu(f);if(d instanceof Oi)s.push(f);else{let _=xn(d,g);_!=null&&(s.push(f),a.set(f,_))}});let u=new Gt(s);return new Eo(a,u,i.fieldTransforms)}function Vl(r,t,e,n,i,s){let a=r.Qu(1,t,e),u=[$c(t,n,e)],c=[i];if(s.length%2!=0)throw new D(P.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let _=0;_<s.length;_+=2)u.push($c(t,s[_])),c.push(s[_+1]);let d=[],f=Dt.empty();for(let _=u.length-1;_>=0;--_)if(!bg(d,u[_])){let A=u[_],V=c[_];V=ut(V);let N=a.Nu(A);if(V instanceof Oi)d.push(A);else{let x=xn(V,N);x!=null&&(d.push(A),f.set(A,x))}}let g=new Gt(d);return new Eo(f,g,a.fieldTransforms)}function Eg(r,t,e,n=!1){return xn(e,r.Qu(n?4:3,t))}function xn(r,t){if(Sg(r=ut(r)))return kl("Unsupported field value:",t,r),Ag(r,t);if(r instanceof Te)return function(n,i){if(!Tg(i.Cu))throw i.Bu(`${n._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Bu(`${n._methodName}() is not currently supported inside arrays`);let s=n._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(r,t),null;if(r===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),r instanceof Array){if(t.settings.xu&&t.Cu!==4)throw t.Bu("Nested arrays are not supported");return function(n,i){let s=[],a=0;for(let u of n){let c=xn(u,i.Lu(a));c==null&&(c={nullValue:"NULL_VALUE"}),s.push(c),a++}return{arrayValue:{values:s}}}(r,t)}return function(n,i){if((n=ut(n))===null)return{nullValue:"NULL_VALUE"};if(typeof n=="number")return cm(i.serializer,n);if(typeof n=="boolean")return{booleanValue:n};if(typeof n=="string")return{stringValue:n};if(n instanceof Date){let s=ct.fromDate(n);return{timestampValue:dr(i.serializer,s)}}if(n instanceof ct){let s=new ct(n.seconds,1e3*Math.floor(n.nanoseconds/1e3));return{timestampValue:dr(i.serializer,s)}}if(n instanceof Sn)return{geoPointValue:{latitude:n.latitude,longitude:n.longitude}};if(n instanceof le)return{bytesValue:wm(i.serializer,n._byteString)};if(n instanceof it){let s=i.databaseId,a=n.firestore._databaseId;if(!a.isEqual(s))throw i.Bu(`Document reference is for database ${a.projectId}/${a.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:al(n.firestore._databaseId||i.databaseId,n._key.path)}}if(n instanceof Fi)return function(a,u){return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:a.toArray().map(c=>{if(typeof c!="number")throw u.Bu("VectorValues must only contain numeric values.");return ol(u.serializer,c)})}}}}}}(n,i);throw i.Bu(`Unsupported field value: ${Oo(n)}`)}(r,t)}function Ag(r,t){let e={};return Kf(r)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):Pn(r,(n,i)=>{let s=xn(i,t.Mu(n));s!=null&&(e[n]=s)}),{mapValue:{fields:e}}}function Sg(r){return!(typeof r!="object"||r===null||r instanceof Array||r instanceof Date||r instanceof ct||r instanceof Sn||r instanceof le||r instanceof it||r instanceof Te||r instanceof Fi)}function kl(r,t,e){if(!Sg(e)||!function(i){return typeof i=="object"&&i!==null&&(Object.getPrototypeOf(i)===Object.prototype||Object.getPrototypeOf(i)===null)}(e)){let n=Oo(e);throw n==="an object"?t.Bu(r+" a custom object"):t.Bu(r+" "+n)}}function $c(r,t,e){if((t=ut(t))instanceof Zt)return t._internalPath;if(typeof t=="string")return Nl(r,t);throw So("Field path arguments must be of type string or ",r,!1,void 0,e)}var Aw=new RegExp("[~\\*/\\[\\]]");function Nl(r,t,e){if(t.search(Aw)>=0)throw So(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,r,!1,void 0,e);try{return new Zt(...t.split("."))._internalPath}catch{throw So(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,r,!1,void 0,e)}}function So(r,t,e,n,i){let s=n&&!n.isEmpty(),a=i!==void 0,u=`Function ${t}() called with invalid data`;e&&(u+=" (via `toFirestore()`)"),u+=". ";let c="";return(s||a)&&(c+=" (found",s&&(c+=` in field ${n}`),a&&(c+=` in document ${i}`),c+=")"),new D(P.INVALID_ARGUMENT,u+r+c)}function bg(r,t){return r.some(e=>e.isEqual(t))}var bn=class{constructor(t,e,n,i,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new it(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){let t=new Qc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){let e=this._document.data.field(Lo("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}},Qc=class extends bn{data(){return super.data()}};function Lo(r,t){return typeof t=="string"?Nl(r,t):t instanceof Zt?t._internalPath:t._delegate._internalPath}function Rg(r){if(r.limitType==="L"&&r.explicitOrderBy.length===0)throw new D(P.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var Mi=class{},Rn=class extends Mi{};function Ae(r,t,...e){let n=[];t instanceof Mi&&n.push(t),n=n.concat(e),function(s){let a=s.filter(c=>c instanceof Wc).length,u=s.filter(c=>c instanceof bo).length;if(a>1||a>0&&u>0)throw new D(P.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(n);for(let i of n)r=i._apply(r);return r}var bo=class r extends Rn{constructor(t,e,n){super(),this._field=t,this._op=e,this._value=n,this.type="where"}static _create(t,e,n){return new r(t,e,n)}_apply(t){let e=this._parse(t);return Mg(t._query,e),new At(t.firestore,t.converter,Au(t._query,e))}_parse(t){let e=Cn(t.firestore);return function(s,a,u,c,d,f,g){let _;if(d.isKeyField()){if(f==="array-contains"||f==="array-contains-any")throw new D(P.INVALID_ARGUMENT,`Invalid Query. You can't perform '${f}' queries on documentId().`);if(f==="in"||f==="not-in"){Vf(g,f);let A=[];for(let V of g)A.push(Df(c,s,V));_={arrayValue:{values:A}}}else _=Df(c,s,g)}else f!=="in"&&f!=="not-in"&&f!=="array-contains-any"||Vf(g,f),_=Eg(u,a,g,f==="in"||f==="not-in");return H.create(d,f,_)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}};function Pg(r,t,e){let n=t,i=Lo("where",r);return bo._create(i,n,e)}var Wc=class r extends Mi{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new r(t,e)}_parse(t){let e=this._queryConstraints.map(n=>n._parse(t)).filter(n=>n.getFilters().length>0);return e.length===1?e[0]:et.create(e,this._getOperator())}_apply(t){let e=this._parse(t);return e.getFilters().length===0?t:(function(i,s){let a=i,u=s.getFlattenedFilters();for(let c of u)Mg(a,c),a=Au(a,c)}(t._query,e),new At(t.firestore,t.converter,Au(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}};var Hc=class r extends Rn{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new r(t,e)}_apply(t){let e=function(i,s,a){if(i.startAt!==null)throw new D(P.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(i.endAt!==null)throw new D(P.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new wn(s,a)}(t._query,this._field,this._direction);return new At(t.firestore,t.converter,function(i,s){let a=i.explicitOrderBy.concat([s]);return new Yt(i.path,i.collectionGroup,a,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(t._query,e))}};function Cg(r,t="asc"){let e=t,n=Lo("orderBy",r);return Hc._create(n,e)}var Ro=class r extends Rn{constructor(t,e,n){super(),this.type=t,this._limit=e,this._limitType=n}static _create(t,e,n){return new r(t,e,n)}_apply(t){return new At(t.firestore,t.converter,Gs(t._query,this._limit,this._limitType))}};function xg(r){return ag("limit",r),Ro._create("limit",r,"F")}function Dg(r){return ag("limitToLast",r),Ro._create("limitToLast",r,"L")}var Po=class r extends Rn{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new r(t,e,n)}_apply(t){let e=Og(t,this.type,this._docOrFields,this._inclusive);return new At(t.firestore,t.converter,function(i,s){return new Yt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)}(t._query,e))}};function Vg(...r){return Po._create("startAt",r,!0)}function kg(...r){return Po._create("startAfter",r,!1)}var Co=class r extends Rn{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new r(t,e,n)}_apply(t){let e=Og(t,this.type,this._docOrFields,this._inclusive);return new At(t.firestore,t.converter,function(i,s){return new Yt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)}(t._query,e))}};function Ng(...r){return Co._create("endBefore",r,!1)}function Fg(...r){return Co._create("endAt",r,!0)}function Og(r,t,e,n){if(e[0]=ut(e[0]),e[0]instanceof bn)return function(s,a,u,c,d){if(!c)throw new D(P.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${u}().`);let f=[];for(let g of ir(s))if(g.field.isKeyField())f.push(yn(a,c.key));else{let _=c.data.field(g.field);if(Do(_))throw new D(P.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+g.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(_===null){let A=g.field.canonicalString();throw new D(P.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${A}' (used as the orderBy) does not exist.`)}f.push(_)}return new ue(f,d)}(r._query,r.firestore._databaseId,t,e[0]._document,n);{let i=Cn(r.firestore);return function(a,u,c,d,f,g){let _=a.explicitOrderBy;if(f.length>_.length)throw new D(P.INVALID_ARGUMENT,`Too many arguments provided to ${d}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let A=[];for(let V=0;V<f.length;V++){let N=f[V];if(_[V].field.isKeyField()){if(typeof N!="string")throw new D(P.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${d}(), but got a ${typeof N}`);if(!il(a)&&N.indexOf("/")!==-1)throw new D(P.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${d}() must be a plain document ID, but '${N}' contains a slash.`);let x=a.path.child(X.fromString(N));if(!L.isDocumentKey(x))throw new D(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${d}() must result in a valid document path, but '${x}' is not because it contains an odd number of segments.`);let j=new L(x);A.push(yn(u,j))}else{let x=Eg(c,d,N);A.push(x)}}return new ue(A,g)}(r._query,r.firestore._databaseId,i,t,e,n)}}function Df(r,t,e){if(typeof(e=ut(e))=="string"){if(e==="")throw new D(P.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!il(t)&&e.indexOf("/")!==-1)throw new D(P.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);let n=t.path.child(X.fromString(e));if(!L.isDocumentKey(n))throw new D(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${n}' is not because it has an odd number of segments (${n.length}).`);return yn(r,new L(n))}if(e instanceof it)return yn(r,e._key);throw new D(P.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Oo(e)}.`)}function Vf(r,t){if(!Array.isArray(r)||r.length===0)throw new D(P.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Mg(r,t){let e=function(i,s){for(let a of i)for(let u of a.getFlattenedFilters())if(s.indexOf(u.op)>=0)return u.op;return null}(r.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new D(P.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new D(P.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}var Ir=class{convertValue(t,e="none"){switch(_n(t)){case 0:return null;case 1:return t.booleanValue;case 2:return at(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(ze(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 11:return this.convertObject(t.mapValue,e);case 10:return this.convertVectorValue(t.mapValue);default:throw q()}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){let n={};return Pn(t,(i,s)=>{n[i]=this.convertValue(s,e)}),n}convertVectorValue(t){var e,n,i;let s=(i=(n=(e=t.fields)===null||e===void 0?void 0:e.value.arrayValue)===null||n===void 0?void 0:n.values)===null||i===void 0?void 0:i.map(a=>at(a.doubleValue));return new Fi(s)}convertGeoPoint(t){return new Sn(at(t.latitude),at(t.longitude))}convertArray(t,e){return(t.values||[]).map(n=>this.convertValue(n,e))}convertServerTimestamp(t,e){switch(e){case"previous":let n=nl(t);return n==null?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(vi(t));default:return null}}convertTimestamp(t){let e=ye(t);return new ct(e.seconds,e.nanos)}convertDocumentKey(t,e){let n=X.fromString(t);U(xm(n));let i=new Ge(n.get(1),n.get(3)),s=new L(n.popFirst(5));return i.isEqual(e)||ft(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}};function qo(r,t,e){let n;return n=r?e&&(e.merge||e.mergeFields)?r.toFirestore(t,e):r.toFirestore(t):t,n}var Jc=class extends Ir{constructor(t){super(),this.firestore=t}convertBytes(t){return new le(t)}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return new it(this.firestore,null,e)}};var _e=class{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}},Qt=class extends bn{constructor(t,e,n,i,s,a){super(t,e,n,i,a),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){let e=new Ue(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){let n=this._document.data.field(Lo("DocumentSnapshot.get",t));if(n!==null)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}},Ue=class extends Qt{data(t={}){return super.data(t)}},te=class{constructor(t,e,n,i){this._firestore=t,this._userDataWriter=e,this._snapshot=i,this.metadata=new _e(i.hasPendingWrites,i.fromCache),this.query=n}get docs(){let t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(n=>{t.call(e,new Ue(this._firestore,this._userDataWriter,n.key,n,new _e(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){let e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new D(P.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let a=0;return i._snapshot.docChanges.map(u=>{let c=new Ue(i._firestore,i._userDataWriter,u.doc.key,u.doc,new _e(i._snapshot.mutatedKeys.has(u.doc.key),i._snapshot.fromCache),i.query.converter);return u.doc,{type:"added",doc:c,oldIndex:-1,newIndex:a++}})}{let a=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(u=>s||u.type!==3).map(u=>{let c=new Ue(i._firestore,i._userDataWriter,u.doc.key,u.doc,new _e(i._snapshot.mutatedKeys.has(u.doc.key),i._snapshot.fromCache),i.query.converter),d=-1,f=-1;return u.type!==0&&(d=a.indexOf(u.doc.key),a=a.delete(u.doc.key)),u.type!==1&&(a=a.add(u.doc),f=a.indexOf(u.doc.key)),{type:Sw(u.type),doc:c,oldIndex:d,newIndex:f}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}};function Sw(r){switch(r){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return q()}}function Fl(r,t){return r instanceof Qt&&t instanceof Qt?r._firestore===t._firestore&&r._key.isEqual(t._key)&&(r._document===null?t._document===null:r._document.isEqual(t._document))&&r._converter===t._converter:r instanceof te&&t instanceof te&&r._firestore===t._firestore&&xl(r.query,t.query)&&r.metadata.isEqual(t.metadata)&&r._snapshot.isEqual(t._snapshot)}function Lg(r){r=Z(r,it);let t=Z(r.firestore,lt);return ig(St(t),r._key).then(e=>ql(t,r,e))}var Ie=class extends Ir{constructor(t){super(),this.firestore=t}convertBytes(t){return new le(t)}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return new it(this.firestore,null,e)}};function qg(r){r=Z(r,it);let t=Z(r.firestore,lt),e=St(t),n=new Ie(t);return yw(e,r._key).then(i=>new Qt(t,n,r._key,i,new _e(i!==null&&i.hasLocalMutations,!0),r.converter))}function Ug(r){r=Z(r,it);let t=Z(r.firestore,lt);return ig(St(t),r._key,{source:"server"}).then(e=>ql(t,r,e))}function Bg(r){r=Z(r,At);let t=Z(r.firestore,lt),e=St(t),n=new Ie(t);return Rg(r._query),sg(e,r._query).then(i=>new te(t,n,r,i))}function jg(r){r=Z(r,At);let t=Z(r.firestore,lt),e=St(t),n=new Ie(t);return ww(e,r._query).then(i=>new te(t,n,r,i))}function zg(r){r=Z(r,At);let t=Z(r.firestore,lt),e=St(t),n=new Ie(t);return sg(e,r._query,{source:"server"}).then(i=>new te(t,n,r,i))}function Ol(r,t,e){r=Z(r,it);let n=Z(r.firestore,lt),i=qo(r.converter,t,e);return Cr(n,[Mo(Cn(n),"setDoc",r._key,i,r.converter!==null,e).toMutation(r._key,dt.none())])}function Ml(r,t,e,...n){r=Z(r,it);let i=Z(r.firestore,lt),s=Cn(i),a;return a=typeof(t=ut(t))=="string"||t instanceof Zt?Vl(s,"updateDoc",r._key,t,e,n):Dl(s,"updateDoc",r._key,t),Cr(i,[a.toMutation(r._key,dt.exists(!0))])}function Gg(r){return Cr(Z(r.firestore,lt),[new He(r._key,dt.none())])}function Kg(r,t){let e=Z(r.firestore,lt),n=Gi(r),i=qo(r.converter,t);return Cr(e,[Mo(Cn(r.firestore),"addDoc",n._key,i,r.converter!==null,{}).toMutation(n._key,dt.exists(!1))]).then(()=>n)}function Ll(r,...t){var e,n,i;r=ut(r);let s={includeMetadataChanges:!1,source:"default"},a=0;typeof t[a]!="object"||Lc(t[a])||(s=t[a],a++);let u={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(Lc(t[a])){let g=t[a];t[a]=(e=g.next)===null||e===void 0?void 0:e.bind(g),t[a+1]=(n=g.error)===null||n===void 0?void 0:n.bind(g),t[a+2]=(i=g.complete)===null||i===void 0?void 0:i.bind(g)}let c,d,f;if(r instanceof it)d=Z(r.firestore,lt),f=Ar(r._key.path),c={next:g=>{t[a]&&t[a](ql(d,r,g))},error:t[a+1],complete:t[a+2]};else{let g=Z(r,At);d=Z(g.firestore,lt),f=g._query;let _=new Ie(d);c={next:A=>{t[a]&&t[a](new te(d,_,g,A))},error:t[a+1],complete:t[a+2]},Rg(r._query)}return function(_,A,V,N){let x=new vr(N),j=new Ni(A,x,V);return _.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return ml(yield Tr(_),j)})),()=>{x.Za(),_.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return gl(yield Tr(_),j)}))}}(St(d),f,u,c)}function $g(r,t){return vw(St(r=Z(r,lt)),Lc(t)?t:{next:t})}function Cr(r,t){return function(n,i){let s=new Tt;return n.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return Zy(yield Sl(n),i,s)})),s.promise}(St(r),t)}function ql(r,t,e){let n=e.docs.get(t._key),i=new Ie(r);return new Qt(r,i,t._key,n,new _e(e.hasPendingWrites,e.fromCache),t.converter)}var bw={maxAttempts:5};var xo=class{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Cn(t)}set(t,e,n){this._verifyNotCommitted();let i=Le(t,this._firestore),s=qo(i.converter,e,n),a=Mo(this._dataReader,"WriteBatch.set",i._key,s,i.converter!==null,n);return this._mutations.push(a.toMutation(i._key,dt.none())),this}update(t,e,n,...i){this._verifyNotCommitted();let s=Le(t,this._firestore),a;return a=typeof(e=ut(e))=="string"||e instanceof Zt?Vl(this._dataReader,"WriteBatch.update",s._key,e,n,i):Dl(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(a.toMutation(s._key,dt.exists(!0))),this}delete(t){this._verifyNotCommitted();let e=Le(t,this._firestore);return this._mutations=this._mutations.concat(new He(e._key,dt.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new D(P.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}};function Le(r,t){if((r=ut(r)).firestore!==t)throw new D(P.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return r}var Yc=class extends class{constructor(e,n){this._firestore=e,this._transaction=n,this._dataReader=Cn(e)}get(e){let n=Le(e,this._firestore),i=new Jc(this._firestore);return this._transaction.lookup([n._key]).then(s=>{if(!s||s.length!==1)return q();let a=s[0];if(a.isFoundDocument())return new bn(this._firestore,i,a.key,a,n.converter);if(a.isNoDocument())return new bn(this._firestore,i,n._key,null,n.converter);throw q()})}set(e,n,i){let s=Le(e,this._firestore),a=qo(s.converter,n,i),u=Mo(this._dataReader,"Transaction.set",s._key,a,s.converter!==null,i);return this._transaction.set(s._key,u),this}update(e,n,i,...s){let a=Le(e,this._firestore),u;return u=typeof(n=ut(n))=="string"||n instanceof Zt?Vl(this._dataReader,"Transaction.update",a._key,n,i,s):Dl(this._dataReader,"Transaction.update",a._key,n),this._transaction.update(a._key,u),this}delete(e){let n=Le(e,this._firestore);return this._transaction.delete(n._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){let e=Le(t,this._firestore),n=new Ie(this._firestore);return super.get(t).then(i=>new Qt(this._firestore,n,e._key,i._document,new _e(!1,!1),e.converter))}};function Qg(r,t,e){r=Z(r,lt);let n=Object.assign(Object.assign({},bw),e);return function(s){if(s.maxAttempts<1)throw new D(P.INVALID_ARGUMENT,"Max attempts must be at least 1")}(n),function(s,a,u){let c=new Tt;return s.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){let d=yield gw(s);new Oc(s.asyncQueue,d,u,a,c).au()})),c.promise}(St(r),i=>t(new Yc(r,i)),n)}function Wg(){return new Oi("deleteField")}function Hg(){return new jc("serverTimestamp")}function Jg(...r){return new zc("arrayUnion",r)}function Yg(...r){return new Gc("arrayRemove",r)}function Xg(r){return new Kc("increment",r)}(function(t,e=!0){(function(i){Er=i})(cd),ni(new an("firestore",(n,{instanceIdentifier:i,options:s})=>{let a=n.getProvider("app").getImmediate(),u=new lt(new eu(n.getProvider("auth-internal")),new su(n.getProvider("app-check-internal")),function(d,f){if(!Object.prototype.hasOwnProperty.apply(d.options,["projectId"]))throw new D(P.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Ge(d.options.projectId,f)}(a,i),a);return s=Object.assign({useFetchStreams:e},s),u._setSettings(s),u},"PUBLIC").setMultipleInstances(!0)),Ve(Cd,"4.7.3",t),Ve(Cd,"4.7.3","esm2017")})();var Rw="@firebase/firestore-compat",Pw="0.3.38";function Kl(r,t){if(t===void 0)return{merge:!1};if(t.mergeFields!==void 0&&t.merge!==void 0)throw new D("invalid-argument",`Invalid options passed to function ${r}(): You cannot specify both "merge" and "mergeFields".`);return t}function Zg(){if(typeof Uint8Array>"u")throw new D("unimplemented","Uint8Arrays are not available in this environment.")}function tp(){if(!$f())throw new D("unimplemented","Blobs are unavailable in Firestore in this environment.")}var Uo=class r{constructor(t){this._delegate=t}static fromBase64String(t){return tp(),new r(le.fromBase64String(t))}static fromUint8Array(t){return Zg(),new r(le.fromUint8Array(t))}toBase64(){return tp(),this._delegate.toBase64()}toUint8Array(){return Zg(),this._delegate.toUint8Array()}isEqual(t){return this._delegate.isEqual(t._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}};function Ul(r){return Cw(r,["next","error","complete"])}function Cw(r,t){if(typeof r!="object"||r===null)return!1;let e=r;for(let n of t)if(n in e&&typeof e[n]=="function")return!0;return!1}var Bl=class{enableIndexedDbPersistence(t,e){return dg(t._delegate,{forceOwnership:e})}enableMultiTabIndexedDbPersistence(t){return fg(t._delegate)}clearIndexedDbPersistence(t){return gg(t._delegate)}},Bo=class{constructor(t,e,n){this._delegate=e,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},t instanceof Ge||(this._appCompat=t)}get _databaseId(){return this._delegate._databaseId}settings(t){let e=this._delegate._getSettings();!t.merge&&e.host!==t.host&&Jt("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),t.merge&&(t=Object.assign(Object.assign({},e),t),delete t.merge),this._delegate._setSettings(t)}useEmulator(t,e,n={}){ug(this._delegate,t,e,n)}enableNetwork(){return _g(this._delegate)}disableNetwork(){return yg(this._delegate)}enablePersistence(t){let e=!1,n=!1;return t&&(e=!!t.synchronizeTabs,n=!!t.experimentalForceOwningTab,Rl("synchronizeTabs",e,"experimentalForceOwningTab",n)),e?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return pg(this._delegate)}onSnapshotsInSync(t){return $g(this._delegate,t)}get app(){if(!this._appCompat)throw new D("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(t){try{return new Vr(this,Pl(this._delegate,t))}catch(e){throw Lt(e,"collection()","Firestore.collection()")}}doc(t){try{return new he(this,Gi(this._delegate,t))}catch(e){throw Lt(e,"doc()","Firestore.doc()")}}collectionGroup(t){try{return new Nn(this,cg(this._delegate,t))}catch(e){throw Lt(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Qg(this._delegate,e=>t(new jo(this,e)))}batch(){return St(this._delegate),new zo(new xo(this._delegate,t=>Cr(this._delegate,t)))}loadBundle(t){return wg(this._delegate,t)}namedQuery(t){return vg(this._delegate,t).then(e=>e?new Nn(this,e):null)}},xr=class extends Ir{constructor(t){super(),this.firestore=t}convertBytes(t){return new Uo(new le(t))}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return he.forKey(e,this.firestore,null)}};function xw(r){kf(r)}var jo=class{constructor(t,e){this._firestore=t,this._delegate=e,this._userDataWriter=new xr(t)}get(t){let e=Dn(t);return this._delegate.get(e).then(n=>new Vn(this._firestore,new Qt(this._firestore._delegate,this._userDataWriter,n._key,n._document,n.metadata,e.converter)))}set(t,e,n){let i=Dn(t);return n?(Kl("Transaction.set",n),this._delegate.set(i,e,n)):this._delegate.set(i,e),this}update(t,e,n,...i){let s=Dn(t);return arguments.length===2?this._delegate.update(s,e):this._delegate.update(s,e,n,...i),this}delete(t){let e=Dn(t);return this._delegate.delete(e),this}},zo=class{constructor(t){this._delegate=t}set(t,e,n){let i=Dn(t);return n?(Kl("WriteBatch.set",n),this._delegate.set(i,e,n)):this._delegate.set(i,e),this}update(t,e,n,...i){let s=Dn(t);return arguments.length===2?this._delegate.update(s,e):this._delegate.update(s,e,n,...i),this}delete(t){let e=Dn(t);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}},Dr=class r{constructor(t,e,n){this._firestore=t,this._userDataWriter=e,this._delegate=n}fromFirestore(t,e){let n=new Ue(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,null);return this._delegate.fromFirestore(new kn(this._firestore,n),e??{})}toFirestore(t,e){return e?this._delegate.toFirestore(t,e):this._delegate.toFirestore(t)}static getInstance(t,e){let n=r.INSTANCES,i=n.get(t);i||(i=new WeakMap,n.set(t,i));let s=i.get(e);return s||(s=new r(t,new xr(t),e),i.set(e,s)),s}};Dr.INSTANCES=new WeakMap;var he=class r{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new xr(t)}static forPath(t,e,n){if(t.length%2!==0)throw new D("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${t.canonicalString()} has ${t.length}`);return new r(e,new it(e._delegate,n,new L(t)))}static forKey(t,e,n){return new r(e,new it(e._delegate,n,t))}get id(){return this._delegate.id}get parent(){return new Vr(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(t){try{return new Vr(this.firestore,Pl(this._delegate,t))}catch(e){throw Lt(e,"collection()","DocumentReference.collection()")}}isEqual(t){return t=ut(t),t instanceof it?Cl(this._delegate,t):!1}set(t,e){e=Kl("DocumentReference.set",e);try{return e?Ol(this._delegate,t,e):Ol(this._delegate,t)}catch(n){throw Lt(n,"setDoc()","DocumentReference.set()")}}update(t,e,...n){try{return arguments.length===1?Ml(this._delegate,t):Ml(this._delegate,t,e,...n)}catch(i){throw Lt(i,"updateDoc()","DocumentReference.update()")}}delete(){return Gg(this._delegate)}onSnapshot(...t){let e=ep(t),n=np(t,i=>new Vn(this.firestore,new Qt(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return Ll(this._delegate,e,n)}get(t){let e;return t?.source==="cache"?e=qg(this._delegate):t?.source==="server"?e=Ug(this._delegate):e=Lg(this._delegate),e.then(n=>new Vn(this.firestore,new Qt(this.firestore._delegate,this._userDataWriter,n._key,n._document,n.metadata,this._delegate.converter)))}withConverter(t){return new r(this.firestore,t?this._delegate.withConverter(Dr.getInstance(this.firestore,t)):this._delegate.withConverter(null))}};function Lt(r,t,e){return r.message=r.message.replace(t,e),r}function ep(r){for(let t of r)if(typeof t=="object"&&!Ul(t))return t;return{}}function np(r,t){var e,n;let i;return Ul(r[0])?i=r[0]:Ul(r[1])?i=r[1]:typeof r[0]=="function"?i={next:r[0],error:r[1],complete:r[2]}:i={next:r[1],error:r[2],complete:r[3]},{next:s=>{i.next&&i.next(t(s))},error:(e=i.error)===null||e===void 0?void 0:e.bind(i),complete:(n=i.complete)===null||n===void 0?void 0:n.bind(i)}}var Vn=class{constructor(t,e){this._firestore=t,this._delegate=e}get ref(){return new he(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(t){return this._delegate.data(t)}get(t,e){return this._delegate.get(t,e)}isEqual(t){return Fl(this._delegate,t._delegate)}},kn=class extends Vn{data(t){let e=this._delegate.data(t);return this._delegate._converter||Nf(e!==void 0,"Document in a QueryDocumentSnapshot should exist"),e}},Nn=class r{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new xr(t)}where(t,e,n){try{return new r(this.firestore,Ae(this._delegate,Pg(t,e,n)))}catch(i){throw Lt(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(t,e){try{return new r(this.firestore,Ae(this._delegate,Cg(t,e)))}catch(n){throw Lt(n,/(orderBy|where)\(\)/,"Query.$1()")}}limit(t){try{return new r(this.firestore,Ae(this._delegate,xg(t)))}catch(e){throw Lt(e,"limit()","Query.limit()")}}limitToLast(t){try{return new r(this.firestore,Ae(this._delegate,Dg(t)))}catch(e){throw Lt(e,"limitToLast()","Query.limitToLast()")}}startAt(...t){try{return new r(this.firestore,Ae(this._delegate,Vg(...t)))}catch(e){throw Lt(e,"startAt()","Query.startAt()")}}startAfter(...t){try{return new r(this.firestore,Ae(this._delegate,kg(...t)))}catch(e){throw Lt(e,"startAfter()","Query.startAfter()")}}endBefore(...t){try{return new r(this.firestore,Ae(this._delegate,Ng(...t)))}catch(e){throw Lt(e,"endBefore()","Query.endBefore()")}}endAt(...t){try{return new r(this.firestore,Ae(this._delegate,Fg(...t)))}catch(e){throw Lt(e,"endAt()","Query.endAt()")}}isEqual(t){return xl(this._delegate,t._delegate)}get(t){let e;return t?.source==="cache"?e=jg(this._delegate):t?.source==="server"?e=zg(this._delegate):e=Bg(this._delegate),e.then(n=>new Ki(this.firestore,new te(this.firestore._delegate,this._userDataWriter,this._delegate,n._snapshot)))}onSnapshot(...t){let e=ep(t),n=np(t,i=>new Ki(this.firestore,new te(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return Ll(this._delegate,e,n)}withConverter(t){return new r(this.firestore,t?this._delegate.withConverter(Dr.getInstance(this.firestore,t)):this._delegate.withConverter(null))}},jl=class{constructor(t,e){this._firestore=t,this._delegate=e}get type(){return this._delegate.type}get doc(){return new kn(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}},Ki=class{constructor(t,e){this._firestore=t,this._delegate=e}get query(){return new Nn(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(t=>new kn(this._firestore,t))}docChanges(t){return this._delegate.docChanges(t).map(e=>new jl(this._firestore,e))}forEach(t,e){this._delegate.forEach(n=>{t.call(e,new kn(this._firestore,n))})}isEqual(t){return Fl(this._delegate,t._delegate)}},Vr=class r extends Nn{constructor(t,e){super(t,e),this.firestore=t,this._delegate=e}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){let t=this._delegate.parent;return t?new he(this.firestore,t):null}doc(t){try{return t===void 0?new he(this.firestore,Gi(this._delegate)):new he(this.firestore,Gi(this._delegate,t))}catch(e){throw Lt(e,"doc()","CollectionReference.doc()")}}add(t){return Kg(this._delegate,t).then(e=>new he(this.firestore,e))}isEqual(t){return Cl(this._delegate,t._delegate)}withConverter(t){return new r(this.firestore,t?this._delegate.withConverter(Dr.getInstance(this.firestore,t)):this._delegate.withConverter(null))}};function Dn(r){return Z(r,it)}var zl=class r{constructor(...t){this._delegate=new Zt(...t)}static documentId(){return new r(mt.keyField().canonicalString())}isEqual(t){return t=ut(t),t instanceof Zt?this._delegate._internalPath.isEqual(t._internalPath):!1}};var Gl=class r{constructor(t){this._delegate=t}static serverTimestamp(){let t=Hg();return t._methodName="FieldValue.serverTimestamp",new r(t)}static delete(){let t=Wg();return t._methodName="FieldValue.delete",new r(t)}static arrayUnion(...t){let e=Jg(...t);return e._methodName="FieldValue.arrayUnion",new r(e)}static arrayRemove(...t){let e=Yg(...t);return e._methodName="FieldValue.arrayRemove",new r(e)}static increment(t){let e=Xg(t);return e._methodName="FieldValue.increment",new r(e)}isEqual(t){return this._delegate.isEqual(t._delegate)}};var Dw={Firestore:Bo,GeoPoint:Sn,Timestamp:ct,Blob:Uo,Transaction:jo,WriteBatch:zo,DocumentReference:he,DocumentSnapshot:Vn,Query:Nn,QueryDocumentSnapshot:kn,QuerySnapshot:Ki,CollectionReference:Vr,FieldPath:zl,FieldValue:Gl,setLogLevel:xw,CACHE_SIZE_UNLIMITED:lg};function Vw(r,t){r.INTERNAL.registerComponent(new an("firestore-compat",e=>{let n=e.getProvider("app-compat").getImmediate(),i=e.getProvider("firestore").getImmediate();return t(n,i)},"PUBLIC").setServiceProps(Object.assign({},Dw)))}function kw(r){Vw(r,(t,e)=>new Bo(t,e,new Bl)),r.registerVersion(Rw,Pw)}kw(qt);function Nw(r,t=ls){return new qn(e=>{let n;return t!=null?t.schedule(()=>{n=r.onSnapshot({includeMetadataChanges:!0},e)}):n=r.onSnapshot({includeMetadataChanges:!0},e),()=>{n?.()}})}function rp(r,t){return Nw(r,t)}function Fw(r,t){return rp(r,t).pipe(fs(void 0),hs(),Nt(e=>{let[n,i]=e;return i.exists?n?.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}function Wl(r,t){return rp(r,t).pipe(Nt(e=>({payload:e,type:"query"})))}var Go=class{ref;afs;constructor(t,e){this.ref=t,this.afs=e}set(t,e){return this.ref.set(t,e)}update(t){return this.ref.update(t)}delete(){return this.ref.delete()}collection(t,e){let n=this.ref.collection(t),{ref:i,query:s}=up(n,e);return new $o(i,s,this.afs)}snapshotChanges(){return Fw(this.ref,this.afs.schedulers.outsideAngular).pipe(Ut)}valueChanges(t={}){return this.snapshotChanges().pipe(Nt(({payload:e})=>t.idField?ya(cs({},e.data()),{[t.idField]:e.id}):e.data()))}get(t){return Ce(this.ref.get(t)).pipe(Ut)}};function Ko(r,t){return Wl(r,t).pipe(fs(void 0),hs(),Nt(e=>{let[n,i]=e,s=i.payload.docChanges(),a=s.map(u=>({type:u.type,payload:u}));return n&&JSON.stringify(n.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((u,c)=>{let d=s.find(g=>g.doc.ref.isEqual(u.ref)),f=n?.payload.docs.find(g=>g.ref.isEqual(u.ref));d&&JSON.stringify(d.doc.metadata)===JSON.stringify(u.metadata)||!d&&f&&JSON.stringify(f.metadata)===JSON.stringify(u.metadata)||a.push({type:"modified",payload:{oldIndex:c,newIndex:c,type:"modified",doc:u}})}),a}))}function ip(r,t,e){return Ko(r,e).pipe(ds((n,i)=>Ow(n,i.map(s=>s.payload),t),[]),Zh(),Nt(n=>n.map(i=>({type:i.type,payload:i}))))}function Ow(r,t,e){return t.forEach(n=>{e.indexOf(n.type)>-1&&(r=Mw(r,n))}),r}function $l(r,t,e,...n){let i=r.slice();return i.splice(t,e,...n),i}function Mw(r,t){switch(t.type){case"added":if(!(r[t.newIndex]&&r[t.newIndex].doc.ref.isEqual(t.doc.ref)))return $l(r,t.newIndex,0,t);break;case"modified":if(r[t.oldIndex]==null||r[t.oldIndex].doc.ref.isEqual(t.doc.ref))if(t.oldIndex!==t.newIndex){let e=r.slice();return e.splice(t.oldIndex,1),e.splice(t.newIndex,0,t),e}else return $l(r,t.newIndex,1,t);break;case"removed":if(r[t.oldIndex]&&r[t.oldIndex].doc.ref.isEqual(t.doc.ref))return $l(r,t.oldIndex,1);break}return r}function sp(r){return(!r||r.length===0)&&(r=["added","removed","modified"]),r}var $o=class{ref;query;afs;constructor(t,e,n){this.ref=t,this.query=e,this.afs=n}stateChanges(t){let e=Ko(this.query,this.afs.schedulers.outsideAngular);return t&&t.length>0&&(e=e.pipe(Nt(n=>n.filter(i=>t.indexOf(i.type)>-1)))),e.pipe(fs(void 0),hs(),Xr(([n,i])=>i.length>0||!n),Nt(([,n])=>n),Ut)}auditTrail(t){return this.stateChanges(t).pipe(ds((e,n)=>[...e,...n],[]))}snapshotChanges(t){let e=sp(t);return ip(this.query,e,this.afs.schedulers.outsideAngular).pipe(Ut)}valueChanges(t={}){return Wl(this.query,this.afs.schedulers.outsideAngular).pipe(Nt(e=>e.payload.docs.map(n=>t.idField?ya(cs({},n.data()),{[t.idField]:n.id}):n.data())),Ut)}get(t){return Ce(this.query.get(t)).pipe(Ut)}add(t){return this.ref.add(t)}doc(t){return new Go(this.ref.doc(t),this.afs)}},Ql=class{query;afs;constructor(t,e){this.query=t,this.afs=e}stateChanges(t){return!t||t.length===0?Ko(this.query,this.afs.schedulers.outsideAngular).pipe(Ut):Ko(this.query,this.afs.schedulers.outsideAngular).pipe(Nt(e=>e.filter(n=>t.indexOf(n.type)>-1)),Xr(e=>e.length>0),Ut)}auditTrail(t){return this.stateChanges(t).pipe(ds((e,n)=>[...e,...n],[]))}snapshotChanges(t){let e=sp(t);return ip(this.query,e,this.afs.schedulers.outsideAngular).pipe(Ut)}valueChanges(t={}){return Wl(this.query,this.afs.schedulers.outsideAngular).pipe(Nt(n=>n.payload.docs.map(i=>t.idField?cs({[t.idField]:i.id},i.data()):i.data())),Ut)}get(t){return Ce(this.query.get(t)).pipe(Ut)}},op=new Ft("angularfire2.enableFirestorePersistence"),ap=new Ft("angularfire2.firestore.persistenceSettings"),Lw=new Ft("angularfire2.firestore.settings"),qw=new Ft("angularfire2.firestore.use-emulator");function up(r,t=e=>e){return{query:t(r),ref:r}}var Uw=(()=>{class r{schedulers;firestore;persistenceEnabled$;constructor(e,n,i,s,a,u,c,d,f,g,_,A,V,N,x,j,z){this.schedulers=c;let O=ri(e,u,n),G=f;g&&Ba(O,u,_,V,N,x,A,j),[this.firestore,this.persistenceEnabled$]=vs(`${O.name}.firestore`,"AngularFirestore",O.name,()=>{let $=u.runOutsideAngular(()=>O.firestore());if(s&&$.settings(s),G&&$.useEmulator(...G),i&&!ms(a)){let Q=()=>{try{return Ce($.enablePersistence(d||void 0).then(()=>!0,()=>!1))}catch(v){return typeof console<"u"&&console.warn(v),xe(!1)}};return[$,u.runOutsideAngular(Q)]}else return[$,xe(!1)]},[s,G,i])}collection(e,n){let i;typeof e=="string"?i=this.firestore.collection(e):i=e;let{ref:s,query:a}=up(i,n),u=this.schedulers.ngZone.run(()=>s);return new $o(u,a,this)}collectionGroup(e,n){let i=n||(a=>a),s=this.firestore.collectionGroup(e);return new Ql(i(s),this)}doc(e){let n;typeof e=="string"?n=this.firestore.doc(e):n=e;let i=this.schedulers.ngZone.run(()=>n);return new Go(i,this)}createId(){return this.firestore.collection("_").doc().id}static \u0275fac=function(n){return new(n||r)(J(Gn),J(Kn,8),J(op,8),J(Lw,8),J(jn),J(De),J(ys),J(ap,8),J(qw,8),J(bd,8),J(Fa,8),J(Oa,8),J(Ma,8),J(La,8),J(qa,8),J(Ua,8),J(un,8))};static \u0275prov=Bn({token:r,factory:r.\u0275fac,providedIn:"any"})}return r})(),ST=(()=>{class r{constructor(){qt.registerVersion("angularfire",zn.full,"fst-compat")}static enablePersistence(e){return{ngModule:r,providers:[{provide:op,useValue:!0},{provide:ap,useValue:e}]}}static \u0275fac=function(n){return new(n||r)};static \u0275mod=ti({type:r});static \u0275inj=Zr({providers:[Uw]})}return r})();export{rv as a,Uw as b,ST as c};
